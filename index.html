<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="å·¥ç¨‹ç‰©æ–™åº«å­˜ç®¡ç†ç³»çµ± - å³æ™‚ç›¤é»ã€è¿½è¹¤ã€çµ±è¨ˆ">
    <meta name="keywords" content="ç‰©æ–™ç®¡ç†,åº«å­˜ç³»çµ±,ç›¤é»,å·¥ç¨‹ç®¡ç†">
    <title>ç‰©æ–™æˆ°æƒ…å®¤ v19.0 - å·¥ç¨‹ç‰©æ–™åº«å­˜ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: { 
                extend: { 
                    colors: { 
                        dark: {
                            100: '#1a1a1a',
                            200: '#151515',
                            300: '#101010',
                            400: '#0a0a0a',
                            500: '#000000'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1)',
                        'scale-in': 'scaleIn 0.2s ease-out'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' }
                        },
                        scaleIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' }
                        }
                    }
                } 
            } 
        }
    </script>
    <style>
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            margin: 0;
            padding: 0;
        }
        
        html, body {
            height: 100%;
            overflow-x: hidden;
        }
        
        body { 
            background: #000000;
            color: #ffffff; 
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.6;
            /* WCAG AA å°æ¯”åº¦å„ªåŒ– */
            color: #f5f5f5; /* æå‡å°æ¯”åº¦ */
        }
        
        /* ç¢ºä¿æœ€å°è§¸æ‘¸ç›®æ¨™ 44x44px (WCAG 2.5.5) */
        button, a, [role="button"], .clickable {
            min-width: 44px;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        /* éµç›¤å°èˆªå„ªåŒ– (WCAG 2.1.1) */
        *:focus-visible {
            outline: 3px solid #8b5cf6;
            outline-offset: 2px;
            border-radius: 4px;
        }
        
        /* æ¸›å°‘å‹•ç•« (WCAG 2.3.3) */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* å„ªé›…çš„æ²è»¸ */
        ::-webkit-scrollbar {
            width: 6px;
            background: transparent;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 999px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 999px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* éš±è—æ©«å‘æ²è»¸ */
        .scrollbar-hide::-webkit-scrollbar {
            width: 0px;
            height: 0px;
            display: none;
        }
        
        /* æ¯›ç»ç’ƒæ•ˆæœ - æ¥µè‡´å„ªåŒ–ç‰ˆ */
        .glass {
            background: linear-gradient(135deg, rgba(20, 20, 20, 0.7), rgba(26, 26, 26, 0.6));
            backdrop-filter: blur(28px) saturate(200%);
            -webkit-backdrop-filter: blur(28px) saturate(200%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 
                0 8px 32px 0 rgba(0, 0, 0, 0.6),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.05);
        }
        
        .glass-strong {
            background: linear-gradient(135deg, rgba(15, 15, 15, 0.9), rgba(20, 20, 20, 0.85));
            backdrop-filter: blur(40px) saturate(200%);
            -webkit-backdrop-filter: blur(40px) saturate(200%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 
                0 16px 64px 0 rgba(0, 0, 0, 0.8),
                inset 0 1px 0 0 rgba(255, 255, 255, 0.08);
        }
        
        /* å¡ç‰‡å…‰æšˆæ•ˆæœ */
        .glass::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            padding: 1px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), transparent 50%);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        .glass:hover::before {
            opacity: 1;
        }
        
        /* åº«å­˜é€²åº¦æ¢ - é‡æ–°è¨­è¨ˆ */
        .stock-bar { 
            height: 6px; 
            border-radius: 999px; 
            background: rgba(255, 255, 255, 0.05); 
            margin-top: 10px; 
            overflow: hidden;
            position: relative;
        }
        
        .stock-bar-fill { 
            height: 100%; 
            border-radius: 999px; 
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1),
                        background 0.3s ease; 
            position: relative;
            overflow: hidden;
        }
        
        .stock-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.3) 50%, 
                transparent 100%);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .stock-green { 
            background: linear-gradient(90deg, #10b981, #34d399); 
        }
        
        .stock-yellow { 
            background: linear-gradient(90deg, #f59e0b, #fbbf24); 
        }
        
        .stock-red { 
            background: linear-gradient(90deg, #ef4444, #f87171); 
        }
        
        /* è¼‰å…¥å‹•ç•« - å„ªåŒ– */
        .loader { 
            width: 48px; 
            height: 48px; 
            border: 3px solid rgba(139, 92, 246, 0.1); 
            border-top-color: #8b5cf6; 
            border-radius: 50%; 
            animation: spin 0.8s linear infinite; 
        }
        
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }
        
        /* æŒ‰éˆ•å¾®äº¤äº’ - æ¥µè‡´æ”¹é€² + å¯è¨ªå•æ€§ */
        .btn-interactive {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            /* ç¢ºä¿è§¸æ‘¸ç›®æ¨™ */
            min-width: 44px;
            min-height: 44px;
            /* æå‡å°æ¯”åº¦ */
            border: 2px solid transparent;
        }
        
        .btn-interactive:focus {
            outline: 3px solid #8b5cf6;
            outline-offset: 2px;
        }
        
        .btn-interactive:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .btn-interactive::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2), transparent 70%);
            transform: translate(-50%, -50%);
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1), 
                        height 0.6s cubic-bezier(0.4, 0, 0.2, 1),
                        opacity 0.3s;
            opacity: 0;
        }
        
        .btn-interactive:active::before {
            width: 400px;
            height: 400px;
            opacity: 1;
        }
        
        .btn-interactive:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }
        
        .btn-interactive:active { 
            transform: scale(0.94) translateY(0); 
            transition: all 0.15s;
        }
        
        /* åˆ†é¡æŒ‰éˆ• - æ¥µè‡´è¨­è¨ˆ */
        .cat-chip {
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }
        
        .cat-chip::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, #8b5cf6, #a78bfa, #c084fc);
            opacity: 0;
            transition: opacity 0.4s;
        }
        
        .cat-chip::after {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.5), rgba(168, 85, 247, 0.3));
            border-radius: inherit;
            opacity: 0;
            transition: opacity 0.4s;
            z-index: -1;
            filter: blur(8px);
        }
        
        .cat-chip.active::before {
            opacity: 1;
        }
        
        .cat-chip.active::after {
            opacity: 1;
        }
        
        .cat-chip span {
            position: relative;
            z-index: 1;
            transition: transform 0.3s;
        }
        
        .cat-chip.active { 
            color: white;
            box-shadow: 
                0 6px 32px rgba(139, 92, 246, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: scale(1.08) translateY(-1px);
        }
        
        .cat-chip.active span {
            transform: scale(1.05);
        }
        
        .cat-chip:active {
            transform: scale(0.95);
        }
        
        /* åº•éƒ¨å°èˆª - æ¥µè‡´å„ªåŒ– */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.95), rgba(0, 0, 0, 0.9));
            backdrop-filter: blur(40px) saturate(200%);
            -webkit-backdrop-filter: blur(40px) saturate(200%);
            border-top: 1px solid rgba(255, 255, 255, 0.12);
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 
                0 -12px 48px rgba(0, 0, 0, 0.7),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }
        
        .nav-item {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        
        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%) scaleX(0);
            width: 40px;
            height: 3px;
            background: linear-gradient(90deg, #8b5cf6, #a78bfa);
            border-radius: 0 0 999px 999px;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .nav-item.active {
            color: #8b5cf6;
        }
        
        .nav-item.active::before {
            transform: translateX(-50%) scaleX(1);
        }
        
        .nav-item.active .nav-icon {
            transform: scale(1.2) translateY(-2px);
            filter: drop-shadow(0 4px 12px rgba(139, 92, 246, 0.6));
        }
        
        .nav-item:active {
            transform: scale(0.92);
        }
        
        .nav-item:active .nav-icon {
            transform: scale(1.1) translateY(-1px);
        }
        
        /* Bottom Sheet - æ¥µè‡´æ”¹é€² */
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.99), rgba(5, 5, 5, 0.98));
            backdrop-filter: blur(50px) saturate(200%);
            -webkit-backdrop-filter: blur(50px) saturate(200%);
            border-top-left-radius: 36px;
            border-top-right-radius: 36px;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            transform: translateY(100%);
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 200;
            max-height: 85vh;
            padding-bottom: calc(env(safe-area-inset-bottom) + 20px);
            box-shadow: 
                0 -20px 80px rgba(0, 0, 0, 0.9),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                0 0 0 1px rgba(255, 255, 255, 0.05);
        }
        
        .bottom-sheet.open {
            transform: translateY(0);
        }
        
        .bottom-sheet::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: radial-gradient(ellipse at top, rgba(139, 92, 246, 0.1), transparent 70%);
            pointer-events: none;
        }
        
        .bottom-sheet-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 199;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            backdrop-filter: blur(4px);
        }
        
        .bottom-sheet-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        
        .bottom-sheet-handle {
            width: 40px;
            height: 5px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 999px;
            margin: 16px auto;
        }
        
        /* Toast - æ¥µè‡´æ”¹é€² */
        .toast-container { 
            position: fixed; 
            bottom: 90px; 
            left: 50%; 
            transform: translateX(-50%); 
            z-index: 9999; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            width: 90%; 
            max-width: 420px;
            pointer-events: none;
        }
        
        .toast { 
            background: linear-gradient(135deg, rgba(20, 20, 20, 0.98), rgba(26, 26, 26, 0.95)); 
            backdrop-filter: blur(32px) saturate(200%);
            -webkit-backdrop-filter: blur(32px) saturate(200%);
            border: 1px solid rgba(255, 255, 255, 0.15); 
            padding: 18px 24px; 
            border-radius: 24px; 
            animation: toastIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); 
            display: flex; 
            align-items: center; 
            gap: 16px;
            box-shadow: 
                0 16px 64px rgba(0, 0, 0, 0.7),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            pointer-events: auto;
            position: relative;
            overflow: hidden;
        }
        
        .toast::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top right, rgba(139, 92, 246, 0.1), transparent 60%);
            pointer-events: none;
        }
        
        @keyframes toastIn { 
            0% { 
                opacity: 0; 
                transform: translateY(30px) scale(0.9); 
            } 
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            } 
        }
        
        @keyframes toastOut { 
            0% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            } 
            100% { 
                opacity: 0; 
                transform: translateY(-20px) scale(0.95); 
            } 
        }
        
        /* æœå°‹æ¬„ - æ¥µè‡´è¨­è¨ˆ + å¯è¨ªå•æ€§ */
        .search-container {
            position: relative;
        }
        
        .search-input {
            /* æå‡å°æ¯”åº¦ */
            color: #ffffff;
        }
        
        .search-input::placeholder {
            color: #9ca3af; /* ç¢ºä¿ placeholder å°æ¯”åº¦ */
            opacity: 1;
        }
        
        .search-input:focus::placeholder {
            color: #6b7280;
        }
        
        .search-container::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: inherit;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(168, 85, 247, 0.2));
            opacity: 0;
            transition: opacity 0.3s;
            z-index: -1;
            filter: blur(8px);
        }
        
        .search-container:focus-within::before {
            opacity: 1;
        }
        
        .search-input {
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            width: 100%;
        }
        
        .search-input:focus {
            outline: none;
            transform: scale(1.02);
            box-shadow: 
                0 0 0 4px rgba(139, 92, 246, 0.25),
                0 12px 40px rgba(139, 92, 246, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border-color: rgba(139, 92, 246, 0.6);
        }
        
        /* å¡ç‰‡å‹•ç•« - æ¥µè‡´å„ªåŒ– */
        .card-item {
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer;
            will-change: transform, box-shadow;
            position: relative;
            overflow: hidden;
        }
        
        .card-item::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at var(--mouse-x, 50%) var(--mouse-y, 50%), 
                rgba(139, 92, 246, 0.15), transparent 60%);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        .card-item:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.7),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                0 0 40px rgba(139, 92, 246, 0.2);
        }
        
        .card-item:hover::after {
            opacity: 1;
        }
        
        .card-item:active {
            transform: translateY(-1px) scale(0.99);
            transition: all 0.15s;
        }
        
        /* é é¢åˆ‡æ› - æ¥µè‡´æ”¹é€² */
        .page {
            display: none;
            animation: pageIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .page.active {
            display: block;
        }
        
        @keyframes pageIn {
            0% { 
                opacity: 0; 
                transform: translateY(30px) scale(0.98); 
                filter: blur(4px);
            }
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
                filter: blur(0);
            }
        }
        
        /* æ•¸å­—é¡¯ç¤º - æ¥µè‡´å„ªåŒ– */
        .big-number {
            font-variant-numeric: tabular-nums;
            letter-spacing: -0.04em;
            font-weight: 800;
            text-shadow: 0 2px 20px rgba(139, 92, 246, 0.3);
            background: linear-gradient(135deg, #ffffff, rgba(255, 255, 255, 0.9));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transition: all 0.3s;
        }
        
        .big-number.text-purple-400 {
            background: linear-gradient(135deg, #a78bfa, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 20px rgba(139, 92, 246, 0.4);
        }
        
        .big-number.text-cyan-400 {
            background: linear-gradient(135deg, #67e8f9, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 20px rgba(6, 182, 212, 0.4);
        }
        
        .big-number.text-yellow-400 {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 20px rgba(245, 158, 11, 0.4);
        }
        
        .big-number.text-green-400 {
            background: linear-gradient(135deg, #34d399, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 20px rgba(16, 185, 129, 0.4);
        }
        
        /* ç‹€æ…‹å¾½ç«  - æ”¹é€² */
        .status-badge {
            position: relative;
            overflow: hidden;
        }
        
        .status-badge.online::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 6px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            50% { opacity: 0.8; box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
        }
        
        /* çµ±è¨ˆå¡ç‰‡ - æ¥µè‡´å¢å¼· */
        .stat-card {
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top right, rgba(139, 92, 246, 0.2), transparent 60%);
            opacity: 0;
            transition: opacity 0.4s;
        }
        
        .stat-card::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.05), transparent 70%);
            opacity: 0;
            transition: opacity 0.4s;
        }
        
        .stat-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 
                0 16px 48px rgba(0, 0, 0, 0.7),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                0 0 30px rgba(139, 92, 246, 0.3);
        }
        
        .stat-card:hover::before,
        .stat-card:hover::after {
            opacity: 1;
        }
        
        .stat-card:active {
            transform: translateY(-2px) scale(1);
        }
        
        /* å®‰å…¨å€åŸŸé©é… */
        .safe-top {
            padding-top: max(env(safe-area-inset-top), 12px);
        }
        
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* æ•ˆèƒ½å„ªåŒ– */
        .gpu-accelerated {
            transform: translateZ(0);
            will-change: transform;
        }
        
        /* ç„¡éšœç¤™æ”¹é€² - å…¨é¢å„ªåŒ– */
        .focus-visible:focus,
        button:focus-visible,
        input:focus-visible,
        [role="button"]:focus-visible {
            outline: 3px solid #8b5cf6;
            outline-offset: 3px;
            border-radius: 6px;
        }
        
        /* èªç¾©åŒ–æ¨™ç±¤æ¨£å¼ */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 700;
            line-height: 1.2;
        }
        
        /* æå‡æ–‡å­—å°æ¯”åº¦ */
        .text-gray-400 {
            color: #a1a1aa; /* æå‡å°æ¯”åº¦ */
        }
        
        .text-gray-500 {
            color: #71717a; /* æå‡å°æ¯”åº¦ */
        }
        
        /* éŒ¯èª¤ç‹€æ…‹å°æ¯”åº¦å„ªåŒ– */
        .text-red-400 {
            color: #f87171; /* ç¢ºä¿å°æ¯”åº¦ */
        }
        
        /* æˆåŠŸç‹€æ…‹å°æ¯”åº¦å„ªåŒ– */
        .text-green-400 {
            color: #4ade80; /* ç¢ºä¿å°æ¯”åº¦ */
        }
        
        /* å±å¹•é–±è®€å™¨å°ˆç”¨ */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        /* åŠ è¼‰ç‹€æ…‹å¯è¨ªå•æ€§ */
        [aria-busy="true"] {
            cursor: wait;
        }
        
        [aria-disabled="true"] {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        /* ç©ºç‹€æ…‹å„ªåŒ– */
        .empty-state {
            animation: fadeIn 0.5s ease-out;
        }
        
        /* æ“ä½œäººå“¡æŒ‰éˆ• */
        .operator-btn {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .operator-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(139, 92, 246, 0.4);
        }
        
        .operator-btn.active {
            box-shadow: 0 6px 24px rgba(139, 92, 246, 0.5);
        }
        
        .operator-select-btn {
            position: relative;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .operator-select-btn:hover {
            transform: translateY(-2px);
        }
        
        .operator-select-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 16px;
            padding: 1px;
            background: linear-gradient(135deg, #8b5cf6, #a78bfa);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .operator-select-btn:hover::before {
            opacity: 0.5;
        }
        
        /* æ¼¸è®Šå‹•ç•« */
        @keyframes gradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .animate-gradient {
            background-size: 200% 200%;
            animation: gradient 3s ease infinite;
        }
        
        /* æ•¸å­—å‹•ç•« */
        @keyframes numberPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .number-update {
            animation: numberPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        /* åˆ—è¡¨é …ç›®é€²å…¥å‹•ç•« */
        .list-item-enter {
            animation: listItemEnter 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) backwards;
        }
        
        @keyframes listItemEnter {
            0% {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* å„ªåŒ–å·¥åœ°ç¾å ´ç‰©æ–™åˆ—è¡¨ */
        .site-item {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .site-item:hover {
            transform: translateX(4px);
            background: rgba(255, 255, 255, 0.1) !important;
        }
        
        .site-item:active {
            transform: translateX(2px) scale(0.98);
        }
        
        /* å„ªåŒ–çµ±è¨ˆå¡ç‰‡æ¨™ç±¤ */
        .stat-label {
            letter-spacing: 0.05em;
            font-weight: 600;
        }
        
        /* å„ªåŒ–åˆ†é¡çµ±è¨ˆæ¢ */
        .category-bar-item {
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }
        
        .category-bar-item::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: barShine 2s infinite;
        }
        
        @keyframes barShine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
    </style>
</head>
<body>
    <!-- Toast å®¹å™¨ -->
    <div id="toastBox" class="toast-container" role="status" aria-live="polite" aria-atomic="true"></div>
    
    <!-- Bottom Sheet Overlay -->
    <div id="bottomSheetOverlay" class="bottom-sheet-overlay" onclick="closeBottomSheet()" role="button" aria-label="é—œé–‰ç›¤é»è¦–çª—" tabindex="0" onkeydown="if(event.key==='Enter'||event.key===' '){closeBottomSheet();event.preventDefault();}"></div>
    
    <!-- ä¸»å®¹å™¨ -->
    <div class="relative min-h-screen pb-24 safe-bottom">
        
        <!-- Header -->
        <header id="header" class="glass-strong sticky top-0 z-50 safe-top" role="banner">
            <div class="px-5 py-5">
                <div class="flex justify-between items-center mb-3">
                    <div>
                        <h1 class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-500 via-purple-500 to-purple-600 animate-gradient">
                            ç‰©æ–™æˆ°æƒ…å®¤
                        </h1>
                        <p class="text-xs text-gray-400 mt-1 font-semibold tracking-wide" aria-label="ç‰ˆæœ¬è™Ÿ">v19.0 Pro Edition</p>
                    </div>
                    <div id="statusBadge" class="status-badge text-xs px-4 py-2.5 rounded-full bg-white/5 text-gray-400 border border-white/10 font-semibold backdrop-blur-sm" role="status" aria-live="polite" aria-atomic="true">
                        é€£ç·šä¸­...
                    </div>
                </div>
                <div class="flex items-center gap-2.5 text-xs">
                    <span class="text-gray-500 font-medium" aria-label="ç•¶å‰æ“ä½œäººå“¡æ¨™ç±¤">æ“ä½œäººå“¡</span>
                    <span id="headerOperator" class="px-3 py-1.5 rounded-xl bg-gradient-to-r from-purple-600/30 to-purple-500/20 text-purple-300 font-bold border border-purple-500/40 shadow-lg shadow-purple-500/20" aria-label="ç•¶å‰æ“ä½œäººå“¡" role="status">é»ƒä¿Šç‘‹</span>
                </div>
            </div>
        </header>
        
        <!-- Dashboard é é¢ -->
        <div id="page-dashboard" class="page active">
            <div class="px-5 py-6 space-y-6">
                <!-- çµ±è¨ˆå¡ç‰‡ -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="stat-card glass rounded-3xl p-6 text-center relative">
                        <div class="absolute top-3 right-3 text-2xl opacity-20">ğŸ“Š</div>
                        <p class="stat-label text-gray-400 text-[10px] font-bold uppercase tracking-wider mb-3">ç¸½å“é …</p>
                        <p id="totalItems" class="big-number text-5xl font-extrabold text-white leading-none">-</p>
                    </div>
                    <div class="stat-card glass rounded-3xl p-6 text-center relative">
                        <div class="absolute top-3 right-3 text-2xl opacity-20">âš ï¸</div>
                        <p class="stat-label text-gray-400 text-[10px] font-bold uppercase tracking-wider mb-3">ä½åº«å­˜</p>
                        <p id="lowStock" class="big-number text-5xl font-extrabold text-yellow-400 leading-none">-</p>
                    </div>
                </div>
                
                <!-- åˆ†é¡çµ±è¨ˆæ¢ -->
                <div class="glass rounded-3xl p-6">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="text-xl">ğŸ“ˆ</span>
                        <h3 class="text-base font-bold text-white">åˆ†é¡çµ±è¨ˆ</h3>
                    </div>
                    <div id="categoryBar" class="h-3 rounded-full bg-white/5 flex overflow-hidden mb-4"></div>
                    <div id="categoryLegend" class="flex flex-wrap gap-4 text-xs text-gray-400"></div>
                </div>
                
                <!-- å·¥åœ°ç¾å ´ç‰©æ–™æ¸…å–® -->
                <div class="glass rounded-3xl p-6">
                    <div class="flex items-center justify-between mb-5">
                        <div class="flex items-center gap-2.5">
                            <span class="text-2xl">ğŸ—ï¸</span>
                            <h3 class="text-lg font-bold text-white">å·¥åœ°ç¾å ´ç‰©æ–™</h3>
                        </div>
                        <span id="siteItemCount" class="text-xs px-3.5 py-1.5 rounded-full bg-gradient-to-r from-cyan-500/30 to-cyan-400/20 text-cyan-300 font-bold border border-cyan-400/40 shadow-lg shadow-cyan-500/20">-</span>
                    </div>
                    <div id="siteItemsList" class="space-y-2.5 max-h-96 overflow-y-auto">
                        <!-- ç‰©æ–™é …ç›®å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                    <div id="siteItemsEmpty" class="hidden text-center py-12">
                        <div class="text-5xl mb-3 opacity-40">ğŸ“­</div>
                        <p class="text-gray-500 text-sm font-medium">å·¥åœ°ç¾å ´æš«ç„¡ç‰©æ–™</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- List é é¢ -->
        <div id="page-list" class="page">
            <div class="px-5 py-5 space-y-5">
                <!-- æœå°‹æ¬„ -->
                <div class="search-container glass rounded-3xl p-5" role="search">
                    <label for="searchInput" class="sr-only">æœå°‹ç‰©æ–™</label>
                    <div class="flex items-center gap-4">
                        <svg class="w-6 h-6 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <input 
                            type="search" 
                            id="searchInput" 
                            placeholder="æœå°‹å“åã€è¦æ ¼..." 
                            class="search-input flex-1 bg-transparent text-white placeholder-gray-500 text-base font-semibold focus:outline-none"
                            autocomplete="off"
                            aria-label="æœå°‹ç‰©æ–™å“åæˆ–è¦æ ¼"
                            aria-describedby="searchHint"
                        >
                    </div>
                    <div id="searchHint" class="sr-only">è¼¸å…¥é—œéµå­—ä»¥æœå°‹ç‰©æ–™</div>
                </div>
                
                <!-- åˆ†é¡æ¨™ç±¤ -->
                <div class="flex gap-3 overflow-x-auto pb-3 scrollbar-hide" style="-webkit-overflow-scrolling: touch;" id="categoryChips" role="tablist" aria-label="ç‰©æ–™åˆ†é¡ç¯©é¸">
                    <button class="cat-chip active px-6 py-3 rounded-full text-sm font-bold bg-white/5 text-gray-300 border border-white/10" data-cat="all" role="tab" aria-selected="true" aria-controls="inventoryList" tabindex="0">
                        <span>å…¨éƒ¨</span>
                    </button>
                    <button class="cat-chip px-6 py-3 rounded-full text-sm font-bold bg-white/5 text-gray-300 border border-white/10" data-cat="wire" role="tab" aria-selected="false" aria-controls="inventoryList" tabindex="-1">
                        <span>ğŸ”Œ é›»ç·š</span>
                    </button>
                    <button class="cat-chip px-6 py-3 rounded-full text-sm font-bold bg-white/5 text-gray-300 border border-white/10" data-cat="terminal" role="tab" aria-selected="false" aria-controls="inventoryList" tabindex="-1">
                        <span>ğŸ”— ç«¯å­</span>
                    </button>
                    <button class="cat-chip px-6 py-3 rounded-full text-sm font-bold bg-white/5 text-gray-300 border border-white/10" data-cat="consumable" role="tab" aria-selected="false" aria-controls="inventoryList" tabindex="-1">
                        <span>ğŸ“¦ è€—æ</span>
                    </button>
                    <button class="cat-chip px-6 py-3 rounded-full text-sm font-bold bg-white/5 text-gray-300 border border-white/10" data-cat="pipe" role="tab" aria-selected="false" aria-controls="inventoryList" tabindex="-1">
                        <span>ğŸ”© ç®¡æ</span>
                    </button>
                    <button class="cat-chip px-6 py-3 rounded-full text-sm font-bold bg-white/5 text-gray-300 border border-white/10" data-cat="hardware" role="tab" aria-selected="false" aria-controls="inventoryList" tabindex="-1">
                        <span>ğŸ”§ äº”é‡‘</span>
                    </button>
                </div>
                
                <!-- åº«å­˜åˆ—è¡¨ -->
                <div id="inventoryList" class="space-y-3" role="list" aria-label="ç‰©æ–™åˆ—è¡¨"></div>
                
                <!-- ç©ºç‹€æ…‹ -->
                <div id="emptyState" class="hidden empty-state text-center py-24" role="status" aria-live="polite">
                    <div class="text-8xl mb-6 opacity-40 filter drop-shadow-2xl" aria-hidden="true">ğŸ“­</div>
                    <p class="text-gray-400 text-lg font-bold mb-2">æ‰¾ä¸åˆ°ç¬¦åˆçš„å“é …</p>
                    <p class="text-gray-600 text-sm font-medium">å˜—è©¦èª¿æ•´ç¯©é¸æ¢ä»¶æˆ–æœå°‹é—œéµå­—</p>
                </div>
            </div>
        </div>
        
        <!-- Settings é é¢ -->
        <div id="page-settings" class="page">
            <div class="px-5 py-5 space-y-4">
                <div class="glass-strong rounded-3xl p-6">
                    <h3 class="text-lg font-extrabold text-white mb-6 flex items-center gap-2">
                        <span>âš™ï¸</span>
                        <span>ç³»çµ±è¨­å®š</span>
                    </h3>
                    <div class="space-y-3">
                        <button id="exportBtn" class="btn-interactive w-full flex items-center justify-between p-5 rounded-2xl bg-white/5 hover:bg-white/10 transition border-2 border-white/10 hover:border-white/20" aria-label="åŒ¯å‡º CSV æª”æ¡ˆ">
                            <div class="flex items-center gap-4">
                                <span class="text-3xl" aria-hidden="true">ğŸ“¥</span>
                                <span class="text-base font-bold text-white">åŒ¯å‡º CSV</span>
                            </div>
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                        <button id="refreshBtn" class="btn-interactive w-full flex items-center justify-between p-5 rounded-2xl bg-white/5 hover:bg-white/10 transition border-2 border-white/10 hover:border-white/20" aria-label="é‡æ–°è¼‰å…¥è³‡æ–™">
                            <div class="flex items-center gap-4">
                                <span class="text-3xl" aria-hidden="true">ğŸ”„</span>
                                <span class="text-base font-bold text-white">é‡æ–°è¼‰å…¥</span>
                            </div>
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="glass rounded-3xl p-6">
                    <h3 class="text-lg font-extrabold text-white mb-5 flex items-center gap-2">
                        <span>ğŸ‘¤</span>
                        <span>ç›®å‰æ“ä½œäººå“¡</span>
                    </h3>
                    <div id="operatorSelector" class="flex flex-col gap-3"></div>
                </div>
                
                <div class="glass rounded-3xl p-6">
                    <h3 class="text-lg font-extrabold text-white mb-5 flex items-center gap-2">
                        <span>â„¹ï¸</span>
                        <span>é—œæ–¼</span>
                    </h3>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between items-center py-2 border-b border-white/5">
                            <span class="text-gray-400 font-semibold">ç‰ˆæœ¬</span>
                            <span class="text-white font-extrabold">v19.0 Pro</span>
                        </div>
                        <div class="flex justify-between items-center py-2">
                            <span class="text-gray-400 font-semibold">å·²è¼‰å…¥å“é …</span>
                            <span class="text-white font-extrabold" id="settingsItemCount">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Loading ç‹€æ…‹ -->
        <div id="loadingState" class="fixed inset-0 z-50 flex flex-col items-center justify-center glass-strong" role="status" aria-live="polite" aria-busy="true" aria-label="è¼‰å…¥è³‡æ–™ä¸­">
            <div class="relative" aria-hidden="true">
                <div class="loader"></div>
                <div class="absolute inset-0 loader" style="border-top-color: #a78bfa; animation-delay: 0.2s; animation-duration: 1.2s;"></div>
            </div>
            <p class="text-gray-300 mt-10 text-lg font-bold">è¼‰å…¥è³‡æ–™ä¸­...</p>
            <p id="loadingTimer" class="text-gray-600 text-sm mt-3 font-semibold" aria-live="polite"></p>
        </div>
        
        <!-- Error ç‹€æ…‹ -->
        <div id="errorState" class="hidden fixed inset-0 z-50 flex items-center justify-center p-6" role="alert" aria-live="assertive">
            <div class="glass-strong rounded-3xl p-10 text-center max-w-sm w-full relative overflow-hidden">
                <div class="absolute top-0 right-0 w-64 h-64 bg-red-500/10 rounded-full blur-3xl" aria-hidden="true"></div>
                <div class="relative z-10">
                    <div class="text-7xl mb-6 filter drop-shadow-2xl" aria-hidden="true">âš ï¸</div>
                    <h3 class="text-2xl font-extrabold text-red-400 mb-4">è¼‰å…¥å¤±æ•—</h3>
                    <p id="errorMsg" class="text-sm text-gray-400 mb-10 leading-relaxed font-medium"></p>
                    <button id="retryBtn" class="btn-interactive bg-gradient-to-r from-red-600 to-red-500 hover:from-red-700 hover:to-red-600 text-white px-10 py-5 rounded-2xl font-extrabold w-full transition shadow-xl shadow-red-600/30" aria-label="é‡æ–°é€£ç·šè¼‰å…¥è³‡æ–™">
                        ğŸ”„ é‡æ–°é€£ç·š
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bottom Sheet (ç›¤é»è¦–çª—) -->
    <div id="bottomSheet" class="bottom-sheet" role="dialog" aria-modal="true" aria-labelledby="bottomSheetTitle" aria-hidden="true">
        <div class="bottom-sheet-handle" aria-hidden="true"></div>
        <div class="px-6 pb-6 overflow-y-auto" style="max-height: calc(85vh - 60px);">
            <div id="bottomSheetContent"></div>
        </div>
    </div>
    
    <!-- åº•éƒ¨å°èˆª -->
    <nav class="bottom-nav" role="navigation" aria-label="ä¸»è¦å°èˆª">
        <div class="flex justify-around items-center py-3 px-3">
            <button onclick="switchPage('dashboard')" class="nav-item active flex flex-col items-center gap-1.5 px-5 py-2.5 rounded-2xl" data-page="dashboard" aria-label="ç¸½è¦½é é¢" aria-current="page">
                <span class="nav-icon text-2xl transition-all" aria-hidden="true">ğŸ </span>
                <span class="text-[10px] font-bold tracking-wide">ç¸½è¦½</span>
            </button>
            <button onclick="switchPage('list')" class="nav-item flex flex-col items-center gap-1.5 px-5 py-2.5 rounded-2xl" data-page="list" aria-label="åˆ—è¡¨é é¢">
                <span class="nav-icon text-2xl transition-all" aria-hidden="true">ğŸ“¦</span>
                <span class="text-[10px] font-bold tracking-wide">åˆ—è¡¨</span>
            </button>
            <button onclick="switchPage('settings')" class="nav-item flex flex-col items-center gap-1.5 px-5 py-2.5 rounded-2xl" data-page="settings" aria-label="è¨­å®šé é¢">
                <span class="nav-icon text-2xl transition-all" aria-hidden="true">âš™ï¸</span>
                <span class="text-[10px] font-bold tracking-wide">è¨­å®š</span>
            </button>
        </div>
    </nav>

    <script>
    (function() {
        'use strict';

        // ===== è¨­å®š =====
        var API_PRIMARY = 'https://script.google.com/macros/s/AKfycbwxhdsphlO2wdnHuxElY4oRcenbv4MLqE-ZhCvcQNDGljvExzgFtyZFS3EQ4cBG2uq1/exec';
        var API_BACKUP = API_PRIMARY;
        var TIMEOUT = 20000;
        var DEBOUNCE_DELAY = 600;

        // ===== ç‹€æ…‹ç®¡ç† =====
        var state = {
            stock: [],
            filtered: [],
            category: 'all',
            searchText: '',
            currentPage: 'dashboard',
            currentItem: null,
            isLoading: false,
            updateTimers: {},
            currentOperator: 'é»ƒä¿Šç‘‹' // é è¨­æ“ä½œäººå“¡
        };
        
        // æ“ä½œäººå“¡æ¸…å–®
        var OPERATORS = ['é»ƒä¿Šç‘‹', 'æˆ´åº­å®‡', 'å¾ä¼Šæ©'];

        // ===== DOM ç·©å­˜ =====
        var el = {};

        function $(id) { return document.getElementById(id); }

        function initDOM() {
            el.statusBadge = $('statusBadge');
            el.totalItems = $('totalItems');
            el.lowStock = $('lowStock');
            el.searchInput = $('searchInput');
            el.exportBtn = $('exportBtn');
            el.refreshBtn = $('refreshBtn');
            el.categoryChips = $('categoryChips');
            el.categoryBar = $('categoryBar');
            el.categoryLegend = $('categoryLegend');
            el.loadingState = $('loadingState');
            el.loadingTimer = $('loadingTimer');
            el.errorState = $('errorState');
            el.errorMsg = $('errorMsg');
            el.retryBtn = $('retryBtn');
            el.inventoryList = $('inventoryList');
            el.emptyState = $('emptyState');
            el.toastBox = $('toastBox');
            el.bottomSheet = $('bottomSheet');
            el.bottomSheetOverlay = $('bottomSheetOverlay');
            el.bottomSheetContent = $('bottomSheetContent');
            el.header = $('header');
            el.settingsItemCount = $('settingsItemCount');
            el.siteItemCount = $('siteItemCount');
            el.siteItemsList = $('siteItemsList');
            el.siteItemsEmpty = $('siteItemsEmpty');
        }

        // ===== å·¥å…·å‡½æ•¸ =====
        function safeNum(v, d) {
            var n = Number(v);
            return isNaN(n) ? (d || 0) : n;
        }

        function safeStr(v, d) {
            return (v === undefined || v === null || v === '') ? (d || '') : String(v);
        }

        function escapeHtml(str) {
            var div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function debounce(func, delay) {
            var timeoutId;
            return function() {
                var context = this;
                var args = arguments;
                clearTimeout(timeoutId);
                timeoutId = setTimeout(function() {
                    func.apply(context, args);
                }, delay);
            };
        }

        // ===== åˆ†é¡é‚è¼¯ - å„ªåŒ– =====
        var categoryConfig = {
            wire: { 
                keywords: ['é›»ç·š', 'é›»çºœ', 'cable', 'wire', 'XIPE', 'CSA', 'ç´°çºœ', 'ç´°èŠ¯', 
                          'æ§åˆ¶é›»çºœ', 'PVCé›»ç·š', 'å°ç·š', 'ç·šæ'], 
                icon: 'ğŸ”Œ', 
                label: 'é›»ç·š', 
                color: '#8b5cf6' 
            },
            terminal: { keywords: ['ç«¯å­', 'terminal'], icon: 'ğŸ”—', label: 'ç«¯å­', color: '#06b6d4' },
            consumable: { 
                keywords: ['æ‰ç·šå¸¶', 'ç´®ç·šå¸¶', 'æŸç·šå¸¶', 'è† å¸¶', 'è† å¸ƒ', 'çµ•ç·£è† å¸¶', 'é›»ç«å¸ƒ', 
                          'è€—æ', 'consumable', 'tape', 'æ¨™ç±¤', 'æ¨™ç¤º', 'è²¼ç´™'], 
                icon: 'ğŸ“¦', 
                label: 'è€—æ', 
                color: '#ec4899' 
            },
            pipe: { keywords: ['ç®¡', 'pipe', 'é…ç®¡'], icon: 'ğŸ”©', label: 'ç®¡æ', color: '#10b981' },
            hardware: { keywords: [], icon: 'ğŸ”§', label: 'äº”é‡‘', color: '#6366f1' }
        };

        function getCategory(item) {
            var s = (safeStr(item.name) + safeStr(item.spec)).toLowerCase();
            for (var cat in categoryConfig) {
                var keywords = categoryConfig[cat].keywords;
                for (var i = 0; i < keywords.length; i++) {
                    if (s.indexOf(keywords[i]) >= 0) return cat;
                }
            }
            return 'hardware';
        }

        function getCategoryIcon(cat) {
            return categoryConfig[cat] ? categoryConfig[cat].icon : 'ğŸ“¦';
        }

        // ===== UI ç‹€æ…‹ç®¡ç† =====
        function setStatus(type, text) {
            var colors = {
                loading: 'bg-white/5 text-gray-400 border-white/10',
                online: 'bg-green-900/20 text-green-400 border-green-700/30 online',
                error: 'bg-red-900/20 text-red-400 border-red-700/30'
            };
            el.statusBadge.className = 'status-badge text-xs px-4 py-2 rounded-full border font-medium transition-all ' + (colors[type] || colors.loading);
            el.statusBadge.textContent = text;
        }

        function showLoading() {
            state.isLoading = true;
            el.loadingState.classList.remove('hidden');
            el.loadingState.setAttribute('aria-busy', 'true');
            el.errorState.classList.add('hidden');
            setStatus('loading', 'é€£ç·šä¸­...');
        }

        function showError(msg) {
            state.isLoading = false;
            el.loadingState.classList.add('hidden');
            el.errorState.classList.remove('hidden');
            el.errorMsg.textContent = msg;
            setStatus('error', 'é€£ç·šå¤±æ•—');
        }

        function showContent() {
            state.isLoading = false;
            el.loadingState.classList.add('hidden');
            el.loadingState.setAttribute('aria-busy', 'false');
            el.errorState.classList.add('hidden');
            setStatus('online', 'ç·šä¸Š');
        }

        function toast(msg, type) {
            type = type || 'info';
            var icons = { 
                success: 'âœ…', 
                error: 'âŒ', 
                info: 'â„¹ï¸', 
                warning: 'âš ï¸' 
            };
            var div = document.createElement('div');
            div.className = 'toast';
            div.setAttribute('role', 'alert');
            div.setAttribute('aria-live', type === 'error' ? 'assertive' : 'polite');
            div.setAttribute('aria-atomic', 'true');
            div.innerHTML = '<span class="text-xl" aria-hidden="true">' + (icons[type] || icons.info) + '</span>' + 
                           '<span class="text-sm font-medium">' + escapeHtml(msg) + '</span>';
            el.toastBox.appendChild(div);
            
            // å±å¹•é–±è®€å™¨æç¤º
            var announcement = document.createElement('div');
            announcement.className = 'sr-only';
            announcement.setAttribute('aria-live', type === 'error' ? 'assertive' : 'polite');
            announcement.textContent = (icons[type] || icons.info) + ' ' + msg;
            document.body.appendChild(announcement);
            setTimeout(function() { announcement.remove(); }, 1000);
            
            setTimeout(function() { 
                div.style.animation = 'toastOut 0.3s ease forwards';
                setTimeout(function() { div.remove(); }, 300);
            }, 3000);
        }

        function switchPage(page) {
            if (state.currentPage === page) return;
            
            state.currentPage = page;
            
            // æ›´æ–°é é¢é¡¯ç¤º
            var pages = document.querySelectorAll('.page');
            pages.forEach(function(p) {
                p.classList.remove('active');
            });
            $('page-' + page).classList.add('active');
            
            // æ›´æ–°å°èˆªç‹€æ…‹
            var navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(function(item) {
                item.classList.remove('active');
            });
            var activeNav = document.querySelector('[data-page="' + page + '"]');
            if (activeNav) activeNav.classList.add('active');
            
            // é¡¯ç¤º/éš±è— Header
            el.header.style.display = (page === 'dashboard') ? 'block' : 'none';
            
            // å¦‚æœåˆ‡æ›åˆ°è¨­å®šé ï¼Œæ¸²æŸ“æ“ä½œäººå“¡é¸æ“‡å™¨
            if (page === 'settings') {
                renderOperatorSelector();
            }
            
            // é—œé–‰ Bottom Sheet
            closeBottomSheet();
        }
        
        function renderOperatorSelector() {
            var container = document.getElementById('operatorSelector');
            if (!container) return;
            
            var html = '';
            for (var i = 0; i < OPERATORS.length; i++) {
                var op = OPERATORS[i];
                var isActive = (op === state.currentOperator);
                var bgClass = isActive ? 'bg-gradient-to-r from-purple-600 to-purple-500 border-purple-400/50 text-white shadow-lg shadow-purple-500/30' : 'bg-white/5 border-white/10 text-gray-300';
                
                html += '<button onclick="setOperatorGlobal(\'' + escapeHtml(op) + '\')" ' +
                    'class="btn-interactive operator-select-btn flex items-center justify-between p-5 rounded-2xl border-2 transition-all ' + bgClass + '" ' +
                    'data-operator="' + escapeHtml(op) + '">' +
                    '<div class="flex items-center gap-4">' +
                        '<span class="text-3xl">ğŸ‘¤</span>' +
                        '<span class="font-extrabold text-base">' + escapeHtml(op) + '</span>' +
                    '</div>' +
                    (isActive ? '<span class="text-2xl font-bold">âœ“</span>' : '') +
                    '</button>';
            }
            
            container.innerHTML = html;
        }
        
        function setOperatorGlobal(operator) {
            state.currentOperator = operator;
            
            // æ›´æ–° Header é¡¯ç¤º
            var headerOp = document.getElementById('headerOperator');
            if (headerOp) {
                headerOp.textContent = operator;
                headerOp.classList.add('number-update');
                setTimeout(function() { headerOp.classList.remove('number-update'); }, 400);
            }
            
            renderOperatorSelector();
            toast('å·²åˆ‡æ›æ“ä½œäººå“¡ï¼š' + operator, 'success');
        }

        function updateDashboard() {
            el.totalItems.textContent = state.stock.length;
            el.settingsItemCount.textContent = state.stock.length;
            
            var lowCount = 0;
            var categoryCounts = {};
            var totalQty = 0;
            
            // åˆå§‹åŒ–æ‰€æœ‰åˆ†é¡è¨ˆæ•¸
            for (var cat in categoryConfig) {
                categoryCounts[cat] = 0;
            }
            
            // çµ±è¨ˆæ•¸æ“š
            for (var i = 0; i < state.stock.length; i++) {
                var item = state.stock[i];
                var total = safeNum(item.warehouseQty) + safeNum(item.siteQty);
                var safe = safeNum(item.safeQty, 1);
                
                if (total < safe) lowCount++;
                
                var cat = getCategory(item);
                categoryCounts[cat] += total;
                totalQty += total;
            }
            
            el.lowStock.textContent = lowCount;
            
            // æ›´æ–°åˆ†é¡æ¢
            if (totalQty === 0) totalQty = 1;
            var barHtml = '';
            var legendHtml = '';
            
            for (var cat in categoryCounts) {
                if (categoryCounts[cat] > 0) {
                    var pct = (categoryCounts[cat] / totalQty * 100).toFixed(1);
                    var config = categoryConfig[cat];
                    barHtml += '<div class="category-bar-item" style="width:' + pct + '%; background: linear-gradient(90deg, ' + config.color + ', ' + config.color + 'dd);"></div>';
                    legendHtml += '<span class="flex items-center gap-2 px-2 py-1 rounded-lg bg-white/5 border border-white/5">' + 
                                 '<span style="color:' + config.color + '; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">' + config.icon + '</span>' + 
                                 '<span class="font-semibold">' + config.label + '</span>' +
                                 '<span class="text-gray-500 font-bold">' + pct + '%</span>' + 
                                 '</span>';
                }
            }
            
            el.categoryBar.innerHTML = barHtml;
            el.categoryLegend.innerHTML = legendHtml;
            
            // æ›´æ–°å·¥åœ°ç¾å ´ç‰©æ–™æ¸…å–®
            renderSiteItems();
        }
        
        function renderSiteItems() {
            // ç¯©é¸å‡ºç¾å ´æœ‰åº«å­˜çš„ç‰©æ–™
            var siteItems = [];
            for (var i = 0; i < state.stock.length; i++) {
                var item = state.stock[i];
                if (safeNum(item.siteQty) > 0) {
                    siteItems.push(item);
                }
            }
            
            // æŒ‰ç¾å ´æ•¸é‡é™åºæ’åˆ—
            siteItems.sort(function(a, b) {
                return safeNum(b.siteQty) - safeNum(a.siteQty);
            });
            
            el.siteItemCount.textContent = siteItems.length;
            
            if (siteItems.length === 0) {
                el.siteItemsList.classList.add('hidden');
                el.siteItemsEmpty.classList.remove('hidden');
                return;
            }
            
            el.siteItemsEmpty.classList.add('hidden');
            el.siteItemsList.classList.remove('hidden');
            
            var html = '';
            for (var i = 0; i < siteItems.length; i++) {
                var item = siteItems[i];
                var id = safeStr(item.id, i);
                var name = safeStr(item.name, 'æœªå‘½å');
                var spec = safeStr(item.spec, '-');
                var sQty = safeNum(item.siteQty);
                var cat = getCategory(item);
                var icon = getCategoryIcon(cat);
                
                html += '<div class="site-item flex items-center justify-between p-4 rounded-2xl bg-white/5 border border-white/5 cursor-pointer" onclick="openBottomSheet(\'' + escapeHtml(id) + '\')" style="animation-delay: ' + (i * 0.05) + 's">' +
                    '<div class="flex items-center gap-3.5 flex-1 min-w-0">' +
                        '<span class="text-2xl flex-shrink-0">' + icon + '</span>' +
                        '<div class="flex-1 min-w-0">' +
                            '<p class="text-sm font-bold text-white truncate mb-0.5">' + escapeHtml(name) + '</p>' +
                            '<p class="text-xs text-gray-500 truncate font-medium">' + escapeHtml(spec) + '</p>' +
                        '</div>' +
                    '</div>' +
                    '<div class="text-right flex-shrink-0 ml-4">' +
                        '<p class="big-number text-3xl font-extrabold text-cyan-400 leading-none">' + sQty + '</p>' +
                        '<p class="text-[10px] text-gray-500 font-bold mt-1">ä»¶</p>' +
                    '</div>' +
                '</div>';
            }
            
            el.siteItemsList.innerHTML = html;
        }

        // ===== åˆ—è¡¨æ¸²æŸ“ =====
        function renderList() {
            if (state.filtered.length === 0) {
                el.inventoryList.innerHTML = '';
                el.emptyState.classList.remove('hidden');
                el.inventoryList.setAttribute('aria-label', 'æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç‰©æ–™');
                return;
            }
            
            el.emptyState.classList.add('hidden');
            el.inventoryList.setAttribute('aria-label', 'ç‰©æ–™åˆ—è¡¨ï¼Œå…± ' + state.filtered.length + ' é …');
            
            // ä½¿ç”¨ DocumentFragment æå‡æ€§èƒ½
            var fragment = document.createDocumentFragment();
            for (var i = 0; i < state.filtered.length; i++) {
                var div = document.createElement('div');
                div.innerHTML = renderItem(state.filtered[i], i);
                var item = div.firstChild;
                item.setAttribute('role', 'listitem');
                fragment.appendChild(item);
            }
            el.inventoryList.innerHTML = '';
            el.inventoryList.appendChild(fragment);
        }

        function renderItem(item, idx) {
            var id = safeStr(item.id, idx);
            var name = safeStr(item.name, 'æœªå‘½å');
            var spec = safeStr(item.spec, '-');
            var unit = safeStr(item.unit, 'å€‹');
            var wQty = safeNum(item.warehouseQty);
            var sQty = safeNum(item.siteQty);
            var safeQty = safeNum(item.safeQty, 1);
            var total = wQty + sQty;
            
            var pct = Math.min((total / Math.max(safeQty * 2, 1)) * 100, 100);
            var colorClass = 'stock-green';
            var statusText = 'åº«å­˜å……è¶³';
            if (total === 0) {
                colorClass = 'stock-red';
                statusText = 'ç„¡åº«å­˜';
            } else if (total < safeQty) {
                colorClass = 'stock-yellow';
                statusText = 'åº«å­˜ä¸è¶³';
            }
            
            var cat = getCategory(item);
            var icon = getCategoryIcon(cat);
            
            return '<div class="card-item glass rounded-3xl p-6 gpu-accelerated list-item-enter" ' +
                'onclick="openBottomSheet(\'' + escapeHtml(id) + '\')" ' +
                'onkeydown="if(event.key===\'Enter\'||event.key===\' \'){openBottomSheet(\'' + escapeHtml(id) + '\');event.preventDefault();}" ' +
                'data-id="' + escapeHtml(id) + '" ' +
                'role="button" ' +
                'tabindex="0" ' +
                'aria-label="' + escapeHtml(name) + 'ï¼Œè¦æ ¼ï¼š' + escapeHtml(spec) + 'ï¼Œå…¬å¸å€‰ï¼š' + wQty + 'ï¼Œç¾å ´å€‰ï¼š' + sQty + 'ï¼Œ' + statusText + '" ' +
                'style="animation-delay: ' + (idx * 0.03) + 's">' +
                '<div class="flex items-start justify-between gap-5">' +
                    '<div class="flex-1 min-w-0">' +
                        '<div class="flex items-center gap-3 mb-3">' +
                            '<span class="text-3xl filter drop-shadow-lg" aria-hidden="true">' + icon + '</span>' +
                            '<h3 class="font-extrabold text-white text-lg truncate">' + escapeHtml(name) + '</h3>' +
                        '</div>' +
                        '<p class="text-xs text-gray-400 mb-4 font-semibold">' + escapeHtml(spec) + ' Â· ' + escapeHtml(unit) + '</p>' +
                        '<div class="stock-bar" role="progressbar" aria-valuenow="' + pct + '" aria-valuemin="0" aria-valuemax="100" aria-label="åº«å­˜æ°´å¹³ï¼š' + pct.toFixed(0) + '%">' +
                            '<div class="stock-bar-fill ' + colorClass + '" style="width:' + pct + '%"></div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="text-right flex-shrink-0">' +
                        '<div class="mb-4">' +
                            '<p class="big-number text-4xl font-extrabold text-purple-400 leading-none" id="w-' + escapeHtml(id) + '" aria-label="å…¬å¸å€‰åº«å­˜">' + wQty + '</p>' +
                            '<p class="text-[10px] text-gray-500 font-bold mt-1.5 tracking-wide">å…¬å¸å€‰</p>' +
                        '</div>' +
                        '<div>' +
                            '<p class="big-number text-4xl font-extrabold text-cyan-400 leading-none" id="s-' + escapeHtml(id) + '" aria-label="ç¾å ´å€‰åº«å­˜">' + sQty + '</p>' +
                            '<p class="text-[10px] text-gray-500 font-bold mt-1.5 tracking-wide">ç¾å ´å€‰</p>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }

        function openBottomSheet(id) {
            var item = null;
            for (var i = 0; i < state.stock.length; i++) {
                if (state.stock[i].id == id) { 
                    item = state.stock[i]; 
                    break; 
                }
            }
            if (!item) return;
            
            state.currentItem = item;
            var wQty = safeNum(item.warehouseQty);
            var sQty = safeNum(item.siteQty);
            
            // ç”Ÿæˆæ“ä½œäººå“¡æŒ‰éˆ•
            var operatorButtons = '';
            for (var i = 0; i < OPERATORS.length; i++) {
                var op = OPERATORS[i];
                var isActive = (op === state.currentOperator);
                var activeClass = isActive ? 'bg-gradient-to-r from-purple-600 to-purple-500 text-white border-purple-400/50 shadow-lg shadow-purple-500/30' : 'bg-white/5 text-gray-300 border-white/10';
                operatorButtons += '<button onclick="setOperator(\'' + escapeHtml(op) + '\")" ' +
                    'class="operator-btn btn-interactive px-5 py-3 rounded-2xl text-sm font-bold border-2 transition-all ' + activeClass + '" ' +
                    'data-operator="' + escapeHtml(op) + '" ' +
                    'aria-label="é¸æ“‡æ“ä½œäººå“¡ ' + escapeHtml(op) + '" ' +
                    'aria-pressed="' + (isActive ? 'true' : 'false') + '">' +
                    escapeHtml(op) +
                    '</button>';
            }
            
            el.bottomSheetContent.innerHTML = 
                '<div class="mb-8">' +
                    '<h2 id="bottomSheetTitle" class="text-3xl font-extrabold text-white mb-3 leading-tight">' + escapeHtml(item.name) + '</h2>' +
                    '<p class="text-sm text-gray-400 font-semibold">' + escapeHtml(item.spec) + ' Â· ' + escapeHtml(item.unit) + '</p>' +
                '</div>' +
                '<div class="glass rounded-3xl p-5 mb-6">' +
                    '<div class="flex items-center gap-2.5 mb-4">' +
                        '<span class="text-xl" aria-hidden="true">ğŸ‘¤</span>' +
                        '<p class="text-xs text-gray-400 font-bold uppercase tracking-wider">æ“ä½œäººå“¡</p>' +
                    '</div>' +
                    '<div class="flex gap-3" role="group" aria-label="é¸æ“‡æ“ä½œäººå“¡">' + operatorButtons + '</div>' +
                '</div>' +
                '<div class="space-y-6">' +
                    '<div class="glass-strong rounded-3xl p-6 relative overflow-hidden">' +
                        '<div class="absolute top-0 right-0 w-32 h-32 bg-purple-500/10 rounded-full blur-3xl" aria-hidden="true"></div>' +
                        '<p class="text-xs text-gray-400 font-bold uppercase tracking-wider mb-5 relative z-10">å…¬å¸å€‰åº«å­˜</p>' +
                        '<div class="flex items-center justify-between gap-5 relative z-10" role="group" aria-label="èª¿æ•´å…¬å¸å€‰åº«å­˜">' +
                            '<button onclick="adjustQty(\'w\', -1)" class="btn-interactive w-16 h-16 rounded-3xl bg-red-600/20 text-red-400 flex items-center justify-center text-3xl font-extrabold border-2 border-red-600/40 shadow-lg shadow-red-600/20" aria-label="æ¸›å°‘å…¬å¸å€‰åº«å­˜">âˆ’</button>' +
                            '<div class="text-center flex-1">' +
                                '<p class="big-number text-6xl font-extrabold text-purple-400 leading-none" id="bs-w-' + id + '" aria-live="polite" aria-atomic="true">' + wQty + '</p>' +
                            '</div>' +
                            '<button onclick="adjustQty(\'w\', 1)" class="btn-interactive w-16 h-16 rounded-3xl bg-green-600/20 text-green-400 flex items-center justify-center text-3xl font-extrabold border-2 border-green-600/40 shadow-lg shadow-green-600/20" aria-label="å¢åŠ å…¬å¸å€‰åº«å­˜">+</button>' +
                        '</div>' +
                    '</div>' +
                    '<div class="glass-strong rounded-3xl p-6 relative overflow-hidden">' +
                        '<div class="absolute top-0 right-0 w-32 h-32 bg-cyan-500/10 rounded-full blur-3xl" aria-hidden="true"></div>' +
                        '<p class="text-xs text-gray-400 font-bold uppercase tracking-wider mb-5 relative z-10">ç¾å ´å€‰åº«å­˜</p>' +
                        '<div class="flex items-center justify-between gap-5 relative z-10" role="group" aria-label="èª¿æ•´ç¾å ´å€‰åº«å­˜">' +
                            '<button onclick="adjustQty(\'s\', -1)" class="btn-interactive w-16 h-16 rounded-3xl bg-red-600/20 text-red-400 flex items-center justify-center text-3xl font-extrabold border-2 border-red-600/40 shadow-lg shadow-red-600/20" aria-label="æ¸›å°‘ç¾å ´å€‰åº«å­˜">âˆ’</button>' +
                            '<div class="text-center flex-1">' +
                                '<p class="big-number text-6xl font-extrabold text-cyan-400 leading-none" id="bs-s-' + id + '" aria-live="polite" aria-atomic="true">' + sQty + '</p>' +
                            '</div>' +
                            '<button onclick="adjustQty(\'s\', 1)" class="btn-interactive w-16 h-16 rounded-3xl bg-green-600/20 text-green-400 flex items-center justify-center text-3xl font-extrabold border-2 border-green-600/40 shadow-lg shadow-green-600/20" aria-label="å¢åŠ ç¾å ´å€‰åº«å­˜">+</button>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            
            el.bottomSheet.classList.add('open');
            el.bottomSheet.setAttribute('aria-hidden', 'false');
            el.bottomSheetOverlay.classList.add('open');
            document.body.style.overflow = 'hidden';
            
            // èšç„¦åˆ°ç¬¬ä¸€å€‹å¯èšç„¦å…ƒç´ 
            setTimeout(function() {
                var firstButton = el.bottomSheetContent.querySelector('button');
                if (firstButton) firstButton.focus();
            }, 100);
        }
        
        function setOperator(operator) {
            state.currentOperator = operator;
            
            // æ›´æ–° Header é¡¯ç¤º
            var headerOp = document.getElementById('headerOperator');
            if (headerOp) headerOp.textContent = operator;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            var buttons = document.querySelectorAll('.operator-btn');
            buttons.forEach(function(btn) {
                if (btn.getAttribute('data-operator') === operator) {
                    btn.className = 'operator-btn btn-interactive px-5 py-3 rounded-2xl text-sm font-bold border-2 transition-all bg-gradient-to-r from-purple-600 to-purple-500 text-white border-purple-400/50 shadow-lg shadow-purple-500/30';
                } else {
                    btn.className = 'operator-btn btn-interactive px-5 py-3 rounded-2xl text-sm font-bold border-2 transition-all bg-white/5 text-gray-300 border-white/10';
                }
            });
            
            toast('å·²åˆ‡æ›ç‚ºï¼š' + operator, 'info');
        }

        function closeBottomSheet() {
            el.bottomSheet.classList.remove('open');
            el.bottomSheet.setAttribute('aria-hidden', 'true');
            el.bottomSheetOverlay.classList.remove('open');
            document.body.style.overflow = '';
            state.currentItem = null;
        }

        function adjustQty(type, delta) {
            if (!state.currentItem) return;
            
            var id = state.currentItem.id;
            var isW = type === 'w';
            
            // æ›´æ–°æœ¬åœ°ç‹€æ…‹
            if (isW) {
                state.currentItem.warehouseQty = Math.max(0, state.currentItem.warehouseQty + delta);
            } else {
                state.currentItem.siteQty = Math.max(0, state.currentItem.siteQty + delta);
            }
            
            var newQty = isW ? state.currentItem.warehouseQty : state.currentItem.siteQty;
            
            // æ›´æ–° UI
            var listEl = document.getElementById((isW ? 'w-' : 's-') + id);
            var sheetEl = document.getElementById((isW ? 'bs-w-' : 'bs-s-') + id);
            if (listEl) {
                listEl.textContent = newQty;
                listEl.classList.add('number-update');
                setTimeout(function() { listEl.classList.remove('number-update'); }, 400);
            }
            if (sheetEl) {
                sheetEl.textContent = newQty;
                sheetEl.classList.add('number-update');
                setTimeout(function() { sheetEl.classList.remove('number-update'); }, 400);
            }
            
            // é˜²æŠ–æ›´æ–°å¾Œç«¯
            var key = id + '-' + type;
            if (state.updateTimers[key]) {
                clearTimeout(state.updateTimers[key]);
            }
            
            state.updateTimers[key] = setTimeout(function() {
                var action = isW ? 'warehouse_audit' : 'audit';
                postAPI(action, { 
                    id: id, 
                    qty: newQty, 
                    person: state.currentOperator 
                })
                    .then(function() { 
                        toast('âœ… å·²åŒæ­¥ (' + state.currentOperator + ')', 'success');
                        updateDashboard();
                    })
                    .catch(function(e) { 
                        toast('åŒæ­¥å¤±æ•—: ' + e.message, 'error');
                    });
                
                delete state.updateTimers[key];
            }, DEBOUNCE_DELAY);
            
            // å³æ™‚å›é¥‹
            updateDashboard();
        }

        // ===== ç¯©é¸ =====
        var applyFiltersDebounced = debounce(function() {
            state.filtered = [];
            for (var i = 0; i < state.stock.length; i++) {
                var item = state.stock[i];
                
                if (state.category !== 'all' && getCategory(item) !== state.category) continue;
                
                if (state.searchText) {
                    var s = (safeStr(item.name) + ' ' + safeStr(item.spec) + ' ' + safeStr(item.alias || '')).toLowerCase();
                    if (s.indexOf(state.searchText.toLowerCase()) < 0) continue;
                }
                
                state.filtered.push(item);
            }
            renderList();
        }, 150);

        // ===== API =====
        function loadData(useBackup) {
            if (state.isLoading) return;
            
            showLoading();
            
            var url = useBackup ? API_BACKUP : API_PRIMARY;
            
            var timer = null;
            var sec = 0;
            timer = setInterval(function() {
                sec++;
                if (el.loadingTimer) el.loadingTimer.textContent = 'å·²ç­‰å¾… ' + sec + ' ç§’';
            }, 1000);
            
            var ctrl = new AbortController();
            var timeoutId = setTimeout(function() {
                ctrl.abort();
            }, TIMEOUT);
            
            fetch(url + '?t=' + Date.now(), { 
                signal: ctrl.signal,
                cache: 'no-cache'
            })
                .then(function(res) {
                    clearTimeout(timeoutId);
                    clearInterval(timer);
                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    return res.text();
                })
                .then(function(text) {
                    if (text.indexOf('<!DOCTYPE') >= 0 || text.indexOf('<html') >= 0) {
                        throw new Error('æ”¶åˆ° HTML é JSONï¼Œè«‹æª¢æŸ¥éƒ¨ç½²è¨­å®š');
                    }
                    
                    var data = JSON.parse(text);
                    
                    if (data.status === 'error') {
                        throw new Error(data.msg || 'å¾Œç«¯éŒ¯èª¤');
                    }
                    
                    if (!data.stock || !Array.isArray(data.stock)) {
                        throw new Error('è³‡æ–™æ ¼å¼éŒ¯èª¤');
                    }
                    
                    // è™•ç†æ•¸æ“š
                    state.stock = data.stock.map(function(it, i) {
                        return {
                            id: safeStr(it.id, 'i' + i),
                            name: safeStr(it.name, 'æœªå‘½å'),
                            spec: safeStr(it.spec, '-'),
                            unit: safeStr(it.unit, 'å€‹'),
                            warehouseQty: safeNum(it.warehouseQty),
                            siteQty: safeNum(it.siteQty),
                            safeQty: safeNum(it.safeQty, 1),
                            alias: safeStr(it.alias || '')
                        };
                    });
                    
                    applyFiltersDebounced();
                    updateDashboard();
                    showContent();
                    toast('å·²è¼‰å…¥ ' + state.stock.length + ' ç­†è³‡æ–™', 'success');
                })
                .catch(function(err) {
                    clearTimeout(timeoutId);
                    clearInterval(timer);
                    
                    if (err.name === 'AbortError') {
                        showError('é€£ç·šé€¾æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ç‹€æ…‹');
                    } else if (!useBackup && API_BACKUP !== API_PRIMARY) {
                        toast('åˆ‡æ›å‚™æ´é€£ç·š...', 'warning');
                        setTimeout(function() { loadData(true); }, 500);
                    } else {
                        showError(err.message);
                    }
                });
        }

        function postAPI(action, params) {
            var body = JSON.stringify(Object.assign({ action: action }, params));
            
            return fetch(API_PRIMARY, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'text/plain;charset=utf-8'  // Google Apps Script CORS hack
                },
                body: body,
                cache: 'no-cache',
                mode: 'cors'
            })
            .then(function(res) { 
                return res.text().then(function(text) {
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error('JSON parse error:', text);
                        throw new Error('ç„¡æ³•è§£æå›æ‡‰ï¼š' + text.substring(0, 100));
                    }
                });
            })
            .then(function(data) {
                if (data.status === 'error') throw new Error(data.msg);
                return data;
            })
            .catch(function(err) {
                console.error('POST API Error:', err);
                throw err;
            });
        }

        // ===== åŒ¯å‡º =====
        function exportCSV() {
            if (state.filtered.length === 0) {
                toast('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º', 'warning');
                return;
            }
            
            var rows = [['ID', 'å“å', 'è¦æ ¼', 'å–®ä½', 'å…¬å¸å€‰', 'ç¾å ´', 'å®‰å…¨å­˜é‡']];
            state.filtered.forEach(function(it) {
                rows.push([it.id, it.name, it.spec, it.unit, it.warehouseQty, it.siteQty, it.safeQty]);
            });
            
            var csv = rows.map(function(r) {
                return r.map(function(c) { 
                    return '"' + String(c).replace(/"/g, '""') + '"'; 
                }).join(',');
            }).join('\n');
            
            var blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'åº«å­˜_' + new Date().toISOString().slice(0, 10) + '.csv';
            link.click();
            
            toast('å·²åŒ¯å‡º ' + state.filtered.length + ' ç­†', 'success');
        }

        // ===== äº‹ä»¶ç¶å®š =====
        function bindEvents() {
            // æœå°‹
            el.searchInput.addEventListener('input', function(e) {
                state.searchText = e.target.value;
                applyFiltersDebounced();
            });
            
            // åˆ†é¡
            el.categoryChips.addEventListener('click', function(e) {
                var btn = e.target.closest('.cat-chip');
                if (!btn) return;
                
                var chips = el.categoryChips.querySelectorAll('.cat-chip');
                chips.forEach(function(chip) { 
                    chip.classList.remove('active');
                    chip.setAttribute('aria-selected', 'false');
                    chip.setAttribute('tabindex', '-1');
                });
                btn.classList.add('active');
                btn.setAttribute('aria-selected', 'true');
                btn.setAttribute('tabindex', '0');
                
                state.category = btn.getAttribute('data-cat');
                applyFiltersDebounced();
            });
            
            // éµç›¤å°èˆªåˆ†é¡æ¨™ç±¤
            el.categoryChips.addEventListener('keydown', function(e) {
                var chips = Array.from(el.categoryChips.querySelectorAll('.cat-chip'));
                var currentIndex = chips.indexOf(e.target);
                
                if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                    e.preventDefault();
                    var nextIndex = e.key === 'ArrowRight' 
                        ? (currentIndex + 1) % chips.length
                        : (currentIndex - 1 + chips.length) % chips.length;
                    chips[nextIndex].focus();
                    chips[nextIndex].click();
                } else if (e.key === 'Home') {
                    e.preventDefault();
                    chips[0].focus();
                    chips[0].click();
                } else if (e.key === 'End') {
                    e.preventDefault();
                    chips[chips.length - 1].focus();
                    chips[chips.length - 1].click();
                }
            });
            
            // æŒ‰éˆ•
            el.exportBtn.addEventListener('click', exportCSV);
            el.refreshBtn.addEventListener('click', function() { 
                toast('é‡æ–°è¼‰å…¥ä¸­...', 'info');
                loadData(false); 
            });
            el.retryBtn.addEventListener('click', function() { loadData(false); });
            
            // éµç›¤å¿«æ·éµ
            document.addEventListener('keydown', function(e) {
                // ESC é—œé–‰ Bottom Sheet
                if (e.key === 'Escape' && el.bottomSheet.classList.contains('open')) {
                    closeBottomSheet();
                }
                // Enter/Space è§¸ç™¼æŒ‰éˆ•ï¼ˆå·²åœ¨ HTML ä¸­è™•ç†ï¼‰
            });
        }

        // ===== å…¨åŸŸå‡½æ•¸ =====
        window.switchPage = switchPage;
        window.openBottomSheet = openBottomSheet;
        window.closeBottomSheet = closeBottomSheet;
        window.adjustQty = adjustQty;
        window.setOperator = setOperator;
        window.setOperatorGlobal = setOperatorGlobal;

        // ===== åˆå§‹åŒ– =====
        function init() {
            initDOM();
            bindEvents();
            loadData(false);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

    })();
    </script>

</body>
</html>
