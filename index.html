<!DOCTYPE html>
<html lang="zh-TW" class="dark">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ç‰©æ–™æˆ°æƒ…å®¤">
    <meta name="description" content="å·¥ç¨‹ç‰©æ–™åº«å­˜ç®¡ç†ç³»çµ± - å³æ™‚ç›¤é»ã€è¿½è¹¤ã€çµ±è¨ˆ">
    <meta name="keywords" content="ç‰©æ–™ç®¡ç†,åº«å­˜ç³»çµ±,ç›¤é»,å·¥ç¨‹ç®¡ç†">
    <title>ç‰©æ–™æˆ°æƒ…å®¤ v20.0 - å·¥ç¨‹ç‰©æ–™åº«å­˜ç®¡ç†ç³»çµ±</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="shortcut icon" type="image/png" href="icon-192.png">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- iOS Safari PWA Icons -->
    <link rel="apple-touch-icon" href="icon-192.png">

    <!-- PWA Theme -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- SweetAlert2 Dark Theme -->
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@4/dark.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>

    <!-- AutoAnimate for smooth list transitions -->
    <script type="module">
        import autoAnimate from 'https://cdn.jsdelivr.net/npm/@formkit/auto-animate@0.8.2/index.mjs';
        window.autoAnimate = autoAnimate;
    </script>

    <!-- ===== å°ˆæ¥­ UI æ’ä»¶å‡ç´š ===== -->

    <!-- Lucide Icons - å°ˆæ¥­ SVG åœ–æ¨™åº« -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <!-- CountUp.js - æ•¸å­—å‹•ç•«æ•ˆæœ -->
    <script src="https://cdn.jsdelivr.net/npm/countup.js@2.8.0/dist/countUp.umd.min.js"></script>

    <!-- Day.js - è¼•é‡ç´šæ—¥æœŸè™•ç† -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/zh-tw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>

    <!-- ApexCharts - ç¾ä»£åŒ–äº’å‹•åœ–è¡¨ -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <!-- Floating UI - å°ˆæ¥­ Tooltip/Popover -->
    <script src="https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.6.3/dist/floating-ui.dom.umd.min.js"></script>

    <!-- Chart.js for Dashboard Visualization (ä¿ç•™å‚™ç”¨) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Fuse.js for Fuzzy Search -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            100: '#1a1a1a',
                            200: '#151515',
                            300: '#101010',
                            400: '#0a0a0a',
                            500: '#000000'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1)',
                        'scale-in': 'scaleIn 0.2s ease-out'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' }
                        },
                        scaleIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* ===== shadcn/ui Design System - Dark Theme ===== */
        :root {
            /* shadcn/ui official dark theme colors */
            --background: 0 0% 3.9%;
            --foreground: 0 0% 98%;
            --card: 0 0% 3.9%;
            --card-foreground: 0 0% 98%;
            --popover: 0 0% 3.9%;
            --popover-foreground: 0 0% 98%;
            --primary: 0 0% 98%;
            --primary-foreground: 0 0% 9%;
            --secondary: 0 0% 14.9%;
            --secondary-foreground: 0 0% 98%;
            --muted: 0 0% 14.9%;
            --muted-foreground: 0 0% 63.9%;
            --accent: 0 0% 14.9%;
            --accent-foreground: 0 0% 98%;
            --destructive: 0 62.8% 30.6%;
            --destructive-foreground: 0 0% 98%;
            --border: 0 0% 14.9%;
            --input: 0 0% 14.9%;
            --ring: 0 0% 83.1%;
            --radius: 0.5rem;

            /* å“ç‰Œè‰²å½© */
            --purple: 262.1 83.3% 57.8%;
            --cyan: 187.9 85.7% 53.3%;
            --green: 142.1 76.2% 36.3%;
            --yellow: 40.6 96.1% 40.4%;
            --red: 0 84.2% 60.2%;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
            border-color: hsl(var(--border));
        }

        html,
        body {
            height: 100%;
            overflow-x: hidden;
        }

        body {
            /* shadcn/ui dark background */
            background: hsl(var(--background));
            color: hsl(var(--foreground));
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.5;
            font-size: 14px;
            letter-spacing: -0.01em;
        }

        @media (min-width: 640px) {
            body {
                font-size: 15px;
            }
        }

        /* ç¢ºä¿æœ€å°è§¸æ‘¸ç›®æ¨™ 44x44px (WCAG 2.5.5) */
        button,
        a,
        [role="button"],
        .clickable {
            min-width: 44px;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* éµç›¤å°èˆªå„ªåŒ– (WCAG 2.1.1) */
        *:focus-visible {
            outline: 3px solid #8b5cf6;
            outline-offset: 2px;
            border-radius: 4px;
        }

        /* æ¸›å°‘å‹•ç•« (WCAG 2.3.3) */
        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* å„ªé›…çš„æ²è»¸ */
        ::-webkit-scrollbar {
            width: 6px;
            background: transparent;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 999px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 999px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* éš±è—æ©«å‘æ²è»¸ */
        .scrollbar-hide::-webkit-scrollbar {
            width: 0px;
            height: 0px;
            display: none;
        }

        /* åº«å­˜é€²åº¦æ¢ - å¿…é ˆä¿ç•™ï¼ˆè¤‡é›œæ¼¸è®Šï¼‰ */
        .stock-bar {
            height: 6px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.05);
            margin-top: 10px;
            overflow: hidden;
            position: relative;
        }

        .stock-bar-fill {
            height: 100%;
            border-radius: 999px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1),
                background 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        /* ç§»é™¤ shimmer å‹•ç•«ï¼Œç°¡åŒ–ç‰¹æ•ˆ */

        .stock-green {
            background: hsl(var(--green));
        }

        .stock-yellow {
            background: hsl(var(--yellow));
        }

        .stock-red {
            background: hsl(var(--red));
        }

        /* ===== ä½åº«å­˜è­¦ç¤ºï¼ˆåƒè€ƒ Grocyï¼‰===== */
        .low-stock-alert {
            position: relative;
            border-color: hsl(var(--yellow)) !important;
            animation: lowStockPulse 2s ease-in-out infinite;
        }

        .low-stock-alert::before {
            content: '';
            position: absolute;
            inset: -1px;
            border-radius: inherit;
            border: 2px solid hsl(var(--yellow));
            opacity: 0;
            animation: lowStockRing 2s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes lowStockPulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 hsla(var(--yellow), 0);
            }

            50% {
                box-shadow: 0 0 12px 2px hsla(var(--yellow), 0.3);
            }
        }

        @keyframes lowStockRing {

            0%,
            100% {
                opacity: 0;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(1.02);
            }
        }

        /* ç„¡åº«å­˜ - æ›´é†’ç›®è­¦ç¤º */
        .out-of-stock {
            position: relative;
            border-color: hsl(var(--red)) !important;
            background: hsla(var(--red), 0.05) !important;
        }

        .out-of-stock::after {
            content: 'âš ï¸ ç„¡åº«å­˜';
            position: absolute;
            top: 8px;
            right: 8px;
            background: hsl(var(--red));
            color: white;
            font-size: 0.625rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* åŒæ­¥ç‹€æ…‹æŒ‡ç¤ºå™¨ */
        .sync-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 9999px;
            transition: all 0.2s ease;
        }

        .sync-indicator.syncing {
            background: hsla(var(--yellow), 0.15);
            color: hsl(var(--yellow));
        }

        .sync-indicator.syncing .sync-icon {
            animation: spin 1s linear infinite;
        }

        .sync-indicator.synced {
            background: hsla(var(--green), 0.15);
            color: hsl(var(--green));
        }

        .sync-indicator.pending {
            background: hsla(var(--yellow), 0.15);
            color: hsl(var(--yellow));
        }

        .sync-indicator.offline {
            background: hsla(var(--red), 0.15);
            color: hsl(var(--red));
        }

        /* ä¸‹æ‹‰åˆ·æ–°æŒ‡ç¤ºå™¨ */
        .pull-to-refresh {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: hsl(var(--background));
            border-bottom: 1px solid hsl(var(--border));
            transform: translateY(-100%);
            transition: transform 0.2s ease;
            z-index: 50;
        }

        .pull-to-refresh.active {
            transform: translateY(0);
        }

        .pull-to-refresh .refresh-icon {
            width: 24px;
            height: 24px;
            color: hsl(var(--muted-foreground));
            transition: transform 0.2s ease;
        }

        .pull-to-refresh.refreshing .refresh-icon {
            animation: spin 0.8s linear infinite;
        }

        /* è¼‰å…¥å‹•ç•« - å„ªåŒ– */
        .loader {
            width: 48px;
            height: 48px;
            border: 3px solid rgba(139, 92, 246, 0.1);
            border-top-color: #8b5cf6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* shadcn/ui æŒ‰éˆ•æ¨£å¼ */
        .btn-interactive {
            transition: all 0.15s ease;
            position: relative;
            cursor: pointer;
            min-width: 44px;
            min-height: 44px;
            border: 1px solid hsl(var(--border));
            border-radius: var(--radius);
            background: hsl(var(--secondary));
            color: hsl(var(--secondary-foreground));
            font-weight: 500;
        }

        .btn-interactive:focus-visible {
            outline: 2px solid hsl(var(--ring));
            outline-offset: 2px;
        }

        .btn-interactive:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .btn-interactive:hover {
            background: hsl(var(--accent));
        }

        .btn-interactive:active {
            transform: scale(0.98);
        }

        /* shadcn/ui åˆ†é¡æ¨™ç±¤ */
        .cat-chip {
            transition: all 0.15s ease;
            white-space: nowrap;
            position: relative;
            border-radius: 9999px;
            border: 1px solid hsl(var(--border));
            background: transparent;
            color: hsl(var(--muted-foreground));
            font-size: 0.875rem;
            font-weight: 500;
        }

        .cat-chip.active {
            background: hsl(var(--foreground)) !important;
            color: hsl(var(--background)) !important;
            border-color: hsl(var(--foreground)) !important;
        }

        .cat-chip:hover:not(.active) {
            background: hsl(var(--secondary));
            color: hsl(var(--foreground));
        }

        .cat-chip:active {
            transform: scale(0.98);
        }

        /* shadcn/ui åº•éƒ¨å°èˆª */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: hsl(var(--background));
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid hsl(var(--border));
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item {
            transition: all 0.15s ease;
            cursor: pointer;
            user-select: none;
            position: relative;
            color: hsl(var(--muted-foreground));
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%) scaleX(0);
            width: 32px;
            height: 2px;
            background: hsl(var(--foreground));
            border-radius: 0 0 999px 999px;
            transition: transform 0.15s ease;
        }

        .nav-item.active {
            color: hsl(var(--foreground));
        }

        .nav-item.active::before {
            transform: translateX(-50%) scaleX(1);
        }

        .nav-item.active .nav-icon {
            transform: scale(1.05);
        }

        .nav-item:active {
            transform: scale(0.96);
        }

        /* shadcn/ui Bottom Sheet */
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: hsl(var(--card));
            border-top-left-radius: calc(var(--radius) * 2);
            border-top-right-radius: calc(var(--radius) * 2);
            border-top: 1px solid hsl(var(--border));
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
            z-index: 200;
            max-height: 85vh;
            padding-bottom: calc(env(safe-area-inset-bottom) + 20px);
        }

        .bottom-sheet.open {
            transform: translateY(0);
        }

        .bottom-sheet-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 199;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .bottom-sheet-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }

        .bottom-sheet-handle {
            width: 48px;
            height: 4px;
            background: hsl(var(--muted));
            border-radius: 999px;
            margin: 12px auto;
        }

        /* è½‰ç§»è¼¸å…¥æ¡† - æ‰‹æ©Ÿå‹å–„ */
        .transfer-input-container {
            padding: 20px 0;
        }

        .transfer-input-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #9ca3af;
            margin-bottom: 12px;
            text-align: center;
        }

        .transfer-input-number {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 16px;
            padding: 20px;
            font-size: 32px;
            font-weight: 900;
            text-align: center;
            color: #ffffff;
            margin-bottom: 20px;
            outline: none;
            transition: all 0.3s;
            -webkit-appearance: none;
            appearance: none;
        }

        .transfer-input-number:focus {
            background: rgba(139, 92, 246, 0.15);
            border-color: rgba(139, 92, 246, 0.6);
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.2);
        }

        .transfer-quick-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .transfer-quick-btn {
            padding: 16px 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #ffffff;
            font-size: 16px;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        .transfer-quick-btn:active {
            transform: scale(0.95);
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.4);
        }

        .transfer-action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .transfer-action-btn {
            flex: 1;
            padding: 18px;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 800;
            text-align: center;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        .transfer-action-btn.confirm {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            color: #ffffff;
            box-shadow: 0 4px 16px rgba(6, 182, 212, 0.4);
        }

        .transfer-action-btn.confirm:active {
            transform: scale(0.98);
            box-shadow: 0 2px 8px rgba(6, 182, 212, 0.3);
        }

        .transfer-action-btn.cancel {
            background: rgba(255, 255, 255, 0.05);
            color: #9ca3af;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .transfer-action-btn.cancel:active {
            transform: scale(0.98);
            background: rgba(255, 255, 255, 0.1);
        }

        .transfer-info {
            text-align: center;
            padding: 16px;
            background: rgba(6, 182, 212, 0.1);
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(6, 182, 212, 0.2);
        }

        .transfer-info-text {
            font-size: 14px;
            color: #67e8f9;
            font-weight: 600;
        }

        .transfer-info-number {
            font-size: 24px;
            color: #ffffff;
            font-weight: 900;
            margin-top: 4px;
        }

        /* shadcn/ui Toast */
        .toast-container {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 90%;
            max-width: 400px;
            pointer-events: none;
        }

        .toast {
            background: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            padding: 12px 16px;
            border-radius: var(--radius);
            animation: toastIn 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            pointer-events: auto;
            font-size: 0.875rem;
        }

        @keyframes toastIn {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes toastOut {
            0% {
                opacity: 1;
                transform: translateY(0);
            }

            100% {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        /* æœå°‹æ¬„ - æ¥µè‡´è¨­è¨ˆ + å¯è¨ªå•æ€§ */
        .search-container {
            position: relative;
        }

        .search-input {
            /* æå‡å°æ¯”åº¦ */
            color: #ffffff;
        }

        .search-input::placeholder {
            color: #9ca3af;
            /* ç¢ºä¿ placeholder å°æ¯”åº¦ */
            opacity: 1;
        }

        .search-input:focus::placeholder {
            color: #6b7280;
        }

        .search-container::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: inherit;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(168, 85, 247, 0.2));
            opacity: 0;
            transition: opacity 0.3s;
            z-index: -1;
            filter: blur(8px);
        }

        .search-container:focus-within::before {
            opacity: 1;
        }

        .search-input {
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            width: 100%;
        }

        .search-input:focus {
            outline: none;
            transform: scale(1.02);
            box-shadow:
                0 0 0 4px rgba(139, 92, 246, 0.25),
                0 12px 40px rgba(139, 92, 246, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border-color: rgba(139, 92, 246, 0.6);
        }

        /* MONOCHROME CARD SURFACE - Pure Neutral */
        .card-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            /* Pure neutral zinc surface */
            background: #18181b;
            backdrop-filter: blur(16px);
            border: 1px solid #27272a;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.5);
            padding: 2.5rem !important;
        }

        @media (hover: hover) {
            .card-item:hover {
                transform: translateY(-2px);
                border-color: #3f3f46;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.7);
            }
        }

        .card-item:active {
            transform: scale(0.99);
            transition: all 0.1s;
        }

        @media (max-width: 768px) {
            .card-item {
                padding: 2rem !important;
            }

            .search-container {
                padding: 1.5rem !important;
            }

            .btn-interactive {
                min-height: 48px;
                padding: 0.875rem 1.5rem;
            }
        }

        /* é é¢åˆ‡æ› - ç°¡åŒ–å‹•ç•« */
        .page {
            display: none;
            animation: pageIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes pageIn {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* æ•¸å­—é¡¯ç¤º - æ¥µè‡´å„ªåŒ– - å¢å¤§å­—é«”æå‡æ˜“è®€æ€§ */
        .big-number {
            font-variant-numeric: tabular-nums;
            letter-spacing: -0.02em;
            font-weight: 900;
            text-shadow: 0 2px 20px rgba(139, 92, 246, 0.4);
            background: linear-gradient(135deg, #ffffff, rgba(255, 255, 255, 0.95));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transition: all 0.3s;
            /* æå‡æ˜“è®€æ€§ */
            line-height: 1.1;
        }

        /* HIGH CONTRAST DATA NUMBERS - Maximum Readability */
        .big-number {
            font-size: 6rem;
            font-weight: 900;
            line-height: 1;
            letter-spacing: -0.05em;
            font-variant-numeric: tabular-nums;
            /* Subtle depth shadow for clarity, no neon glow */
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        @media (max-width: 768px) {
            .big-number {
                font-size: 4.5rem;
            }
        }

        @media (max-width: 480px) {
            .big-number {
                font-size: 3.5rem;
            }
        }

        /* Header å¤§æ•¸å­— - å„ªåŒ–é¡¯ç¤ºèˆ‡å°æ¯”åº¦ */
        .header-big-number {
            font-size: 3.75rem;
            font-weight: 900;
            line-height: 1.1;
            letter-spacing: -0.03em;
            font-variant-numeric: tabular-nums;
            text-shadow: 0 0 24px rgba(139, 92, 246, 0.6),
                0 2px 8px rgba(0, 0, 0, 0.9);
        }

        @media (max-width: 640px) {
            .header-big-number {
                font-size: 2.75rem;
            }
        }

        @media (max-width: 480px) {
            .header-big-number {
                font-size: 2.25rem;
            }
        }

        .big-number.text-purple-400 {
            background: linear-gradient(135deg, #a78bfa, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 20px rgba(139, 92, 246, 0.4);
        }

        .big-number.text-cyan-400 {
            background: linear-gradient(135deg, #67e8f9, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 20px rgba(6, 182, 212, 0.4);
        }

        .big-number.text-yellow-400 {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 20px rgba(245, 158, 11, 0.4);
        }

        .big-number.text-green-400 {
            background: linear-gradient(135deg, #34d399, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 20px rgba(16, 185, 129, 0.4);
        }

        /* ç‹€æ…‹å¾½ç«  - æ”¹é€² */
        .status-badge {
            position: relative;
            overflow: hidden;
        }

        .status-badge.online::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 6px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
            }

            50% {
                opacity: 0.8;
                box-shadow: 0 0 0 6px rgba(34, 197, 94, 0);
            }
        }

        /* çµ±è¨ˆå¡ç‰‡ - ç°¡åŒ–ç‰¹æ•ˆ */
        .stat-card {
            position: relative;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }

        .stat-card:active {
            transform: translateY(0);
        }

        /* å®‰å…¨å€åŸŸé©é… */
        .safe-top {
            padding-top: max(env(safe-area-inset-top), 12px);
        }

        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* æ•ˆèƒ½å„ªåŒ– */
        .gpu-accelerated {
            transform: translateZ(0);
            will-change: transform;
        }

        /* ç„¡éšœç¤™æ”¹é€² - å…¨é¢å„ªåŒ– */
        .focus-visible:focus,
        button:focus-visible,
        input:focus-visible,
        [role="button"]:focus-visible {
            outline: 3px solid #8b5cf6;
            outline-offset: 3px;
            border-radius: 6px;
        }

        /* èªç¾©åŒ–æ¨™ç±¤æ¨£å¼ */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-weight: 700;
            line-height: 1.2;
        }

        /* æå‡æ–‡å­—å°æ¯”åº¦ - é€²ä¸€æ­¥å„ªåŒ–æ˜“è®€æ€§ */
        .text-gray-300 {
            color: #d4d4d8;
            /* æå‡å°æ¯”åº¦ */
        }

        .text-gray-400 {
            color: #b8b8c0;
            /* æå‡å°æ¯”åº¦ */
        }

        .text-gray-500 {
            color: #9ca3af;
            /* æå‡å°æ¯”åº¦ */
        }

        /* éŒ¯èª¤ç‹€æ…‹å°æ¯”åº¦å„ªåŒ– */
        .text-red-400 {
            color: #f87171;
            /* ç¢ºä¿å°æ¯”åº¦ */
        }

        /* æˆåŠŸç‹€æ…‹å°æ¯”åº¦å„ªåŒ– */
        .text-green-400 {
            color: #4ade80;
            /* ç¢ºä¿å°æ¯”åº¦ */
        }

        /* æ”¹å–„å¡ç‰‡å…§æ–‡å­—å°æ¯”åº¦ */
        .glass p,
        .glass span,
        .glass h3 {
            color: #f5f5f5;
        }

        .glass .text-gray-400 {
            color: #c4c4cc;
        }

        .glass .text-gray-500 {
            color: #a1a1aa;
        }

        /* å±å¹•é–±è®€å™¨å°ˆç”¨ */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* åŠ è¼‰ç‹€æ…‹å¯è¨ªå•æ€§ */
        [aria-busy="true"] {
            cursor: wait;
        }

        [aria-disabled="true"] {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* ç©ºç‹€æ…‹å„ªåŒ– */
        .empty-state {
            animation: fadeIn 0.5s ease-out;
        }

        /* æ“ä½œäººå“¡æŒ‰éˆ• */
        .operator-btn {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .operator-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(139, 92, 246, 0.4);
        }

        .operator-btn.active {
            box-shadow: 0 6px 24px rgba(139, 92, 246, 0.5);
        }

        .operator-select-btn {
            position: relative;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .operator-select-btn:hover {
            transform: translateY(-2px);
        }

        /* ç§»é™¤ ::before å½å…ƒç´ é¿å…é®æ“‹èƒŒæ™¯ */

        /* æ¼¸è®Šå‹•ç•« */
        @keyframes gradient {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        .animate-gradient {
            background-size: 200% 200%;
            animation: gradient 3s ease infinite;
        }

        /* æ•¸å­—å‹•ç•« */
        @keyframes numberPop {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        .number-update {
            animation: numberPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* å¯ç·¨è¼¯æ•¸å­—è¼¸å…¥æ¡† */
        .editable-number {
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            position: relative;
        }

        .editable-number:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .editable-number-input {
            background: rgba(139, 92, 246, 0.2);
            border: 2px solid rgba(139, 92, 246, 0.6);
            border-radius: 12px;
            padding: 8px 16px;
            text-align: center;
            font-size: inherit;
            font-weight: inherit;
            color: inherit;
            width: 100%;
            max-width: 200px;
            outline: none;
            font-family: inherit;
        }

        .editable-number-input:focus {
            background: rgba(139, 92, 246, 0.3);
            border-color: rgba(139, 92, 246, 0.8);
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.25);
        }

        /* åˆ—è¡¨é …ç›®é€²å…¥å‹•ç•« - ç°¡åŒ– */
        .list-item-enter {
            animation: listItemEnter 0.3s ease backwards;
        }

        @keyframes listItemEnter {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* å„ªåŒ–F22å» å€ç‰©æ–™åˆ—è¡¨ */
        .site-item {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .site-item:hover {
            transform: translateX(4px);
            background: rgba(255, 255, 255, 0.1) !important;
        }

        .site-item:active {
            transform: translateX(2px) scale(0.98);
        }

        /* å„ªåŒ–çµ±è¨ˆå¡ç‰‡æ¨™ç±¤ */
        .stat-label {
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        /* å„ªåŒ–åˆ†é¡çµ±è¨ˆæ¢ */
        .category-bar-item {
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }

        .category-bar-item::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: barShine 2s infinite;
        }

        @keyframes barShine {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }
    </style>
</head>

<body>
    <!-- ä¸‹æ‹‰åˆ·æ–°æŒ‡ç¤ºå™¨ -->
    <div id="pullToRefresh" class="pull-to-refresh" aria-hidden="true">
        <svg class="refresh-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
            <path d="M3 3v5h5" />
            <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16" />
            <path d="M16 21h5v-5" />
        </svg>
        <span class="ml-2 text-sm font-medium">ä¸‹æ‹‰åˆ·æ–°</span>
    </div>

    <!-- Toast å®¹å™¨ -->
    <div id="toastBox" class="toast-container" role="status" aria-live="polite" aria-atomic="true"></div>

    <!-- Bottom Sheet Overlay -->
    <div id="bottomSheetOverlay" class="bottom-sheet-overlay" onclick="closeBottomSheet();closeTransferInput();"
        role="button" aria-label="é—œé–‰è¦–çª—" tabindex="0"
        onkeydown="if(event.key==='Enter'||event.key===' '){closeBottomSheet();closeTransferInput();event.preventDefault();}">
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="relative min-h-screen pb-24 safe-bottom">

        <!-- SCROLLABLE HEADER - Scrolls with page to maximize list visibility -->
        <header id="header" class="relative z-40 safe-top bg-[#0A0A0B] border-b border-zinc-800" role="banner">
            <div class="px-6 py-6 relative">

                <!-- JUMBO Statistics - Monochrome with Functional Color for Status Only -->
                <div class="grid grid-cols-3 gap-8 mb-12">
                    <div class="text-center">
                        <p class="text-base text-gray-500 font-bold mb-6 tracking-widest uppercase">ç¸½å“é …</p>
                        <p id="headerTotalItems"
                            class="text-8xl md:text-9xl font-black text-white leading-none tabular-nums">-</p>
                    </div>
                    <div class="text-center">
                        <p class="text-base text-gray-500 font-bold mb-6 tracking-widest uppercase">F22å» å€</p>
                        <p id="headerSiteItems"
                            class="text-8xl md:text-9xl font-black text-cyan-400 leading-none tabular-nums">-</p>
                    </div>
                    <div class="text-center">
                        <p class="text-base text-gray-500 font-bold mb-6 tracking-widest uppercase">ä½åº«å­˜</p>
                        <p id="headerLowStock"
                            class="text-8xl md:text-9xl font-black text-yellow-400 leading-none tabular-nums">-</p>
                    </div>
                </div>

                <!-- Title Row - Pure Monochrome -->
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-4xl md:text-5xl font-black tracking-tight leading-tight text-gray-100">
                            ç‰©æ–™æˆ°æƒ…å®¤
                        </h1>
                        <p class="text-sm text-gray-600 font-medium tracking-wide mt-2">v19.1 Pro Edition</p>
                    </div>
                    <div id="statusBadge"
                        class="status-badge text-xs px-4 py-2.5 rounded-full bg-zinc-900 text-gray-400 border border-zinc-800 font-medium backdrop-blur-xl"
                        role="status" aria-live="polite" aria-atomic="true" title="ç¶²çµ¡é€£æ¥ç‹€æ…‹">
                        é€£ç·šä¸­...
                    </div>
                    <div id="syncIndicator" class="sync-indicator synced" style="opacity: 0;" aria-live="polite">
                        <span class="sync-icon">âœ“</span> å·²åŒæ­¥
                    </div>
                </div>

                <!-- Operator Badge - Only Functional Color Element -->
                <div class="flex items-center gap-4">
                    <span class="text-xs text-gray-600 font-medium tracking-wide uppercase">æ“ä½œäººå“¡</span>
                    <span id="headerOperator"
                        class="px-6 py-3 rounded-xl bg-purple-600 text-white font-bold border border-purple-500 text-base shadow-lg"
                        aria-label="ç•¶å‰æ“ä½œäººå“¡" role="status">é»ƒä¿Šç‘‹</span>
                </div>
            </div>
        </header>>

        <!-- Dashboard é é¢ -->
        <div id="page-dashboard" class="page active">
            <div class="px-5 py-6 space-y-6">
                <!-- æ™ºæ…§è£œè²¨å»ºè­°å¡ç‰‡ -->
                <div id="replenishCard"
                    class="bg-gradient-to-br from-yellow-900/30 to-orange-900/20 backdrop-blur-xl border border-yellow-600/30 shadow-2xl rounded-3xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">ğŸš¨</span>
                            <h3 class="text-lg font-bold text-yellow-300">æ™ºæ…§è£œè²¨å»ºè­°</h3>
                        </div>
                        <button id="copyPurchaseListBtn" onclick="copyPurchaseList()"
                            class="btn-interactive px-4 py-2 rounded-xl bg-yellow-600/30 text-yellow-300 text-sm font-bold border border-yellow-500/40 hover:bg-yellow-600/50 transition-all">
                            ğŸ“‹ è¤‡è£½æ¡è³¼æ¸…å–®
                        </button>
                    </div>
                    <div id="replenishList" class="space-y-3">
                        <!-- ç·Šæ€¥è£œè²¨æ¸…å–®å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                        <p class="text-gray-500 text-sm">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>





                <!-- åˆ†é¡çµ±è¨ˆæ¢ -->
                <div class="bg-zinc-900/70 backdrop-blur-xl border border-zinc-700/50 shadow-2xl rounded-3xl p-6">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="text-2xl">ğŸ“ˆ</span>
                        <h3 class="text-lg font-bold text-white">åˆ†é¡çµ±è¨ˆ</h3>
                        <span class="text-xs text-gray-500 ml-2">ï¼ˆé»æ“Šé¡åˆ¥å¯ç¯©é¸ï¼‰</span>
                    </div>
                    <div id="categoryBar" class="h-4 rounded-full bg-white/5 flex overflow-hidden mb-4"></div>
                    <div id="categoryLegend" class="flex flex-wrap gap-4 text-sm text-gray-300"></div>
                </div>

                <!-- å‘†æ»¯ç‰©æ–™è­¦ç¤º -->
                <div id="staleItemsCard"
                    class="hidden bg-gradient-to-br from-red-900/30 to-pink-900/20 backdrop-blur-xl border border-red-600/30 shadow-2xl rounded-3xl p-6">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="text-2xl">â°</span>
                        <h3 class="text-lg font-bold text-red-300">å‘†æ»¯ç‰©æ–™è­¦ç¤º</h3>
                        <span class="text-xs text-gray-500">ï¼ˆè¶…é 30 å¤©æœªè®Šå‹•ï¼‰</span>
                    </div>
                    <div id="staleItemsList" class="space-y-2 max-h-48 overflow-y-auto">
                    </div>
                </div>

                <!-- F22å» å€ç‰©æ–™æ¸…å–® -->
                <div class="bg-zinc-900/70 backdrop-blur-xl border border-zinc-700/50 shadow-2xl rounded-3xl p-6">
                    <div class="flex items-center justify-between mb-5">
                        <div class="flex items-center gap-2.5">
                            <span class="text-3xl">ğŸ—ï¸</span>
                            <h3 class="text-xl font-bold text-white">F22å» å€ç‰©æ–™</h3>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="siteFilterLabel" class="text-xs text-gray-500 hidden">ç¯©é¸ï¼š</span>
                            <span id="siteItemCount"
                                class="text-sm px-4 py-2 rounded-full bg-gradient-to-r from-cyan-500/30 to-cyan-400/20 text-cyan-300 font-bold border border-cyan-400/40 shadow-lg shadow-cyan-500/20">-</span>
                        </div>
                    </div>
                    <div id="siteItemsList" class="space-y-2.5 max-h-96 overflow-y-auto">
                        <!-- ç‰©æ–™é …ç›®å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                    <div id="siteItemsEmpty" class="hidden text-center py-12">
                        <div class="text-5xl mb-3 opacity-40">ğŸ“­</div>
                        <p class="text-gray-500 text-sm font-medium">F22å» å€æš«ç„¡ç‰©æ–™</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- List Page - Pure Monochrome -->
        <div id="page-list" class="page">
            <div class="px-6 py-6 space-y-8">
                <!-- FLOATING STICKY SEARCH BAR - Stays at top while scrolling -->
                <div
                    class="sticky top-0 z-50 -mx-6 px-6 py-4 bg-zinc-950/80 backdrop-blur-md border-b border-zinc-800/50 safe-top">
                    <!-- Monochrome Search Bar -->
                    <div class="search-container rounded-2xl p-5 min-h-[60px] bg-zinc-900 backdrop-blur-xl border border-zinc-800 shadow-lg mb-4"
                        role="search">
                        <label for="searchInput" class="sr-only">æœå°‹ç‰©æ–™</label>
                        <div class="flex items-center gap-4">
                            <svg class="w-6 h-6 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <input type="search" id="searchInput" placeholder="æœå°‹å“åã€è¦æ ¼ã€é€Ÿè¨˜ç¢¼..."
                                class="search-input flex-1 bg-transparent text-gray-100 placeholder-gray-600 text-lg font-bold focus:outline-none"
                                autocomplete="off" aria-label="æœå°‹ç‰©æ–™å“åæˆ–è¦æ ¼" aria-describedby="searchHint"
                                list="searchHistory">
                            <datalist id="searchHistory"></datalist>
                            <!-- Voice Search Button -->
                            <button id="voiceSearchBtn" onclick="startVoiceSearch()" type="button"
                                class="p-2 rounded-xl bg-zinc-800 hover:bg-zinc-700 text-gray-400 hover:text-white transition-all active:scale-95"
                                aria-label="èªéŸ³æœå°‹" title="èªéŸ³æœå°‹">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z">
                                    </path>
                                </svg>
                            </button>
                        </div>
                        <div id="searchHint" class="sr-only">è¼¸å…¥é—œéµå­—ä»¥æœå°‹ç‰©æ–™</div>
                        <div id="searchResultsCount" class="text-sm text-gray-600 mt-2 hidden"></div>
                    </div>

                    <!-- Compact Filter Chips -->
                    <div class="flex gap-3 overflow-x-auto pb-2 scrollbar-hide"
                        style="-webkit-overflow-scrolling: touch;" id="categoryChips" role="tablist"
                        aria-label="ç‰©æ–™åˆ†é¡ç¯©é¸">
                        <button
                            class="cat-chip active px-7 py-4 rounded-full text-base font-bold bg-purple-600 text-white border border-purple-500 min-h-[52px] whitespace-nowrap shadow-md"
                            data-cat="all" role="tab" aria-selected="true" aria-controls="inventoryList" tabindex="0">
                            <span>å…¨éƒ¨</span>
                        </button>
                        <button
                            class="cat-chip px-7 py-4 rounded-full text-base font-medium bg-zinc-900 text-gray-400 border border-zinc-800 min-h-[52px] whitespace-nowrap hover:bg-zinc-800 hover:text-gray-300 transition-all"
                            data-cat="wire" role="tab" aria-selected="false" aria-controls="inventoryList"
                            tabindex="-1">
                            <span>ğŸ”Œ é›»ç·š</span>
                        </button>
                        <button
                            class="cat-chip px-7 py-4 rounded-full text-base font-medium bg-zinc-900 text-gray-400 border border-zinc-800 min-h-[52px] whitespace-nowrap hover:bg-zinc-800 hover:text-gray-300 transition-all"
                            data-cat="terminal" role="tab" aria-selected="false" aria-controls="inventoryList"
                            tabindex="-1">
                            <span>ğŸ”— ç«¯å­</span>
                        </button>
                        <button
                            class="cat-chip px-7 py-4 rounded-full text-base font-medium bg-zinc-900 text-gray-400 border border-zinc-800 min-h-[52px] whitespace-nowrap hover:bg-zinc-800 hover:text-gray-300 transition-all"
                            data-cat="consumable" role="tab" aria-selected="false" aria-controls="inventoryList"
                            tabindex="-1">
                            <span>ğŸ“¦ è€—æ</span>
                        </button>
                        <button
                            class="cat-chip px-7 py-4 rounded-full text-base font-medium bg-zinc-900 text-gray-400 border border-zinc-800 min-h-[52px] whitespace-nowrap hover:bg-zinc-800 hover:text-gray-300 transition-all"
                            data-cat="pipe" role="tab" aria-selected="false" aria-controls="inventoryList"
                            tabindex="-1">
                            <span>ğŸ”© ç®¡æ</span>
                        </button>
                        <button
                            class="cat-chip px-7 py-4 rounded-full text-base font-medium bg-zinc-900 text-gray-400 border border-zinc-800 min-h-[52px] whitespace-nowrap hover:bg-zinc-800 hover:text-gray-300 transition-all"
                            data-cat="hardware" role="tab" aria-selected="false" aria-controls="inventoryList"
                            tabindex="-1">
                            <span>ğŸ”§ äº”é‡‘</span>
                        </button>
                    </div>
                </div>
                <!-- End of Floating Sticky Search Container -->

                <!-- æ‰¹é‡æ“ä½œæ¬„ - Outside of sticky container -->
                <div id="batchActions"
                    class="hidden bg-zinc-900/70 backdrop-blur-xl border border-zinc-700/50 shadow-2xl rounded-2xl p-5 mb-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-base font-bold text-white">å·²é¸æ“‡ <span id="selectedCount">0</span>
                                é …</span>
                            <button onclick="clearSelection()"
                                class="text-sm text-gray-300 hover:text-white font-semibold">æ¸…é™¤</button>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="batchAdjust('w', 1)"
                                class="btn-interactive px-5 py-2.5 rounded-xl bg-purple-600/20 text-purple-300 text-base font-bold border border-purple-500/40">å…¬å¸å€‰
                                +1</button>
                            <button onclick="batchAdjust('s', 1)"
                                class="btn-interactive px-5 py-2.5 rounded-xl bg-cyan-600/20 text-cyan-300 text-base font-bold border border-cyan-500/40">F22å» å€
                                +1</button>
                        </div>
                    </div>
                </div>

                <!-- COMPACT Inventory Cards with Dense Spacing -->
                <div id="inventoryList" class="space-y-3" role="list" aria-label="ç‰©æ–™åˆ—è¡¨"></div>

                <!-- ç©ºç‹€æ…‹ -->
                <div id="emptyState" class="hidden empty-state text-center py-24" role="status" aria-live="polite">
                    <div class="text-8xl mb-6 opacity-40 filter drop-shadow-2xl" aria-hidden="true">ğŸ“­</div>
                    <p class="text-gray-400 text-lg font-bold mb-2">æ‰¾ä¸åˆ°ç¬¦åˆçš„å“é …</p>
                    <p class="text-gray-600 text-sm font-medium">å˜—è©¦èª¿æ•´ç¯©é¸æ¢ä»¶æˆ–æœå°‹é—œéµå­—</p>
                </div>
            </div>
        </div>

        <!-- Settings é é¢ -->
        <div id="page-settings" class="page">
            <div class="px-5 py-5 space-y-4">
                <div
                    class="bg-zinc-950/90 backdrop-blur-2xl border border-zinc-700/60 shadow-[0_16px_48px_rgba(0,0,0,0.8)] rounded-3xl p-6">
                    <h3 class="text-lg font-extrabold text-white mb-6 flex items-center gap-2">
                        <span>âš™ï¸</span>
                        <span>ç³»çµ±è¨­å®š</span>
                    </h3>
                    <div class="space-y-3">
                        <button id="exportBtn"
                            class="btn-interactive w-full flex items-center justify-between p-5 rounded-2xl bg-white/5 hover:bg-white/10 transition border-2 border-white/10 hover:border-white/20"
                            aria-label="åŒ¯å‡º CSV æª”æ¡ˆ">
                            <div class="flex items-center gap-4">
                                <span class="text-3xl" aria-hidden="true">ğŸ“¥</span>
                                <span class="text-base font-bold text-white">åŒ¯å‡º CSV</span>
                            </div>
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                        <button id="refreshBtn"
                            class="btn-interactive w-full flex items-center justify-between p-5 rounded-2xl bg-white/5 hover:bg-white/10 transition border-2 border-white/10 hover:border-white/20"
                            aria-label="é‡æ–°è¼‰å…¥è³‡æ–™">
                            <div class="flex items-center gap-4">
                                <span class="text-3xl" aria-hidden="true">ğŸ”„</span>
                                <span class="text-base font-bold text-white">é‡æ–°è¼‰å…¥</span>
                            </div>
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="bg-zinc-900/70 backdrop-blur-xl border border-zinc-700/50 shadow-2xl rounded-3xl p-6">
                    <h3 class="text-lg font-extrabold text-white mb-5 flex items-center gap-2">
                        <span>ğŸ‘¤</span>
                        <span>ç›®å‰æ“ä½œäººå“¡</span>
                    </h3>
                    <div id="operatorSelector" class="flex flex-col gap-3"></div>
                </div>

                <!-- PWA å®‰è£é¸é …ï¼ˆå¯é¸ï¼Œä¸å¼·åˆ¶ï¼‰ -->
                <div id="pwaInstallSection"
                    class="bg-zinc-900/70 backdrop-blur-xl border border-zinc-700/50 shadow-2xl rounded-3xl p-6 hidden">
                    <h3 class="text-lg font-extrabold text-white mb-5 flex items-center gap-2">
                        <span>ğŸ“±</span>
                        <span>å®‰è£åˆ°æ‰‹æ©Ÿ</span>
                    </h3>
                    <p class="text-sm text-gray-400 mb-4 leading-relaxed">
                        å¯é¸åŠŸèƒ½ï¼šå°‡æ‡‰ç”¨å®‰è£åˆ°ä¸»å±å¹•ï¼Œåƒ App ä¸€æ¨£ä½¿ç”¨ã€‚<br>
                        <span class="text-gray-500 text-xs">ä¸å½±éŸ¿ç¶²é æ­£å¸¸ä½¿ç”¨ï¼Œå¯éš¨æ™‚å¸è¼‰</span>
                    </p>
                    <button onclick="installPWA()"
                        class="btn-interactive w-full flex items-center justify-center gap-3 p-5 rounded-2xl bg-gradient-to-r from-purple-600 to-purple-500 hover:from-purple-700 hover:to-purple-600 text-white font-extrabold shadow-xl shadow-purple-600/30">
                        <span class="text-2xl">ğŸ“²</span>
                        <span>å®‰è£åˆ°ä¸»å±å¹•</span>
                    </button>
                </div>

                <div class="bg-zinc-900/70 backdrop-blur-xl border border-zinc-700/50 shadow-2xl rounded-3xl p-6">
                    <h3 class="text-lg font-extrabold text-white mb-5 flex items-center gap-2">
                        <span>â„¹ï¸</span>
                        <span>é—œæ–¼</span>
                    </h3>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between items-center py-2 border-b border-white/5">
                            <span class="text-gray-400 font-semibold">ç‰ˆæœ¬</span>
                            <span class="text-white font-extrabold">v19.1 Pro</span>
                        </div>
                        <div class="flex justify-between items-center py-2">
                            <span class="text-gray-400 font-semibold">å·²è¼‰å…¥å“é …</span>
                            <span class="text-white font-extrabold" id="settingsItemCount">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading ç‹€æ…‹ - Skeleton Loader -->
        <div id="loadingState" class="fixed inset-0 z-50 bg-zinc-950 overflow-auto p-6 safe-top" role="status"
            aria-live="polite" aria-busy="true" aria-label="è¼‰å…¥è³‡æ–™ä¸­">

            <!-- Skeleton Header -->
            <div class="mb-6 animate-pulse">
                <div class="h-8 w-32 bg-zinc-800 rounded-lg mb-2"></div>
                <div class="h-4 w-24 bg-zinc-800/50 rounded"></div>
            </div>

            <!-- Skeleton Search Bar -->
            <div class="h-14 w-full bg-zinc-800 rounded-2xl mb-4 animate-pulse"></div>

            <!-- Skeleton Category Chips -->
            <div class="flex gap-3 mb-6 animate-pulse">
                <div class="h-10 w-16 bg-zinc-800 rounded-full"></div>
                <div class="h-10 w-20 bg-zinc-800/70 rounded-full"></div>
                <div class="h-10 w-20 bg-zinc-800/50 rounded-full"></div>
            </div>

            <!-- Skeleton Cards (mimics compact list layout) -->
            <div class="space-y-3">
                <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-4 animate-pulse">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-zinc-700 rounded-lg"></div>
                        <div class="flex-1">
                            <div class="h-5 w-24 bg-zinc-700 rounded mb-2"></div>
                            <div class="h-3 w-32 bg-zinc-800 rounded"></div>
                        </div>
                        <div class="h-8 w-12 bg-zinc-700 rounded"></div>
                    </div>
                </div>
                <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-4 animate-pulse"
                    style="animation-delay: 0.1s">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-zinc-700 rounded-lg"></div>
                        <div class="flex-1">
                            <div class="h-5 w-28 bg-zinc-700 rounded mb-2"></div>
                            <div class="h-3 w-36 bg-zinc-800 rounded"></div>
                        </div>
                        <div class="h-8 w-10 bg-zinc-700 rounded"></div>
                    </div>
                </div>
                <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-4 animate-pulse"
                    style="animation-delay: 0.2s">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-zinc-700 rounded-lg"></div>
                        <div class="flex-1">
                            <div class="h-5 w-20 bg-zinc-700 rounded mb-2"></div>
                            <div class="h-3 w-28 bg-zinc-800 rounded"></div>
                        </div>
                        <div class="h-8 w-14 bg-zinc-700 rounded"></div>
                    </div>
                </div>
                <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-4 animate-pulse"
                    style="animation-delay: 0.3s">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 bg-zinc-700 rounded-lg"></div>
                        <div class="flex-1">
                            <div class="h-5 w-32 bg-zinc-700 rounded mb-2"></div>
                            <div class="h-3 w-40 bg-zinc-800 rounded"></div>
                        </div>
                        <div class="h-8 w-12 bg-zinc-700 rounded"></div>
                    </div>
                </div>
            </div>

            <!-- Loading Text -->
            <p class="text-center text-gray-500 mt-8 text-sm font-medium">
                <span class="inline-block animate-pulse">è¼‰å…¥è³‡æ–™ä¸­...</span>
            </p>
            <p id="loadingTimer" class="text-center text-gray-600 text-xs mt-2" aria-live="polite"></p>
        </div>

        <!-- Error ç‹€æ…‹ -->
        <div id="errorState" class="hidden fixed inset-0 z-50 flex items-center justify-center p-6" role="alert"
            aria-live="assertive">
            <div
                class="bg-zinc-950/90 backdrop-blur-2xl border border-zinc-700/60 shadow-[0_16px_48px_rgba(0,0,0,0.8)] rounded-3xl p-10 text-center max-w-sm w-full relative overflow-hidden">
                <div class="absolute top-0 right-0 w-64 h-64 bg-red-500/10 rounded-full blur-3xl" aria-hidden="true">
                </div>
                <div class="relative z-10">
                    <div class="text-7xl mb-6 filter drop-shadow-2xl" aria-hidden="true">âš ï¸</div>
                    <h3 class="text-2xl font-extrabold text-red-400 mb-4">è¼‰å…¥å¤±æ•—</h3>
                    <p id="errorMsg" class="text-sm text-gray-400 mb-10 leading-relaxed font-medium"></p>
                    <button id="retryBtn"
                        class="btn-interactive bg-gradient-to-r from-red-600 to-red-500 hover:from-red-700 hover:to-red-600 text-white px-10 py-5 rounded-2xl font-extrabold w-full transition shadow-xl shadow-red-600/30"
                        aria-label="é‡æ–°é€£ç·šè¼‰å…¥è³‡æ–™">
                        ğŸ”„ é‡æ–°é€£ç·š
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Sheet (ç›¤é»è¦–çª—) -->
    <div id="bottomSheet" class="bottom-sheet" role="dialog" aria-modal="true" aria-labelledby="bottomSheetTitle"
        aria-hidden="true">
        <div class="bottom-sheet-handle" aria-hidden="true"></div>
        <div class="px-6 pb-6 overflow-y-auto" style="max-height: calc(85vh - 60px);">
            <div id="bottomSheetContent"></div>
        </div>
    </div>

    <!-- è½‰ç§»æ•¸é‡è¼¸å…¥æ¡† (æ‰‹æ©Ÿå‹å–„) -->
    <div id="transferInputSheet" class="bottom-sheet" role="dialog" aria-modal="true"
        aria-labelledby="transferInputTitle" aria-hidden="true">
        <div class="bottom-sheet-handle" aria-hidden="true"></div>
        <div class="px-6 pb-6">
            <div id="transferInputContent"></div>
        </div>
    </div>

    <!-- åº•éƒ¨å°èˆª -->
    <nav class="bottom-nav" role="navigation" aria-label="ä¸»è¦å°èˆª">
        <div class="flex justify-around items-center py-3 px-3">
            <button onclick="switchPage('dashboard')"
                class="nav-item active flex flex-col items-center gap-1.5 px-5 py-2.5 rounded-2xl" data-page="dashboard"
                aria-label="ç¸½è¦½é é¢" aria-current="page">
                <span class="nav-icon text-2xl transition-all" aria-hidden="true">ğŸ </span>
                <span class="text-[10px] font-bold tracking-wide">ç¸½è¦½</span>
            </button>
            <button onclick="switchPage('list')"
                class="nav-item flex flex-col items-center gap-1.5 px-5 py-2.5 rounded-2xl" data-page="list"
                aria-label="åˆ—è¡¨é é¢">
                <span class="nav-icon text-2xl transition-all" aria-hidden="true">ğŸ“¦</span>
                <span class="text-[10px] font-bold tracking-wide">åˆ—è¡¨</span>
            </button>
            <button onclick="switchPage('settings')"
                class="nav-item flex flex-col items-center gap-1.5 px-5 py-2.5 rounded-2xl" data-page="settings"
                aria-label="è¨­å®šé é¢">
                <span class="nav-icon text-2xl transition-all" aria-hidden="true">âš™ï¸</span>
                <span class="text-[10px] font-bold tracking-wide">è¨­å®š</span>
            </button>
        </div>
    </nav>

    <script>
            (function () {
                'use strict';

                // ===== è¨­å®š =====
                var API_PRIMARY = 'https://script.google.com/macros/s/AKfycbwxhdsphlO2wdnHuxElY4oRcenbv4MLqE-ZhCvcQNDGljvExzgFtyZFS3EQ4cBG2uq1/exec';
                var API_BACKUP = API_PRIMARY;
                var TIMEOUT = 20000;
                var DEBOUNCE_DELAY = 600;

                // ===== ç‹€æ…‹ç®¡ç† =====
                var state = {
                    stock: [],
                    filtered: [],
                    category: 'all',
                    searchText: '',
                    currentPage: 'dashboard',
                    currentItem: null,
                    isLoading: false,
                    updateTimers: {},
                    currentOperator: 'é»ƒä¿Šç‘‹', // é è¨­æ“ä½œäººå“¡
                    pendingUpdates: {}, // å¾…åŒæ­¥çš„æ“ä½œï¼ˆç”¨æ–¼éŒ¯èª¤æ¢å¾©ï¼‰
                    isOnline: navigator.onLine, // ç¶²çµ¡ç‹€æ…‹
                    selectedItems: [], // æ‰¹é‡é¸æ“‡çš„ç‰©æ–™
                    searchHistory: [], // æœç´¢æ­·å²
                    operationHistory: [], // æ“ä½œæ­·å²ï¼ˆæœ¬åœ°ç·©å­˜ï¼‰
                    editingNumber: null // ç•¶å‰æ­£åœ¨ç·¨è¼¯çš„æ•¸å­—ï¼ˆé˜²æ­¢é‡è¤‡ç·¨è¼¯ï¼‰
                };

                // æ“ä½œäººå“¡æ¸…å–®
                var OPERATORS = ['é»ƒä¿Šç‘‹', 'æˆ´åº­å®‡', 'å¾ä¼Šæ©'];



                // Fuse.js instance for fuzzy search
                var fuseInstance = null;

                // ApexCharts instance for modern charts
                var apexChartInstance = null;

                // ===== Day.js åˆå§‹åŒ–ï¼ˆä¸­æ–‡æ”¯æ´ï¼‰=====
                if (typeof dayjs !== 'undefined') {
                    dayjs.locale('zh-tw');
                    if (typeof dayjs_plugin_relativeTime !== 'undefined') {
                        dayjs.extend(dayjs_plugin_relativeTime);
                    }
                }

                // æ ¼å¼åŒ–ç›¸å°æ™‚é–“
                function formatRelativeTime(date) {
                    if (typeof dayjs !== 'undefined' && date) {
                        return dayjs(date).fromNow();
                    }
                    return '';
                }

                // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“
                function formatDateTime(date, format) {
                    if (typeof dayjs !== 'undefined' && date) {
                        return dayjs(date).format(format || 'YYYY/MM/DD HH:mm');
                    }
                    return '';
                }

                // ===== è§¸è¦ºå›é¥‹ (Haptic Feedback) =====
                function hapticFeedback(type) {
                    if (!navigator.vibrate) return;

                    switch (type) {
                        case 'light':
                            navigator.vibrate(10);
                            break;
                        case 'medium':
                            navigator.vibrate(20);
                            break;
                        case 'heavy':
                            navigator.vibrate(30);
                            break;
                        case 'success':
                            navigator.vibrate([10, 50, 10]);
                            break;
                        case 'error':
                            navigator.vibrate([30, 50, 30, 50, 30]);
                            break;
                        case 'warning':
                            navigator.vibrate([20, 30, 20]);
                            break;
                        default:
                            navigator.vibrate(15);
                    }
                }

                // ===== åŒæ­¥ç‹€æ…‹ç®¡ç† =====
                var syncState = {
                    isSyncing: false,
                    pendingCount: 0,
                    lastSyncTime: null
                };

                function updateSyncIndicator() {
                    var indicator = document.getElementById('syncIndicator');
                    if (!indicator) return;

                    syncState.pendingCount = Object.keys(state.pendingUpdates).length;

                    if (!state.isOnline) {
                        indicator.className = 'sync-indicator offline';
                        indicator.innerHTML = '<span class="sync-icon">âš¡</span> é›¢ç·š';
                    } else if (syncState.isSyncing) {
                        indicator.className = 'sync-indicator syncing';
                        indicator.innerHTML = '<span class="sync-icon">âŸ³</span> åŒæ­¥ä¸­';
                    } else if (syncState.pendingCount > 0) {
                        indicator.className = 'sync-indicator pending';
                        indicator.innerHTML = '<span class="sync-icon">â³</span> å¾…åŒæ­¥ (' + syncState.pendingCount + ')';
                    } else {
                        indicator.className = 'sync-indicator synced';
                        indicator.innerHTML = '<span class="sync-icon">âœ“</span> å·²åŒæ­¥';
                        // 3ç§’å¾Œéš±è—
                        setTimeout(function () {
                            if (syncState.pendingCount === 0 && !syncState.isSyncing) {
                                indicator.style.opacity = '0';
                            }
                        }, 3000);
                    }
                    indicator.style.opacity = '1';
                }

                // ===== ä¸‹æ‹‰åˆ·æ–° (Pull-to-Refresh) =====
                var pullState = {
                    startY: 0,
                    currentY: 0,
                    pulling: false,
                    threshold: 80
                };

                function initPullToRefresh() {
                    var container = document.getElementById('inventoryPage');
                    if (!container) return;

                    container.addEventListener('touchstart', function (e) {
                        if (window.scrollY === 0) {
                            pullState.startY = e.touches[0].clientY;
                            pullState.pulling = true;
                        }
                    }, { passive: true });

                    container.addEventListener('touchmove', function (e) {
                        if (!pullState.pulling) return;

                        pullState.currentY = e.touches[0].clientY;
                        var pullDistance = pullState.currentY - pullState.startY;

                        if (pullDistance > 0 && window.scrollY === 0) {
                            var pullIndicator = document.getElementById('pullToRefresh');
                            if (pullIndicator) {
                                var progress = Math.min(pullDistance / pullState.threshold, 1);
                                pullIndicator.style.transform = 'translateY(' + (progress * 60 - 60) + 'px)';

                                if (pullDistance > pullState.threshold) {
                                    pullIndicator.classList.add('active');
                                }
                            }
                        }
                    }, { passive: true });

                    container.addEventListener('touchend', function () {
                        if (!pullState.pulling) return;

                        var pullDistance = pullState.currentY - pullState.startY;
                        var pullIndicator = document.getElementById('pullToRefresh');

                        if (pullDistance > pullState.threshold) {
                            // è§¸ç™¼åˆ·æ–°
                            hapticFeedback('medium');
                            if (pullIndicator) {
                                pullIndicator.classList.add('refreshing');
                            }
                            loadData(true).finally(function () {
                                if (pullIndicator) {
                                    pullIndicator.classList.remove('active', 'refreshing');
                                    pullIndicator.style.transform = '';
                                }
                            });
                        } else {
                            if (pullIndicator) {
                                pullIndicator.classList.remove('active');
                                pullIndicator.style.transform = '';
                            }
                        }

                        pullState.pulling = false;
                        pullState.startY = 0;
                        pullState.currentY = 0;
                    }, { passive: true });
                }

                // ===== DOM ç·©å­˜ =====
                var el = {};

                function $(id) { return document.getElementById(id); }

                function initDOM() {
                    el.statusBadge = $('statusBadge');
                    el.searchInput = $('searchInput');
                    el.exportBtn = $('exportBtn');
                    el.refreshBtn = $('refreshBtn');
                    el.categoryChips = $('categoryChips');
                    el.categoryBar = $('categoryBar');
                    el.categoryLegend = $('categoryLegend');
                    el.loadingState = $('loadingState');
                    el.loadingTimer = $('loadingTimer');
                    el.errorState = $('errorState');
                    el.errorMsg = $('errorMsg');
                    el.retryBtn = $('retryBtn');
                    el.inventoryList = $('inventoryList');
                    el.emptyState = $('emptyState');
                    el.toastBox = $('toastBox');
                    el.bottomSheet = $('bottomSheet');
                    el.bottomSheetOverlay = $('bottomSheetOverlay');
                    el.bottomSheetContent = $('bottomSheetContent');
                    el.transferInputSheet = $('transferInputSheet');
                    el.transferInputContent = $('transferInputContent');
                    el.header = $('header');
                    el.settingsItemCount = $('settingsItemCount');
                    el.siteItemCount = $('siteItemCount');
                    el.siteItemsList = $('siteItemsList');
                    el.siteItemsEmpty = $('siteItemsEmpty');
                }

                // ===== å·¥å…·å‡½æ•¸ =====
                function safeNum(v, d) {
                    var n = Number(v);
                    return isNaN(n) ? (d || 0) : n;
                }

                function safeStr(v, d) {
                    return (v === undefined || v === null || v === '') ? (d || '') : String(v);
                }

                function formatNumber(num) {
                    // å¦‚æœæ˜¯å°æ•¸ï¼Œä¿ç•™ä¸€ä½å°æ•¸ï¼Œå¦å‰‡é¡¯ç¤ºæ•´æ•¸
                    return num % 1 === 0 ? num : num.toFixed(1);
                }

                function escapeHtml(str) {
                    var div = document.createElement('div');
                    div.textContent = str;
                    return div.innerHTML;
                }

                function debounce(func, delay) {
                    var timeoutId;
                    return function () {
                        var context = this;
                        var args = arguments;
                        clearTimeout(timeoutId);
                        timeoutId = setTimeout(function () {
                            func.apply(context, args);
                        }, delay);
                    };
                }

                // å„ªåŒ–ï¼šçµ±ä¸€çš„ç‰©æ–™æŸ¥æ‰¾å‡½æ•¸
                function findItemById(id) {
                    if (state.currentItem && state.currentItem.id == id) {
                        return state.currentItem;
                    }
                    for (var i = 0; i < state.stock.length; i++) {
                        if (state.stock[i].id == id) {
                            return state.stock[i];
                        }
                    }
                    return null;
                }

                // å„ªåŒ–ï¼šçµ±ä¸€çš„ UI æ›´æ–°å‡½æ•¸
                function updateNumberDisplay(id, type, value, isBottomSheet) {
                    var elementId = (isBottomSheet ? 'bs-' : '') + (type === 'w' ? 'w-' : 's-') + id;
                    var el = document.getElementById(elementId);
                    if (el && el.tagName !== 'INPUT') {
                        // å¦‚æœæ˜¯å°æ•¸ï¼Œä¿ç•™ä¸€ä½å°æ•¸ï¼Œå¦å‰‡é¡¯ç¤ºæ•´æ•¸
                        var displayValue = value % 1 === 0 ? value : value.toFixed(1);
                        el.textContent = displayValue;
                        el.classList.add('number-update');
                        setTimeout(function () {
                            if (el) el.classList.remove('number-update');
                        }, 400);
                    }
                }

                // ===== åˆ†é¡é‚è¼¯ - å„ªåŒ–ï¼ˆä½¿ç”¨ Lucide Iconsï¼‰=====
                // Lucide SVG åœ–æ¨™æ¨¡æ¿
                function lucideIcon(name, color, size) {
                    size = size || 24;
                    color = color || 'currentColor';
                    var icons = {
                        'cable': '<svg xmlns="http://www.w3.org/2000/svg" width="' + size + '" height="' + size + '" viewBox="0 0 24 24" fill="none" stroke="' + color + '" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a1 1 0 0 1-1-1v-1a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v1a1 1 0 0 1-1 1"/><path d="M19 15V6.5a1 1 0 0 0-7 0v11a1 1 0 0 1-7 0V9"/><path d="M21 21v-2h-4"/><path d="M3 5h4V3"/><path d="M7 5a1 1 0 0 1 1 1v1a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a1 1 0 0 1 1-1Z"/></svg>',
                        'link': '<svg xmlns="http://www.w3.org/2000/svg" width="' + size + '" height="' + size + '" viewBox="0 0 24 24" fill="none" stroke="' + color + '" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>',
                        'package': '<svg xmlns="http://www.w3.org/2000/svg" width="' + size + '" height="' + size + '" viewBox="0 0 24 24" fill="none" stroke="' + color + '" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>',
                        'cylinder': '<svg xmlns="http://www.w3.org/2000/svg" width="' + size + '" height="' + size + '" viewBox="0 0 24 24" fill="none" stroke="' + color + '" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5v14a9 3 0 0 0 18 0V5"/></svg>',
                        'wrench': '<svg xmlns="http://www.w3.org/2000/svg" width="' + size + '" height="' + size + '" viewBox="0 0 24 24" fill="none" stroke="' + color + '" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>'
                    };
                    return icons[name] || icons['package'];
                }

                var categoryConfig = {
                    wire: {
                        keywords: ['é›»ç·š', 'é›»çºœ', 'cable', 'wire', 'XIPE', 'CSA', 'ç´°çºœ', 'ç´°èŠ¯',
                            'æ§åˆ¶é›»çºœ', 'PVCé›»ç·š', 'å°ç·š', 'ç·šæ'],
                        iconName: 'cable',
                        icon: 'ğŸ”Œ',
                        label: 'é›»ç·š',
                        color: '#8b5cf6'
                    },
                    terminal: { keywords: ['ç«¯å­', 'terminal'], iconName: 'link', icon: 'ğŸ”—', label: 'ç«¯å­', color: '#06b6d4' },
                    consumable: {
                        keywords: ['æ‰ç·šå¸¶', 'ç´®ç·šå¸¶', 'æŸç·šå¸¶', 'è† å¸¶', 'è† å¸ƒ', 'çµ•ç·£è† å¸¶', 'é›»ç«å¸ƒ',
                            'è€—æ', 'consumable', 'tape', 'æ¨™ç±¤', 'æ¨™ç¤º', 'è²¼ç´™'],
                        iconName: 'package',
                        icon: 'ğŸ“¦',
                        label: 'è€—æ',
                        color: '#ec4899'
                    },
                    pipe: { keywords: ['ç®¡', 'pipe', 'é…ç®¡'], iconName: 'cylinder', icon: 'ğŸ”©', label: 'ç®¡æ', color: '#10b981' },
                    hardware: { keywords: [], iconName: 'wrench', icon: 'ğŸ”§', label: 'äº”é‡‘', color: '#6366f1' }
                };

                function getCategory(item) {
                    var s = (safeStr(item.name) + safeStr(item.spec)).toLowerCase();
                    for (var cat in categoryConfig) {
                        var keywords = categoryConfig[cat].keywords;
                        for (var i = 0; i < keywords.length; i++) {
                            if (s.indexOf(keywords[i]) >= 0) return cat;
                        }
                    }
                    return 'hardware';
                }

                function getCategoryIcon(cat, useSvg) {
                    var config = categoryConfig[cat] || categoryConfig.hardware;
                    if (useSvg) {
                        return '<span class="inline-flex items-center justify-center w-10 h-10 rounded-xl bg-white/5 border border-white/10">' +
                            lucideIcon(config.iconName, config.color, 20) + '</span>';
                    }
                    return config.icon;
                }

                // ===== UI ç‹€æ…‹ç®¡ç† =====
                function setStatus(type, text) {
                    var colors = {
                        loading: 'bg-white/5 text-gray-400 border-white/10',
                        online: 'bg-green-900/20 text-green-400 border-green-700/30 online',
                        error: 'bg-red-900/20 text-red-400 border-red-700/30'
                    };
                    el.statusBadge.className = 'status-badge text-xs px-4 py-2 rounded-full border font-medium transition-all ' + (colors[type] || colors.loading);
                    el.statusBadge.textContent = text;
                }

                function showLoading() {
                    state.isLoading = true;
                    el.loadingState.classList.remove('hidden');
                    el.loadingState.setAttribute('aria-busy', 'true');
                    el.errorState.classList.add('hidden');
                    setStatus('loading', 'é€£ç·šä¸­...');
                }

                function showError(msg) {
                    state.isLoading = false;
                    el.loadingState.classList.add('hidden');
                    el.errorState.classList.remove('hidden');
                    el.errorMsg.textContent = msg;
                    setStatus('error', 'é€£ç·šå¤±æ•—');
                }

                function showContent() {
                    state.isLoading = false;
                    el.loadingState.classList.add('hidden');
                    el.loadingState.setAttribute('aria-busy', 'false');
                    el.errorState.classList.add('hidden');
                    setStatus('online', 'ç·šä¸Š');
                }

                function toast(msg, type) {
                    type = type || 'info';
                    var icons = {
                        success: 'success',
                        error: 'error',
                        info: 'info',
                        warning: 'warning'
                    };

                    // Use SweetAlert2 Toast
                    Swal.fire({
                        toast: true,
                        position: 'top',
                        icon: icons[type] || 'info',
                        title: msg,
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true,
                        customClass: {
                            popup: 'text-lg',
                            title: 'text-lg font-bold'
                        },
                        didOpen: function (toast) {
                            toast.addEventListener('mouseenter', Swal.stopTimer);
                            toast.addEventListener('mouseleave', Swal.resumeTimer);
                        }
                    });
                }

                // ===== Voice Search (webkitSpeechRecognition) =====
                function startVoiceSearch() {
                    var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

                    if (!SpeechRecognition) {
                        toast('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³æœå°‹', 'warning');
                        return;
                    }

                    var recognition = new SpeechRecognition();
                    recognition.lang = 'zh-TW';
                    recognition.continuous = false;
                    recognition.interimResults = false;

                    var voiceBtn = document.getElementById('voiceSearchBtn');

                    recognition.onstart = function () {
                        if (voiceBtn) {
                            voiceBtn.classList.add('bg-red-600', 'text-white', 'animate-pulse');
                            voiceBtn.classList.remove('bg-zinc-800', 'text-gray-400');
                        }
                        toast('ğŸ¤ æ­£åœ¨è†è½...', 'info');
                    };

                    recognition.onresult = function (event) {
                        var transcript = event.results[0][0].transcript;
                        if (el.searchInput) {
                            el.searchInput.value = transcript;
                            state.searchText = transcript;
                            applyFiltersDebounced();
                            toast('ğŸ¤ æœå°‹ï¼š' + transcript, 'success');
                        }
                    };

                    recognition.onerror = function (event) {
                        toast('èªéŸ³è­˜åˆ¥å¤±æ•—ï¼š' + event.error, 'error');
                    };

                    recognition.onend = function () {
                        if (voiceBtn) {
                            voiceBtn.classList.remove('bg-red-600', 'text-white', 'animate-pulse');
                            voiceBtn.classList.add('bg-zinc-800', 'text-gray-400');
                        }
                    };

                    recognition.start();
                }

                // ===== Optimistic UI: Green Flash Animation =====
                function flashGreen(element) {
                    if (!element) return;
                    element.classList.add('bg-green-500/30');
                    element.style.transition = 'background-color 0.3s ease';
                    setTimeout(function () {
                        element.classList.remove('bg-green-500/30');
                    }, 500);
                }

                function switchPage(page) {
                    if (state.currentPage === page) return;

                    state.currentPage = page;

                    // æ›´æ–°é é¢é¡¯ç¤º
                    var pages = document.querySelectorAll('.page');
                    pages.forEach(function (p) {
                        p.classList.remove('active');
                    });
                    $('page-' + page).classList.add('active');

                    // æ›´æ–°å°èˆªç‹€æ…‹
                    var navItems = document.querySelectorAll('.nav-item');
                    navItems.forEach(function (item) {
                        item.classList.remove('active');
                    });
                    var activeNav = document.querySelector('[data-page="' + page + '"]');
                    if (activeNav) activeNav.classList.add('active');

                    // é¡¯ç¤º/éš±è— Header
                    el.header.style.display = (page === 'dashboard') ? 'block' : 'none';

                    // å¦‚æœåˆ‡æ›åˆ°è¨­å®šé ï¼Œæ¸²æŸ“æ“ä½œäººå“¡é¸æ“‡å™¨å’Œ PWA å®‰è£é¸é …
                    if (page === 'settings') {
                        renderOperatorSelector();
                        renderOperationHistory();
                        // å»¶é²ä¸€ä¸‹ç¢ºä¿ DOM å·²æ¸²æŸ“
                        setTimeout(function () {
                            updatePWAInstallSection();
                            updateAppMode();
                        }, 100);
                    }

                    // é—œé–‰ Bottom Sheet
                    closeBottomSheet();

                    // æ›´æ–° URLï¼ˆä¸åˆ·æ–°é é¢ï¼‰
                    if (history.pushState) {
                        var newUrl = window.location.pathname + (page === 'dashboard' ? '' : '?page=' + page);
                        window.history.pushState({ page: page }, '', newUrl);
                    }
                }

                // è™•ç† URL åƒæ•¸ï¼ˆPWA shortcuts æ”¯æŒï¼‰
                function handleURLParams() {
                    var urlParams = new URLSearchParams(window.location.search);
                    var page = urlParams.get('page');
                    if (page && (page === 'dashboard' || page === 'list' || page === 'settings')) {
                        switchPage(page);
                    }
                }

                // è™•ç†ç€è¦½å™¨è¿”å›æŒ‰éˆ•
                window.addEventListener('popstate', function (event) {
                    if (event.state && event.state.page) {
                        switchPage(event.state.page);
                    } else {
                        switchPage('dashboard');
                    }
                });

                function renderOperatorSelector() {
                    var container = document.getElementById('operatorSelector');
                    if (!container) return;

                    var html = '';
                    for (var i = 0; i < OPERATORS.length; i++) {
                        var op = OPERATORS[i];
                        var isActive = (op === state.currentOperator);
                        // ä¿®å¾©ï¼šä½¿ç”¨æ›´å¯é çš„èƒŒæ™¯è‰²é¡åˆ¥ï¼Œç¢ºä¿å¡«æ»¿
                        var bgClass = isActive
                            ? 'bg-purple-600 border-purple-400 text-white shadow-lg shadow-purple-500/30'
                            : 'bg-gray-800 border-gray-700 text-gray-300 hover:bg-gray-700';

                        html += '<button onclick="setOperatorGlobal(\'' + escapeHtml(op) + '\')" ' +
                            'class="h-16 flex items-center justify-between px-6 rounded-2xl border-2 transition-all duration-200 active:scale-95 ' + bgClass + '" ' +
                            'data-operator="' + escapeHtml(op) + '">' +
                            '<div class="flex items-center gap-4">' +
                            '<span class="text-3xl">ğŸ‘¤</span>' +
                            '<span class="font-bold text-xl">' + escapeHtml(op) + '</span>' +
                            '</div>' +
                            (isActive ? '<span class="text-3xl font-bold">âœ“</span>' : '') +
                            '</button>';
                    }

                    container.innerHTML = html;
                }

                function setOperatorGlobal(operator) {
                    // ä½¿ç”¨çµ±ä¸€çš„ setOperator å‡½æ•¸ä¾†ä¿æŒä¸€è‡´æ€§
                    setOperator(operator);
                    // é‡æ–°æ¸²æŸ“è¨­å®šé é¢çš„é¸æ“‡å™¨ä»¥ç¢ºä¿æ¨£å¼æ­£ç¢º
                    renderOperatorSelector();
                    toast('å·²åˆ‡æ›æ“ä½œäººå“¡ï¼š' + operator, 'success');
                }

                function updateDashboard() {
                    var totalItems = state.stock.length;
                    el.settingsItemCount.textContent = totalItems;

                    // åŒæ™‚æ›´æ–° Header ä¸­çš„æ•¸å­—
                    var headerTotal = document.getElementById('headerTotalItems');
                    if (headerTotal) {
                        headerTotal.textContent = totalItems;
                        headerTotal.classList.add('number-update');
                        setTimeout(function () { headerTotal.classList.remove('number-update'); }, 400);
                    }

                    var lowCount = 0;
                    var categoryCounts = {};
                    var totalQty = 0;

                    // åˆå§‹åŒ–æ‰€æœ‰åˆ†é¡è¨ˆæ•¸
                    for (var cat in categoryConfig) {
                        categoryCounts[cat] = 0;
                    }

                    // çµ±è¨ˆæ•¸æ“š
                    for (var i = 0; i < state.stock.length; i++) {
                        var item = state.stock[i];
                        var total = safeNum(item.warehouseQty) + safeNum(item.siteQty);
                        var safe = safeNum(item.safeQty, 1);

                        if (total < safe) lowCount++;

                        var cat = getCategory(item);
                        categoryCounts[cat] += total;
                        totalQty += total;
                    }

                    // åŒæ™‚æ›´æ–° Header ä¸­çš„ä½åº«å­˜æ•¸å­—
                    var headerLowStock = document.getElementById('headerLowStock');
                    if (headerLowStock) {
                        headerLowStock.textContent = lowCount;
                        headerLowStock.classList.add('number-update');
                        setTimeout(function () { headerLowStock.classList.remove('number-update'); }, 400);
                    }

                    // è¨ˆç®—F22å» å€ç‰©æ–™æ•¸é‡
                    var siteItemsCount = 0;
                    for (var i = 0; i < state.stock.length; i++) {
                        if (safeNum(state.stock[i].siteQty) > 0) {
                            siteItemsCount++;
                        }
                    }

                    // æ›´æ–° Header ä¸­çš„F22å» å€æ•¸å­—
                    var headerSiteItems = document.getElementById('headerSiteItems');
                    if (headerSiteItems) {
                        headerSiteItems.textContent = siteItemsCount;
                        headerSiteItems.classList.add('number-update');
                        setTimeout(function () { headerSiteItems.classList.remove('number-update'); }, 400);
                    }

                    // æ›´æ–°åˆ†é¡æ¢
                    if (totalQty === 0) totalQty = 1;
                    var barHtml = '';
                    var legendHtml = '';

                    for (var cat in categoryCounts) {
                        if (categoryCounts[cat] > 0) {
                            var pct = (categoryCounts[cat] / totalQty * 100).toFixed(1);
                            var config = categoryConfig[cat];
                            var isActive = dashboardFilter.category === cat;
                            barHtml += '<div class="category-bar-item cursor-pointer hover:opacity-80 transition-opacity" style="width:' + pct + '%; background: linear-gradient(90deg, ' + config.color + ', ' + config.color + 'dd);" onclick="filterSiteByCategory(\'' + cat + '\')"></div>';
                            legendHtml += '<span class="flex items-center gap-2 px-2 py-1 rounded-lg cursor-pointer transition-all hover:scale-105 ' + (isActive ? 'bg-white/20 ring-2 ring-white/30' : 'bg-white/5 border border-white/5') + '" onclick="filterSiteByCategory(\'' + cat + '\')">' +
                                '<span style="color:' + config.color + '; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">' + config.icon + '</span>' +
                                '<span class="font-semibold">' + config.label + '</span>' +
                                '<span class="text-gray-500 font-bold">' + pct + '%</span>' +
                                '</span>';
                        }
                    }

                    el.categoryBar.innerHTML = barHtml;
                    el.categoryLegend.innerHTML = legendHtml;



                    // æ›´æ–°æ™ºæ…§æ±ºç­–æ¨¡çµ„
                    updateReplenishSuggestions();
                    updateStaleItems();

                    // æ›´æ–°F22å» å€ç‰©æ–™æ¸…å–®
                    renderSiteItems();
                }

                function renderSiteItems() {
                    // ç¯©é¸å‡ºF22å» å€æœ‰åº«å­˜çš„ç‰©æ–™ï¼Œä¸¦æ‡‰ç”¨åˆ†é¡éæ¿¾
                    var siteItems = [];
                    for (var i = 0; i < state.stock.length; i++) {
                        var item = state.stock[i];
                        // åŸºç¤æ¢ä»¶ï¼šF22 æœ‰åº«å­˜
                        if (safeNum(item.siteQty) > 0) {
                            // éæ¿¾æ¢ä»¶ï¼šè‹¥æœ‰é¸å®šåˆ†é¡ï¼Œå‰‡éœ€ç¢ºèªåˆ†é¡ç›¸ç¬¦
                            if (dashboardFilter.category) {
                                var itemCat = getCategory(item);
                                if (itemCat !== dashboardFilter.category) continue;
                            }
                            siteItems.push(item);
                        }
                    }

                    // æŒ‰F22å» å€æ•¸é‡é™åºæ’åˆ—
                    siteItems.sort(function (a, b) {
                        return safeNum(b.siteQty) - safeNum(a.siteQty);
                    });

                    el.siteItemCount.textContent = siteItems.length;

                    if (siteItems.length === 0) {
                        el.siteItemsList.classList.add('hidden');
                        el.siteItemsEmpty.classList.remove('hidden');
                        return;
                    }

                    el.siteItemsEmpty.classList.add('hidden');
                    el.siteItemsList.classList.remove('hidden');

                    var html = '';
                    for (var i = 0; i < siteItems.length; i++) {
                        var item = siteItems[i];
                        var id = safeStr(item.id, i);
                        var name = safeStr(item.name, 'æœªå‘½å');
                        var spec = safeStr(item.spec, '-');
                        var sQty = safeNum(item.siteQty);
                        var cat = getCategory(item);
                        var icon = getCategoryIcon(cat);

                        html += '<div class="site-item flex items-center justify-between p-5 rounded-2xl bg-white/5 border border-white/5 cursor-pointer" onclick="openBottomSheet(\'' + escapeHtml(id) + '\')" style="animation-delay: ' + (i * 0.05) + 's">' +
                            '<div class="flex items-center gap-4 flex-1 min-w-0">' +
                            '<span class="text-3xl flex-shrink-0">' + icon + '</span>' +
                            '<div class="flex-1 min-w-0">' +
                            '<p class="text-base font-bold text-white truncate mb-1">' + escapeHtml(name) + '</p>' +
                            '<p class="text-sm text-gray-300 truncate font-medium">' + escapeHtml(spec) + '</p>' +
                            '</div>' +
                            '</div>' +
                            '<div class="text-right flex-shrink-0 ml-4">' +
                            '<p class="big-number text-4xl font-extrabold text-cyan-400 leading-none">' + sQty + '</p>' +
                            '<p class="text-xs text-gray-400 font-bold mt-1.5">ä»¶</p>' +
                            '</div>' +
                            '</div>';
                    }

                    el.siteItemsList.innerHTML = html;
                }

                // ===== æ™ºæ…§æ±ºç­–æ¨¡çµ„ =====
                var dashboardFilter = {
                    category: null // ç•¶å‰é¸ä¸­çš„åˆ†é¡ï¼Œnull è¡¨ç¤ºå…¨éƒ¨
                };

                // æ›´æ–°æ™ºæ…§è£œè²¨å»ºè­°
                function updateReplenishSuggestions() {
                    var replenishList = document.getElementById('replenishList');
                    if (!replenishList) return;

                    // ç¯©é¸ä½åº«å­˜ç‰©æ–™ä¸¦è¨ˆç®—ç¼ºå£
                    var lowStockItems = [];
                    for (var i = 0; i < state.stock.length; i++) {
                        var item = state.stock[i];
                        var total = safeNum(item.warehouseQty) + safeNum(item.siteQty);
                        var safe = safeNum(item.safeQty, 1);
                        if (total < safe) {
                            lowStockItems.push({
                                item: item,
                                shortage: safe - total,
                                urgency: (safe - total) / safe // ç·Šæ€¥åº¦ï¼šç¼ºå£æ¯”ä¾‹
                            });
                        }
                    }

                    // æŒ‰ç·Šæ€¥åº¦æ’åº
                    lowStockItems.sort(function (a, b) {
                        return b.urgency - a.urgency;
                    });

                    if (lowStockItems.length === 0) {
                        replenishList.innerHTML = '<p class="text-green-400 text-sm font-medium">âœ… æ‰€æœ‰ç‰©æ–™åº«å­˜å……è¶³ï¼</p>';
                        return;
                    }

                    // é¡¯ç¤ºå‰ 3 åæœ€ç·Šæ€¥çš„
                    var html = '<div class="text-sm text-gray-400 mb-3">å…± <span class="text-yellow-300 font-bold">' + lowStockItems.length + '</span> é …éœ€è¦è£œè²¨</div>';
                    var top3 = lowStockItems.slice(0, 3);

                    for (var i = 0; i < top3.length; i++) {
                        var data = top3[i];
                        var item = data.item;
                        var urgencyColor = data.urgency > 0.8 ? 'text-red-400' : data.urgency > 0.5 ? 'text-yellow-400' : 'text-orange-400';

                        html += '<div class="flex items-center justify-between p-3 rounded-xl bg-white/5 border border-white/10">' +
                            '<div class="flex-1 min-w-0">' +
                            '<p class="text-white font-bold truncate">' + escapeHtml(safeStr(item.spec, '-')) + '</p>' +
                            '<p class="text-xs text-gray-500 truncate">' + escapeHtml(safeStr(item.name, '')) + '</p>' +
                            '</div>' +
                            '<div class="text-right ml-3">' +
                            '<p class="' + urgencyColor + ' font-black text-lg">ç¼º ' + Math.ceil(data.shortage) + '</p>' +
                            '<p class="text-xs text-gray-600">å®‰å…¨é‡ ' + safeNum(item.safeQty) + '</p>' +
                            '</div>' +
                            '</div>';
                    }

                    replenishList.innerHTML = html;
                }



                // ä¸€éµè¤‡è£½æ¡è³¼æ¸…å–®
                function copyPurchaseList() {
                    var lowStockItems = [];
                    for (var i = 0; i < state.stock.length; i++) {
                        var item = state.stock[i];
                        var total = safeNum(item.warehouseQty) + safeNum(item.siteQty);
                        var safe = safeNum(item.safeQty, 1);
                        if (total < safe) {
                            lowStockItems.push({
                                name: safeStr(item.name, ''),
                                spec: safeStr(item.spec, '-'),
                                unit: safeStr(item.unit, 'å€‹'),
                                shortage: Math.ceil(safe - total)
                            });
                        }
                    }

                    if (lowStockItems.length === 0) {
                        toast('æ²’æœ‰éœ€è¦è£œè²¨çš„ç‰©æ–™ï¼', 'info');
                        return;
                    }

                    // ç”Ÿæˆæ¡è³¼æ¸…å–®æ–‡å­—
                    var text = 'ğŸ“‹ æ¡è³¼æ¸…å–® (' + formatDateTime(new Date()) + ')\n';
                    text += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
                    for (var i = 0; i < lowStockItems.length; i++) {
                        var item = lowStockItems[i];
                        text += (i + 1) + '. ' + item.name + ' (' + item.spec + ')\n';
                        text += '   å»ºè­°æ¡è³¼ï¼š' + item.shortage + ' ' + item.unit + '\n';
                    }
                    text += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
                    text += 'å…± ' + lowStockItems.length + ' é …\n';

                    // è¤‡è£½åˆ°å‰ªè²¼ç°¿
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(text).then(function () {
                            hapticFeedback('success');
                            toast('âœ… æ¡è³¼æ¸…å–®å·²è¤‡è£½ï¼', 'success');
                        }).catch(function () {
                            toast('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½', 'error');
                        });
                    } else {
                        toast('ç€è¦½å™¨ä¸æ”¯æ´è¤‡è£½åŠŸèƒ½', 'warning');
                    }
                }

                // å‘†æ»¯ç‰©æ–™åˆ†æ (30å¤©æœªè®Šå‹•)
                function updateStaleItems() {
                    var card = document.getElementById('staleItemsCard');
                    var list = document.getElementById('staleItemsList');
                    if (!card || !list) return;

                    var now = new Date();
                    var staleCount = 0;
                    var html = '';

                    // æ¨¡æ“¬æ•¸æ“šï¼šå¦‚æœæœ‰ last_updated æ¬„ä½å‰‡ä½¿ç”¨ï¼Œå¦å‰‡éš¨æ©Ÿæ¨¡æ“¬å¹¾å€‹ï¼ˆåƒ…ä¾›æ¼”ç¤ºï¼Œå¯¦éš›æ‡‰æ¥å¾Œç«¯ï¼‰
                    // åœ¨æ­¤ç‰ˆæœ¬ä¸­ï¼Œæˆ‘å€‘æª¢æŸ¥ item.lastUpdated (å‡è¨­æ ¼å¼ç‚º ISO å­—ä¸²æˆ– Date ç‰©ä»¶)
                    // å¦‚æœæ²’æœ‰ lastUpdatedï¼Œæˆ‘å€‘æš«æ™‚ä¸é¡¯ç¤ºï¼Œé¿å…èª¤åˆ¤

                    var staleItems = [];
                    for (var i = 0; i < state.stock.length; i++) {
                        var item = state.stock[i];
                        if (item.lastUpdated) {
                            var lastUpdate = new Date(item.lastUpdated);
                            var diffTime = Math.abs(now - lastUpdate);
                            var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                            if (diffDays > 30) {
                                staleItems.push({
                                    item: item,
                                    days: diffDays
                                });
                            }
                        }
                    }

                    // æŒ‰å‘†æ»¯å¤©æ•¸æ’åº
                    staleItems.sort(function (a, b) {
                        return b.days - a.days;
                    });

                    if (staleItems.length === 0) {
                        card.classList.add('hidden');
                        return;
                    }

                    card.classList.remove('hidden');

                    var displayItems = staleItems.slice(0, 3); // é¡¯ç¤ºå‰3å
                    for (var i = 0; i < displayItems.length; i++) {
                        var data = displayItems[i];
                        html += '<div class="flex items-center justify-between p-2 rounded-lg bg-black/20 border border-white/5">' +
                            '<span class="text-white text-sm font-medium truncate flex-1">' + escapeHtml(safeStr(data.item.name)) + '</span>' +
                            '<span class="text-red-300 text-xs font-bold whitespace-nowrap ml-2">' + data.days + ' å¤©æœªå‹•</span>' +
                            '</div>';
                    }

                    if (staleItems.length > 3) {
                        html += '<p class="text-center text-xs text-red-300/70 mt-2">é‚„æœ‰ ' + (staleItems.length - 3) + ' é …...</p>';
                    }

                    list.innerHTML = html;
                }

                // åˆ†é¡è¯å‹•éæ¿¾ï¼ˆé»æ“Šåˆ†é¡çµ±è¨ˆä¸­çš„é¡åˆ¥ï¼‰
                function filterSiteByCategory(category) {
                    if (dashboardFilter.category === category) {
                        dashboardFilter.category = null; // å†æ¬¡é»æ“Šå‰‡å–æ¶ˆç¯©é¸
                    } else {
                        dashboardFilter.category = category;
                    }
                    renderSiteItems();

                    // æ›´æ–°ç¯©é¸æ¨™ç±¤é¡¯ç¤º
                    var label = document.getElementById('siteFilterLabel');
                    if (label) {
                        if (dashboardFilter.category) {
                            label.classList.remove('hidden');
                            label.textContent = 'ç¯©é¸ï¼š' + (categoryConfig[category] ? categoryConfig[category].label : 'å…¨éƒ¨');
                        } else {
                            label.classList.add('hidden');
                        }
                    }
                }

                // ===== åˆ—è¡¨æ¸²æŸ“ =====
                function renderList() {
                    if (state.filtered.length === 0) {
                        el.inventoryList.innerHTML = '';
                        el.emptyState.classList.remove('hidden');
                        el.inventoryList.setAttribute('aria-label', 'æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç‰©æ–™');
                        return;
                    }

                    el.emptyState.classList.add('hidden');
                    el.inventoryList.setAttribute('aria-label', 'ç‰©æ–™åˆ—è¡¨ï¼Œå…± ' + state.filtered.length + ' é …');

                    // ä½¿ç”¨ DocumentFragment æå‡æ€§èƒ½
                    var fragment = document.createDocumentFragment();
                    for (var i = 0; i < state.filtered.length; i++) {
                        var div = document.createElement('div');
                        div.innerHTML = renderItem(state.filtered[i], i);
                        var item = div.firstChild;
                        item.setAttribute('role', 'listitem');
                        fragment.appendChild(item);
                    }
                    el.inventoryList.innerHTML = '';
                    el.inventoryList.appendChild(fragment);
                }

                function renderItem(item, idx) {
                    var id = safeStr(item.id, idx);
                    var name = safeStr(item.name, 'æœªå‘½å');
                    var spec = safeStr(item.spec, '-');
                    var unit = safeStr(item.unit, 'å€‹');
                    var wQty = safeNum(item.warehouseQty);
                    var sQty = safeNum(item.siteQty);
                    var safeQty = safeNum(item.safeQty, 1);
                    var total = wQty + sQty;

                    var pct = Math.min((total / Math.max(safeQty * 2, 1)) * 100, 100);
                    var colorClass = 'stock-green';
                    var statusText = 'åº«å­˜å……è¶³';
                    var alertClass = ''; // è­¦ç¤ºé¡åˆ¥

                    if (total === 0) {
                        colorClass = 'stock-red';
                        statusText = 'ç„¡åº«å­˜';
                        alertClass = 'out-of-stock';
                    } else if (total < safeQty) {
                        colorClass = 'stock-yellow';
                        statusText = 'åº«å­˜ä¸è¶³';
                        alertClass = 'low-stock-alert';
                    }

                    var cat = getCategory(item);
                    var icon = getCategoryIcon(cat, true); // ä½¿ç”¨ SVG åœ–æ¨™
                    var isSelected = state.selectedItems.indexOf(id) >= 0;
                    var selectClass = isSelected ? 'ring-2 ring-purple-500 ring-offset-2 ring-offset-black' : '';

                    // COMPACT CARD: High-density flex-row layout with stock alerts
                    return '<div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-4 cursor-pointer transition-all duration-150 active:scale-[0.98] hover:bg-zinc-800/50 ' + selectClass + ' ' + alertClass + '" ' +
                        'onclick="handleItemClick(event, \'' + escapeHtml(id) + '\')" ' +
                        'onkeydown="if(event.key===\'Enter\'||event.key===\' \'){handleItemClick(event, \'' + escapeHtml(id) + '\');event.preventDefault();}" ' +
                        'data-id="' + escapeHtml(id) + '" role="button" tabindex="0" ' +
                        'aria-label="' + escapeHtml(name) + 'ï¼Œè¦æ ¼ï¼š' + escapeHtml(spec) + 'ï¼Œå…¬å¸å€‰ï¼š' + wQty + 'ä»¶ï¼ŒF22ï¼š' + sQty + 'ä»¶">' +
                        '<div class="flex items-center gap-4">' +
                        icon +
                        '<div class="flex-1 min-w-0">' +
                        '<p class="text-xl font-black text-white leading-tight truncate">' + escapeHtml(spec) + '</p>' +
                        '<p class="text-sm text-gray-500 truncate mt-0.5">' + escapeHtml(name) + ' Â· ' + escapeHtml(unit) + '</p>' +
                        '</div>' +
                        '<div class="flex items-center gap-4 flex-shrink-0">' +
                        '<div class="text-center">' +
                        '<p class="text-2xl font-black text-purple-400 tabular-nums leading-none">' + wQty + '</p>' +
                        '<p class="text-xs text-purple-400/70 font-bold mt-1">å…¬å¸</p>' +
                        '</div>' +
                        '<div class="text-center">' +
                        '<p class="text-2xl font-black text-cyan-400 tabular-nums leading-none">' + sQty + '</p>' +
                        '<p class="text-xs text-cyan-400/70 font-bold mt-1">F22</p>' +
                        '</div>' +
                        '<svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>' +
                        '</div>' +
                        '</div>' +
                        '</div>';
                }

                // è™•ç†ç‰©æ–™é»æ“Šï¼ˆæ”¯æŒæ‰¹é‡é¸æ“‡ï¼‰
                function handleItemClick(event, id) {
                    // å¦‚æœæŒ‰ä½ Ctrl/Cmdï¼Œåˆ‡æ›é¸æ“‡ç‹€æ…‹
                    if (event.ctrlKey || event.metaKey) {
                        event.preventDefault();
                        toggleItemSelection(id);
                        return;
                    }
                    // å¦å‰‡æ‰“é–‹ç›¤é»è¦–çª—
                    openBottomSheet(id);
                }

                // åˆ‡æ›ç‰©æ–™é¸æ“‡ç‹€æ…‹
                function toggleItemSelection(id) {
                    var index = state.selectedItems.indexOf(id);
                    if (index >= 0) {
                        state.selectedItems.splice(index, 1);
                    } else {
                        state.selectedItems.push(id);
                    }
                    updateBatchActions();
                    renderList(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°é¸æ“‡ç‹€æ…‹
                }

                // æ¸…é™¤é¸æ“‡
                function clearSelection() {
                    state.selectedItems = [];
                    updateBatchActions();
                    renderList();
                }

                // æ›´æ–°æ‰¹é‡æ“ä½œæ¬„
                function updateBatchActions() {
                    var batchBar = document.getElementById('batchActions');
                    var countEl = document.getElementById('selectedCount');
                    if (!batchBar || !countEl) return;

                    if (state.selectedItems.length > 0) {
                        batchBar.classList.remove('hidden');
                        countEl.textContent = state.selectedItems.length;
                    } else {
                        batchBar.classList.add('hidden');
                    }
                }

                // æ‰¹é‡èª¿æ•´æ•¸é‡
                function batchAdjust(type, delta) {
                    if (state.selectedItems.length === 0) {
                        toast('è«‹å…ˆé¸æ“‡ç‰©æ–™', 'warning');
                        return;
                    }

                    var count = state.selectedItems.length;
                    if (!confirm('ç¢ºå®šè¦å° ' + count + ' å€‹ç‰©æ–™é€²è¡Œæ‰¹é‡èª¿æ•´å—ï¼Ÿ')) {
                        return;
                    }

                    var successCount = 0;
                    var failCount = 0;

                    state.selectedItems.forEach(function (id) {
                        var item = findItemById(id);
                        if (!item) {
                            failCount++;
                            return;
                        }

                        var isW = type === 'w';
                        var oldQty = isW ? item.warehouseQty : item.siteQty;
                        var newQty = Math.max(0, oldQty + delta);

                        // é©—è­‰ç¯„åœ
                        if (newQty > 99999) {
                            failCount++;
                            return;
                        }

                        // ä½¿ç”¨çµ±ä¸€çš„æ›´æ–°å‡½æ•¸
                        updateQty(id, type, newQty, oldQty, item);
                        successCount++;
                    });

                    clearSelection();
                    toast('å·²æ‰¹é‡èª¿æ•´ ' + successCount + ' å€‹ç‰©æ–™' + (failCount > 0 ? 'ï¼Œ' + failCount + ' å€‹å¤±æ•—' : ''), successCount > 0 ? 'success' : 'error');
                }

                function openBottomSheet(id) {
                    var item = findItemById(id);
                    if (!item) {
                        toast('æ‰¾ä¸åˆ°è©²ç‰©æ–™', 'error');
                        return;
                    }

                    state.currentItem = item;
                    var wQty = safeNum(item.warehouseQty);
                    var sQty = safeNum(item.siteQty);

                    // ç”Ÿæˆæ“ä½œäººå“¡æŒ‰éˆ•
                    var operatorButtons = '';
                    for (var i = 0; i < OPERATORS.length; i++) {
                        var op = OPERATORS[i];
                        var isActive = (op === state.currentOperator);
                        var activeClass = isActive ? 'bg-gradient-to-r from-purple-600 to-purple-500 text-white border-purple-400/50 shadow-lg shadow-purple-500/30' : 'bg-white/5 text-gray-300 border-white/10';
                        operatorButtons += '<button onclick="setOperator(\'' + escapeHtml(op) + '\")" ' +
                            'class="operator-btn btn-interactive px-6 py-3.5 rounded-2xl text-base font-bold border-2 transition-all ' + activeClass + '" ' +
                            'data-operator="' + escapeHtml(op) + '" ' +
                            'aria-label="é¸æ“‡æ“ä½œäººå“¡ ' + escapeHtml(op) + '" ' +
                            'aria-pressed="' + (isActive ? 'true' : 'false') + '">' +
                            escapeHtml(op) +
                            '</button>';
                    }

                    el.bottomSheetContent.innerHTML =
                        '<div class="mb-8">' +
                        '<h2 id="bottomSheetTitle" class="text-4xl font-extrabold text-white mb-4 leading-tight">' + escapeHtml(item.name) + '</h2>' +
                        '<p class="text-base text-gray-300 font-semibold">' + escapeHtml(item.spec) + ' Â· ' + escapeHtml(item.unit) + '</p>' +
                        '</div>' +
                        '<div class="bg-zinc-900/70 backdrop-blur-xl border border-zinc-700/50 shadow-2xl rounded-3xl p-6 mb-6">' +
                        '<div class="flex items-center gap-2.5 mb-4">' +
                        '<span class="text-2xl" aria-hidden="true">ğŸ‘¤</span>' +
                        '<p class="text-sm text-gray-300 font-bold uppercase tracking-wider">æ“ä½œäººå“¡</p>' +
                        '</div>' +
                        '<div class="flex gap-3" role="group" aria-label="é¸æ“‡æ“ä½œäººå“¡">' + operatorButtons + '</div>' +
                        '</div>' +
                        '<div class="space-y-6">' +
                        '<div class="bg-zinc-950/90 backdrop-blur-2xl border border-zinc-700/60 shadow-[0_16px_48px_rgba(0,0,0,0.8)] rounded-3xl p-6 relative overflow-hidden">' +
                        '<div class="absolute top-0 right-0 w-32 h-32 bg-purple-500/10 rounded-full blur-3xl" aria-hidden="true"></div>' +
                        '<p class="text-sm text-gray-300 font-bold uppercase tracking-wider mb-5 relative z-10">å…¬å¸å€‰åº«å­˜</p>' +
                        '<div class="flex items-center justify-between gap-5 relative z-10" role="group" aria-label="èª¿æ•´å…¬å¸å€‰åº«å­˜">' +
                        '<button onclick="adjustQty(\'w\', -1)" class="btn-interactive w-20 h-20 rounded-3xl bg-red-600/20 text-red-400 flex items-center justify-center text-4xl font-extrabold border-2 border-red-600/40 shadow-lg shadow-red-600/20" aria-label="æ¸›å°‘å…¬å¸å€‰åº«å­˜">âˆ’</button>' +
                        '<div class="text-center flex-1">' +
                        '<p class="big-number editable-number text-7xl font-extrabold text-purple-400 leading-none" id="bs-w-' + id + '" aria-live="polite" aria-atomic="true" aria-label="å…¬å¸å€‰åº«å­˜ï¼Œé›™æ“Šå¯ç·¨è¼¯" ondblclick="editNumber(\'' + id + '\', \'w\', true)" title="é›™æ“Šç·¨è¼¯">' + wQty + '</p>' +
                        '</div>' +
                        '<button onclick="adjustQty(\'w\', 1)" class="btn-interactive w-20 h-20 rounded-3xl bg-green-600/20 text-green-400 flex items-center justify-center text-4xl font-extrabold border-2 border-green-600/40 shadow-lg shadow-green-600/20" aria-label="å¢åŠ å…¬å¸å€‰åº«å­˜">+</button>' +
                        '</div>' +
                        '</div>' +
                        '<div class="bg-zinc-900/70 backdrop-blur-xl border border-zinc-700/50 shadow-2xl rounded-3xl p-5 mb-6">' +
                        '<button onclick="event.stopPropagation();window.transferToSite(\'' + escapeHtml(String(id)) + '\');" class="btn-interactive w-full py-5 rounded-2xl bg-gradient-to-r from-cyan-600 to-cyan-500 hover:from-cyan-700 hover:to-cyan-600 active:from-cyan-800 active:to-cyan-700 text-white font-extrabold text-xl border-2 border-cyan-400/50 shadow-lg shadow-cyan-500/30 transition-all" aria-label="è½‰ç§»ç‰©æ–™è‡³F22" type="button">' +
                        '<span class="flex items-center justify-center gap-2">' +
                        '<span class="text-2xl">ğŸ“¦</span>' +
                        '<span>è½‰ç§»ç‰©æ–™è‡³F22</span>' +
                        '</span>' +
                        '</button>' +
                        '</div>' +
                        '<div class="bg-zinc-950/90 backdrop-blur-2xl border border-zinc-700/60 shadow-[0_16px_48px_rgba(0,0,0,0.8)] rounded-3xl p-6 relative overflow-hidden">' +
                        '<div class="absolute top-0 right-0 w-32 h-32 bg-cyan-500/10 rounded-full blur-3xl" aria-hidden="true"></div>' +
                        '<p class="text-sm text-gray-300 font-bold uppercase tracking-wider mb-5 relative z-10">F22å» å€åº«å­˜</p>' +
                        '<div class="flex items-center justify-between gap-5 relative z-10" role="group" aria-label="èª¿æ•´F22å» å€åº«å­˜">' +
                        '<button onclick="adjustQty(\'s\', -1)" class="btn-interactive w-20 h-20 rounded-3xl bg-red-600/20 text-red-400 flex items-center justify-center text-4xl font-extrabold border-2 border-red-600/40 shadow-lg shadow-red-600/20" aria-label="æ¸›å°‘F22å» å€åº«å­˜">âˆ’</button>' +
                        '<div class="text-center flex-1">' +
                        '<p class="big-number editable-number text-7xl font-extrabold text-cyan-400 leading-none" id="bs-s-' + id + '" aria-live="polite" aria-atomic="true" aria-label="F22å» å€åº«å­˜ï¼Œé›™æ“Šå¯ç·¨è¼¯" ondblclick="editNumber(\'' + id + '\', \'s\', true)" title="é›™æ“Šç·¨è¼¯">' + sQty + '</p>' +
                        '</div>' +
                        '<button onclick="adjustQty(\'s\', 1)" class="btn-interactive w-20 h-20 rounded-3xl bg-green-600/20 text-green-400 flex items-center justify-center text-4xl font-extrabold border-2 border-green-600/40 shadow-lg shadow-green-600/20" aria-label="å¢åŠ F22å» å€åº«å­˜">+</button>' +
                        '</div>' +
                        '</div>' +
                        '</div>';

                    el.bottomSheet.classList.add('open');
                    el.bottomSheet.setAttribute('aria-hidden', 'false');
                    el.bottomSheetOverlay.classList.add('open');
                    document.body.style.overflow = 'hidden';

                    // èšç„¦åˆ°ç¬¬ä¸€å€‹å¯èšç„¦å…ƒç´ 
                    setTimeout(function () {
                        var firstButton = el.bottomSheetContent.querySelector('button');
                        if (firstButton) firstButton.focus();
                    }, 100);
                }

                function setOperator(operator) {
                    state.currentOperator = operator;

                    // æ›´æ–° Header é¡¯ç¤º
                    var headerOp = document.getElementById('headerOperator');
                    if (headerOp) {
                        headerOp.textContent = operator;
                        headerOp.classList.add('number-update');
                        setTimeout(function () { headerOp.classList.remove('number-update'); }, 400);
                    }

                    // æ›´æ–° Bottom Sheet ä¸­çš„æŒ‰éˆ•æ¨£å¼
                    var buttons = document.querySelectorAll('.operator-btn');
                    buttons.forEach(function (btn) {
                        if (btn.getAttribute('data-operator') === operator) {
                            btn.className = 'operator-btn btn-interactive px-6 py-3.5 rounded-2xl text-base font-bold border-2 transition-all bg-gradient-to-r from-purple-600 to-purple-500 text-white border-purple-400/50 shadow-lg shadow-purple-500/30';
                            btn.setAttribute('aria-pressed', 'true');
                        } else {
                            btn.className = 'operator-btn btn-interactive px-6 py-3.5 rounded-2xl text-base font-bold border-2 transition-all bg-white/5 text-gray-300 border-white/10';
                            btn.setAttribute('aria-pressed', 'false');
                        }
                    });

                    // æ›´æ–°è¨­å®šé é¢çš„æŒ‰éˆ•æ¨£å¼
                    var selectButtons = document.querySelectorAll('.operator-select-btn');
                    selectButtons.forEach(function (btn) {
                        var btnOperator = btn.getAttribute('data-operator');
                        if (btnOperator === operator) {
                            btn.className = 'btn-interactive operator-select-btn flex items-center justify-between p-5 rounded-2xl border-2 transition-all bg-purple-600 border-purple-400 text-white shadow-lg shadow-purple-500/30';
                            // ç¢ºä¿æœ‰ âœ“ æ¨™è¨˜
                            if (!btn.querySelector('span:last-child') || btn.querySelector('span:last-child').textContent !== 'âœ“') {
                                var checkMark = document.createElement('span');
                                checkMark.className = 'text-2xl font-bold';
                                checkMark.textContent = 'âœ“';
                                btn.appendChild(checkMark);
                            }
                        } else {
                            btn.className = 'btn-interactive operator-select-btn flex items-center justify-between p-5 rounded-2xl border-2 transition-all bg-gray-800 border-gray-700 text-gray-300';
                            // ç§»é™¤ âœ“ æ¨™è¨˜
                            var checkMark = btn.querySelector('span:last-child');
                            if (checkMark && checkMark.textContent === 'âœ“') {
                                checkMark.remove();
                            }
                        }
                    });

                    toast('å·²åˆ‡æ›ç‚ºï¼š' + operator, 'info');
                }

                function closeBottomSheet() {
                    el.bottomSheet.classList.remove('open');
                    el.bottomSheet.setAttribute('aria-hidden', 'true');
                    el.bottomSheetOverlay.classList.remove('open');
                    document.body.style.overflow = '';
                    state.currentItem = null;
                    // åŒæ™‚é—œé–‰è½‰ç§»è¼¸å…¥ç•Œé¢
                    closeTransferInput();
                }

                // ===== çµ±ä¸€çš„æ•¸é‡æ›´æ–°å‡½æ•¸ =====
                function updateQty(id, type, newQty, oldQty, item) {
                    // å¦‚æœæ²’æœ‰æä¾› itemï¼Œå¾ state.stock ä¸­æŸ¥æ‰¾
                    if (!item) {
                        item = findItemById(id);
                    }
                    if (!item) {
                        toast('æ‰¾ä¸åˆ°è©²ç‰©æ–™', 'error');
                        return;
                    }

                    var isW = type === 'w';

                    // æ›´æ–°æœ¬åœ°ç‹€æ…‹
                    if (isW) {
                        item.warehouseQty = newQty;
                    } else {
                        item.siteQty = newQty;
                    }

                    // æ›´æ–° UIï¼ˆä½¿ç”¨å·¥å…·å‡½æ•¸ï¼‰
                    updateNumberDisplay(id, type, newQty, false);
                    updateNumberDisplay(id, type, newQty, true);

                    // é˜²æŠ–æ›´æ–°å¾Œç«¯
                    var key = id + '-' + type;
                    if (state.updateTimers[key]) {
                        clearTimeout(state.updateTimers[key]);
                    }

                    // ä¿å­˜å¾…åŒæ­¥çš„æ“ä½œï¼ˆç”¨æ–¼éŒ¯èª¤æ¢å¾©ï¼‰
                    state.pendingUpdates[key] = {
                        id: id,
                        type: type,
                        oldQty: oldQty,
                        newQty: newQty,
                        operator: state.currentOperator
                    };

                    // æ›´æ–°åŒæ­¥æŒ‡ç¤ºå™¨
                    syncState.isSyncing = true;
                    updateSyncIndicator();

                    state.updateTimers[key] = setTimeout(function () {
                        var action = isW ? 'warehouse_audit' : 'audit';
                        postAPI(action, {
                            id: id,
                            qty: newQty,
                            person: state.currentOperator
                        })
                            .then(function () {
                                toast('âœ… å·²åŒæ­¥ (' + state.currentOperator + ')', 'success');
                                hapticFeedback('success');
                                recordOperation(action, item.name, oldQty, newQty, type);
                                updateDashboard();
                                delete state.pendingUpdates[key];
                                syncState.isSyncing = false;
                                syncState.lastSyncTime = new Date();
                                updateSyncIndicator();
                            })
                            .catch(function (e) {
                                // éŒ¯èª¤æ¢å¾©ï¼šæ¢å¾©åˆ°åŸå§‹å€¼èˆ‡ç•«é¢
                                if (isW) {
                                    item.warehouseQty = oldQty;
                                } else {
                                    item.siteQty = oldQty;
                                }

                                updateNumberDisplay(id, type, oldQty, false);
                                updateNumberDisplay(id, type, oldQty, true);

                                delete state.pendingUpdates[key];
                                syncState.isSyncing = false;
                                updateSyncIndicator();

                                toast('âŒ åŒæ­¥å¤±æ•—ï¼Œå·²æ¢å¾©åŸå€¼: ' + e.message, 'error');
                                hapticFeedback('error');
                                updateDashboard();
                            });

                        delete state.updateTimers[key];
                    }, DEBOUNCE_DELAY);

                    // å³æ™‚å›é¥‹
                    updateDashboard();
                }

                function adjustQty(type, delta) {
                    if (!state.currentItem) return;

                    // è§¸è¦ºå›é¥‹
                    hapticFeedback(delta > 0 ? 'light' : 'medium');

                    // æª¢æŸ¥ç¶²çµ¡ç‹€æ…‹
                    if (!state.isOnline) {
                        toast('âš ï¸ ç›®å‰é›¢ç·šï¼Œæ“ä½œå°‡åœ¨é€£ç·šå¾ŒåŒæ­¥', 'warning');
                        hapticFeedback('warning');
                    }

                    var id = state.currentItem.id;
                    var isW = type === 'w';

                    // ä¿å­˜åŸå§‹å€¼ï¼ˆç”¨æ–¼éŒ¯èª¤æ¢å¾©ï¼‰
                    var oldQty = isW ? state.currentItem.warehouseQty : state.currentItem.siteQty;
                    var newQty = Math.max(0, oldQty + delta);

                    // æ•¸æ“šé©—è­‰ï¼šæª¢æŸ¥æ˜¯å¦è¶…éåˆç†ç¯„åœ
                    if (newQty > 99999) {
                        toast('æ•¸é‡ä¸èƒ½è¶…é 99999', 'warning');
                        return;
                    }

                    // é‡è¦æ“ä½œç¢ºèªï¼šå¤§é‡æ¸›å°‘æˆ–æ¸›å°‘åˆ° 0
                    if (delta < -10 || (delta < 0 && newQty === 0)) {
                        var confirmMsg = delta < -10
                            ? 'ç¢ºå®šè¦æ¸›å°‘ ' + Math.abs(delta) + ' ä»¶å—ï¼Ÿ\n\n' + state.currentItem.name
                            : 'ç¢ºå®šè¦å°‡æ•¸é‡èª¿æ•´ç‚º 0 å—ï¼Ÿ\n\n' + state.currentItem.name;

                        if (!confirm(confirmMsg)) {
                            return; // ç”¨æˆ¶å–æ¶ˆ
                        }
                    }

                    // ä½¿ç”¨çµ±ä¸€çš„æ›´æ–°å‡½æ•¸
                    updateQty(id, type, newQty, oldQty, state.currentItem);
                }

                // ===== è½‰ç§»ç‰©æ–™è‡³F22 =====
                function transferToSite(id) {
                    console.log('transferToSite called with id:', id);

                    // ç¢ºä¿idæ˜¯å­—ç¬¦ä¸²
                    id = String(id);

                    var item = findItemById(id);
                    if (!item) {
                        console.error('Item not found for id:', id);
                        toast('æ‰¾ä¸åˆ°è©²ç‰©æ–™', 'error');
                        return;
                    }

                    var warehouseQty = safeNum(item.warehouseQty);

                    if (warehouseQty <= 0) {
                        toast('å…¬å¸å€‰åº«å­˜ç‚º 0ï¼Œç„¡æ³•è½‰ç§»', 'warning');
                        return;
                    }

                    // é¡¯ç¤ºæ‰‹æ©Ÿå‹å–„çš„è¼¸å…¥ç•Œé¢
                    showTransferInput(id, item, warehouseQty);
                }

                function showTransferInput(id, item, maxQty) {
                    // ä¿å­˜ç•¶å‰è½‰ç§»çš„é …ç›®ID
                    state.transferItemId = id;

                    // ç”Ÿæˆå¿«é€Ÿé¸æ“‡æŒ‰éˆ•
                    var quickBtns = '';
                    var quickValues = [0.5, 1, 2, 5, 10, Math.max(1, Math.floor(maxQty / 2)), maxQty];
                    // éæ¿¾è¶…éæœ€å¤§å€¼çš„é¸é …
                    quickValues = quickValues.filter(function (v) { return v <= maxQty && v > 0; });
                    // å»é‡ä¸¦æ’åº
                    quickValues = quickValues.filter(function (v, i, arr) { return arr.indexOf(v) === i; }).sort(function (a, b) { return a - b; });
                    // åªå–å‰6å€‹
                    quickValues = quickValues.slice(0, 6);

                    for (var i = 0; i < quickValues.length; i++) {
                        var val = quickValues[i];
                        var displayVal = val % 1 === 0 ? val : val.toFixed(1);
                        quickBtns += '<button class="transfer-quick-btn" onclick="setTransferQty(' + val + ')">' + displayVal + '</button>';
                    }

                    el.transferInputContent.innerHTML =
                        '<div class="transfer-input-container">' +
                        '<h2 id="transferInputTitle" class="text-3xl font-extrabold text-white mb-6 text-center">' + escapeHtml(item.name) + '</h2>' +
                        '<div class="transfer-info">' +
                        '<div class="transfer-info-text">ç•¶å‰å…¬å¸å€‰åº«å­˜</div>' +
                        '<div class="transfer-info-number">' + formatNumber(maxQty) + '</div>' +
                        '</div>' +
                        '<label class="transfer-input-label">è¼¸å…¥è½‰ç§»æ•¸é‡</label>' +
                        '<input type="number" id="transferQtyInput" class="transfer-input-number" min="0.1" max="' + maxQty + '" step="0.1" value="" placeholder="0.0" inputmode="decimal">' +
                        '<div class="transfer-quick-buttons">' + quickBtns + '</div>' +
                        '<div class="transfer-action-buttons">' +
                        '<button class="transfer-action-btn cancel" onclick="closeTransferInput()">å–æ¶ˆ</button>' +
                        '<button class="transfer-action-btn confirm" onclick="confirmTransfer()">ç¢ºèªè½‰ç§»</button>' +
                        '</div>' +
                        '</div>';

                    el.transferInputSheet.classList.add('open');
                    el.transferInputSheet.setAttribute('aria-hidden', 'false');
                    el.bottomSheetOverlay.classList.add('open');
                    document.body.style.overflow = 'hidden';

                    // èšç„¦åˆ°è¼¸å…¥æ¡†
                    setTimeout(function () {
                        var input = document.getElementById('transferQtyInput');
                        if (input) {
                            input.focus();
                            // ç§»å‹•è¨­å‚™è‡ªå‹•å½ˆå‡ºæ•¸å­—éµç›¤
                            input.click();
                        }
                    }, 300);
                }

                function setTransferQty(qty) {
                    var input = document.getElementById('transferQtyInput');
                    if (input) {
                        input.value = qty % 1 === 0 ? qty : qty.toFixed(1);
                        // è§¸ç™¼è¼¸å…¥äº‹ä»¶ä»¥é©—è­‰
                        input.dispatchEvent(new Event('input', { bubbles: true }));
                        // éœ‡å‹•åé¥‹ï¼ˆå¦‚æœæ”¯æŒï¼‰
                        if (navigator.vibrate) {
                            navigator.vibrate(50);
                        }
                    }
                }

                function closeTransferInput() {
                    el.transferInputSheet.classList.remove('open');
                    el.transferInputSheet.setAttribute('aria-hidden', 'true');
                    el.bottomSheetOverlay.classList.remove('open');
                    document.body.style.overflow = '';
                    state.transferItemId = null;
                }

                function confirmTransfer() {
                    var id = state.transferItemId;
                    if (!id) {
                        toast('æ‰¾ä¸åˆ°ç‰©æ–™è³‡è¨Š', 'error');
                        closeTransferInput();
                        return;
                    }

                    var item = findItemById(id);
                    if (!item) {
                        toast('æ‰¾ä¸åˆ°è©²ç‰©æ–™', 'error');
                        closeTransferInput();
                        return;
                    }

                    var maxQty = safeNum(item.warehouseQty);
                    var input = document.getElementById('transferQtyInput');
                    if (!input) {
                        closeTransferInput();
                        return;
                    }

                    var transferQty = parseFloat(input.value);

                    // é©—è­‰è¼¸å…¥
                    if (isNaN(transferQty) || transferQty <= 0) {
                        toast('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸é‡', 'error');
                        input.focus();
                        return;
                    }

                    // ä¿ç•™å°æ•¸é»å¾Œä¸€ä½
                    transferQty = Math.round(transferQty * 10) / 10;

                    if (transferQty > maxQty) {
                        toast('è½‰ç§»æ•¸é‡ä¸èƒ½è¶…éå…¬å¸å€‰åº«å­˜ï¼ˆ' + formatNumber(maxQty) + 'ï¼‰', 'error');
                        input.focus();
                        return;
                    }

                    // é—œé–‰è¼¸å…¥ç•Œé¢
                    closeTransferInput();

                    // åŸ·è¡Œè½‰ç§»
                    var warehouseQty = maxQty;

                    // èª¿ç”¨API
                    postAPI('move_to_site', {
                        id: id,
                        qty: transferQty,
                        person: state.currentOperator
                    })
                        .then(function (data) {
                            // æ›´æ–°æœ¬åœ°ç‹€æ…‹
                            item.warehouseQty = warehouseQty - transferQty;
                            item.siteQty = safeNum(item.siteQty) + transferQty;

                            // æ›´æ–°é¡¯ç¤º
                            updateNumberDisplay(id, 'w', item.warehouseQty, true);
                            updateNumberDisplay(id, 's', item.siteQty, true);
                            updateNumberDisplay(id, 'w', item.warehouseQty, false);
                            updateNumberDisplay(id, 's', item.siteQty, false);

                            updateDashboard();
                            toast('âœ… å·²è½‰ç§» ' + formatNumber(transferQty) + ' ä»¶è‡³F22å» å€', 'success');

                            // å¦‚æœBottom Sheetæ‰“é–‹ï¼Œæ›´æ–°ç•¶å‰é …ç›®
                            if (state.currentItem && state.currentItem.id == id) {
                                state.currentItem.warehouseQty = item.warehouseQty;
                                state.currentItem.siteQty = item.siteQty;
                            }
                        })
                        .catch(function (e) {
                            toast('âŒ è½‰ç§»å¤±æ•—ï¼š' + e.message, 'error');
                        });
                }

                // ===== ç›´æ¥ç·¨è¼¯æ•¸å­— =====
                function editNumber(id, type, isBottomSheet) {
                    // é˜²æ­¢é‡è¤‡ç·¨è¼¯
                    var editKey = id + '-' + type + '-' + (isBottomSheet ? 'bs' : 'list');
                    if (state.editingNumber === editKey) return;

                    // æŸ¥æ‰¾ç‰©æ–™
                    var item = findItemById(id);
                    if (!item) {
                        toast('æ‰¾ä¸åˆ°è©²ç‰©æ–™', 'error');
                        return;
                    }

                    var isW = type === 'w';
                    var currentQty = isW ? item.warehouseQty : item.siteQty;
                    var elementId = (isBottomSheet ? 'bs-' : '') + (isW ? 'w-' : 's-') + id;
                    var el = document.getElementById(elementId);
                    if (!el || el.tagName === 'INPUT') return;

                    // æ¨™è¨˜æ­£åœ¨ç·¨è¼¯
                    state.editingNumber = editKey;

                    // ä¿å­˜åŸå§‹å€¼
                    var oldQty = currentQty;
                    var originalClass = el.className;
                    var originalStyle = el.getAttribute('style') || '';
                    var originalAttrs = {
                        'aria-live': el.getAttribute('aria-live'),
                        'aria-atomic': el.getAttribute('aria-atomic'),
                        'aria-label': el.getAttribute('aria-label'),
                        'title': el.getAttribute('title'),
                        'ondblclick': el.getAttribute('ondblclick')
                    };

                    // å‰µå»ºè¼¸å…¥æ¡†
                    var input = document.createElement('input');
                    input.type = 'number';
                    input.min = '0';
                    input.max = '99999';
                    input.step = '0.1';
                    input.value = currentQty;
                    input.className = 'editable-number-input big-number font-extrabold text-center';
                    input.style.cssText = 'width: 100%; max-width: 300px; margin: 0 auto; display: block;';
                    // æ ¹æ“šé¡å‹è¨­ç½®é¡è‰²å’Œå­—é«”å¤§å°
                    if (isBottomSheet) {
                        input.style.fontSize = '4rem';
                        input.style.lineHeight = '1';
                    } else {
                        input.style.fontSize = '2.5rem';
                        input.style.lineHeight = '1';
                    }
                    if (isW) {
                        input.style.color = '#a78bfa';
                    } else {
                        input.style.color = '#67e8f9';
                    }
                    input.setAttribute('aria-label', (isW ? 'å…¬å¸å€‰' : 'F22å» å€') + 'åº«å­˜è¼¸å…¥');

                    // æ›¿æ›å…ƒç´ 
                    var parent = el.parentNode;
                    parent.replaceChild(input, el);
                    input.focus();
                    input.select();

                    // è™•ç†è¼¸å…¥å®Œæˆ
                    function finishEdit() {
                        if (state.editingNumber !== editKey) return; // é˜²æ­¢é‡è¤‡åŸ·è¡Œ

                        var inputValue = parseFloat(input.value);

                        // é©—è­‰è¼¸å…¥
                        if (isNaN(inputValue) || inputValue < 0) {
                            inputValue = 0;
                        }
                        if (inputValue > 99999) {
                            toast('æ•¸é‡ä¸èƒ½è¶…é 99999', 'warning');
                            inputValue = 99999;
                        }
                        // ä¿ç•™å°æ•¸é»å¾Œä¸€ä½
                        inputValue = Math.round(inputValue * 10) / 10;

                        // å¦‚æœå€¼æ”¹è®Šäº†ï¼Œéœ€è¦ç¢ºèª
                        if (inputValue !== oldQty) {
                            var delta = inputValue - oldQty;
                            if (delta < -10 || (delta < 0 && inputValue === 0)) {
                                var confirmMsg = delta < -10
                                    ? 'ç¢ºå®šè¦æ¸›å°‘ ' + Math.abs(delta) + ' ä»¶å—ï¼Ÿ\n\n' + item.name
                                    : 'ç¢ºå®šè¦å°‡æ•¸é‡èª¿æ•´ç‚º 0 å—ï¼Ÿ\n\n' + item.name;

                                if (!confirm(confirmMsg)) {
                                    // å–æ¶ˆï¼šæ¢å¾©åŸå€¼
                                    restoreElement();
                                    return;
                                }
                            }

                            // æ›´æ–°æ•¸é‡
                            if (isBottomSheet && !state.currentItem) {
                                state.currentItem = item;
                            }
                            updateQty(id, type, inputValue, oldQty, item);
                        }

                        // æ¢å¾©é¡¯ç¤º
                        restoreElement();
                    }

                    function restoreElement() {
                        state.editingNumber = null;

                        // æ¢å¾©åŸå§‹å…ƒç´ 
                        var newEl = document.createElement('p');
                        newEl.id = elementId;
                        newEl.className = originalClass;
                        var displayValue = (isW ? item.warehouseQty : item.siteQty);
                        // å¦‚æœæ˜¯å°æ•¸ï¼Œä¿ç•™ä¸€ä½å°æ•¸ï¼Œå¦å‰‡é¡¯ç¤ºæ•´æ•¸
                        newEl.textContent = displayValue % 1 === 0 ? displayValue : displayValue.toFixed(1);

                        // æ¢å¾©å±¬æ€§
                        for (var key in originalAttrs) {
                            if (originalAttrs[key]) {
                                newEl.setAttribute(key, originalAttrs[key]);
                            }
                        }

                        if (originalStyle) newEl.setAttribute('style', originalStyle);

                        parent.replaceChild(newEl, input);
                    }

                    // ç¶å®šäº‹ä»¶
                    input.addEventListener('blur', finishEdit);
                    input.addEventListener('keydown', function (e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            finishEdit();
                        } else if (e.key === 'Escape') {
                            e.preventDefault();
                            restoreElement();
                        }
                    });
                }

                // ===== ç¯©é¸ (with Fuse.js fuzzy search) =====
                var applyFiltersDebounced = debounce(function () {
                    state.filtered = [];

                    // Filter by category first
                    var categoryFiltered = [];
                    for (var i = 0; i < state.stock.length; i++) {
                        var item = state.stock[i];
                        if (state.category === 'all' || getCategory(item) === state.category) {
                            categoryFiltered.push(item);
                        }
                    }

                    // Apply fuzzy search with Fuse.js if search text exists
                    if (state.searchText && state.searchText.trim() !== '') {
                        if (typeof Fuse !== 'undefined') {
                            // Initialize or update Fuse instance
                            fuseInstance = new Fuse(categoryFiltered, {
                                keys: ['name', 'spec', 'alias'],
                                threshold: 0.3,  // Allow slight typos
                                includeScore: true,
                                ignoreLocation: true
                            });

                            var fuseResults = fuseInstance.search(state.searchText);
                            for (var j = 0; j < fuseResults.length; j++) {
                                state.filtered.push(fuseResults[j].item);
                            }
                        } else {
                            // Fallback to native search if Fuse.js not loaded
                            for (var k = 0; k < categoryFiltered.length; k++) {
                                var item = categoryFiltered[k];
                                var s = (safeStr(item.name) + ' ' + safeStr(item.spec) + ' ' + safeStr(item.alias || '')).toLowerCase();
                                if (s.indexOf(state.searchText.toLowerCase()) >= 0) {
                                    state.filtered.push(item);
                                }
                            }
                        }
                    } else {
                        // No search text, show all category-filtered items
                        state.filtered = categoryFiltered;
                    }

                    renderList();
                }, 150);

                // ===== API =====
                function loadData(useBackup) {
                    if (state.isLoading) return;

                    showLoading();

                    var url = useBackup ? API_BACKUP : API_PRIMARY;

                    var timer = null;
                    var sec = 0;
                    timer = setInterval(function () {
                        sec++;
                        if (el.loadingTimer) el.loadingTimer.textContent = 'å·²ç­‰å¾… ' + sec + ' ç§’';
                    }, 1000);

                    if (typeof fetch !== 'function') {
                        clearInterval(timer);
                        showError('ç€è¦½å™¨ä¸æ”¯æ´ç¶²è·¯è«‹æ±‚ï¼Œè«‹æ›´æ–°æˆ–æ›´æ›ç€è¦½å™¨');
                        return;
                    }

                    var ctrl = null;
                    var timeoutId = null;
                    if (typeof AbortController !== 'undefined') {
                        ctrl = new AbortController();
                        timeoutId = setTimeout(function () {
                            ctrl.abort();
                        }, TIMEOUT);
                    }

                    var fetchOptions = { cache: 'no-cache' };
                    if (ctrl && ctrl.signal) {
                        fetchOptions.signal = ctrl.signal;
                    }

                    fetch(url + '?t=' + Date.now(), fetchOptions)
                        .then(function (res) {
                            if (timeoutId !== null) clearTimeout(timeoutId);
                            clearInterval(timer);
                            if (!res.ok) throw new Error('HTTP ' + res.status);
                            return res.text();
                        })
                        .then(function (text) {
                            if (text.indexOf('<!DOCTYPE') >= 0 || text.indexOf('<html') >= 0) {
                                throw new Error('æ”¶åˆ° HTML é JSONï¼Œè«‹æª¢æŸ¥éƒ¨ç½²è¨­å®š');
                            }

                            var data = JSON.parse(text);

                            if (data.status === 'error') {
                                throw new Error(data.msg || 'å¾Œç«¯éŒ¯èª¤');
                            }

                            if (!data.stock || !Array.isArray(data.stock)) {
                                throw new Error('è³‡æ–™æ ¼å¼éŒ¯èª¤');
                            }

                            // è™•ç†æ•¸æ“š
                            state.stock = data.stock.map(function (it, i) {
                                return {
                                    id: safeStr(it.id, 'i' + i),
                                    name: safeStr(it.name, 'æœªå‘½å'),
                                    spec: safeStr(it.spec, '-'),
                                    unit: safeStr(it.unit, 'å€‹'),
                                    warehouseQty: safeNum(it.warehouseQty),
                                    siteQty: safeNum(it.siteQty),
                                    safeQty: safeNum(it.safeQty, 1),
                                    alias: safeStr(it.alias || '')
                                };
                            });

                            applyFiltersDebounced();
                            updateDashboard();
                            showContent();
                            toast('å·²è¼‰å…¥ ' + state.stock.length + ' ç­†è³‡æ–™', 'success');
                        })
                        .catch(function (err) {
                            if (timeoutId !== null) clearTimeout(timeoutId);
                            clearInterval(timer);

                            if (err.name === 'AbortError') {
                                showError('é€£ç·šé€¾æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ç‹€æ…‹');
                            } else if (!useBackup && API_BACKUP !== API_PRIMARY) {
                                toast('åˆ‡æ›å‚™æ´é€£ç·š...', 'warning');
                                setTimeout(function () { loadData(true); }, 500);
                            } else {
                                showError(err.message);
                            }
                        });
                }

                function postAPI(action, params) {
                    var body = JSON.stringify(Object.assign({ action: action }, params));

                    return fetch(API_PRIMARY, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8'  // Google Apps Script CORS hack
                        },
                        body: body,
                        cache: 'no-cache',
                        mode: 'cors'
                    })
                        .then(function (res) {
                            return res.text().then(function (text) {
                                try {
                                    return JSON.parse(text);
                                } catch (e) {
                                    console.error('JSON parse error:', text);
                                    throw new Error('ç„¡æ³•è§£æå›æ‡‰ï¼š' + text.substring(0, 100));
                                }
                            });
                        })
                        .then(function (data) {
                            if (data.status === 'error') throw new Error(data.msg);
                            return data;
                        })
                        .catch(function (err) {
                            console.error('POST API Error:', err);
                            throw err;
                        });
                }

                // ===== åŒ¯å‡º =====
                function exportCSV() {
                    if (state.filtered.length === 0) {
                        toast('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º', 'warning');
                        return;
                    }

                    var rows = [['ID', 'å“å', 'è¦æ ¼', 'å–®ä½', 'å…¬å¸å€‰', 'F22å» å€', 'å®‰å…¨å­˜é‡']];
                    state.filtered.forEach(function (it) {
                        rows.push([it.id, it.name, it.spec, it.unit, it.warehouseQty, it.siteQty, it.safeQty]);
                    });

                    var csv = rows.map(function (r) {
                        return r.map(function (c) {
                            return '"' + String(c).replace(/"/g, '""') + '"';
                        }).join(',');
                    }).join('\n');

                    var blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                    var link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = 'åº«å­˜_' + new Date().toISOString().slice(0, 10) + '.csv';
                    link.click();

                    toast('å·²åŒ¯å‡º ' + state.filtered.length + ' ç­†', 'success');
                }

                // ===== æ“ä½œæ­·å²è¨˜éŒ„ =====
                function recordOperation(action, itemName, oldQty, newQty, type) {
                    var record = {
                        time: new Date().toLocaleString('zh-TW'),
                        operator: state.currentOperator,
                        action: action,
                        itemName: itemName,
                        type: type === 'w' ? 'å…¬å¸å€‰' : 'F22å» å€',
                        oldQty: oldQty,
                        newQty: newQty,
                        delta: newQty - oldQty
                    };

                    state.operationHistory.unshift(record);

                    // åªä¿ç•™æœ€è¿‘ 50 æ¢è¨˜éŒ„
                    if (state.operationHistory.length > 50) {
                        state.operationHistory = state.operationHistory.slice(0, 50);
                    }

                    // ä¿å­˜åˆ° localStorage
                    try {
                        localStorage.setItem('operationHistory', JSON.stringify(state.operationHistory));
                    } catch (e) {
                        console.warn('ç„¡æ³•ä¿å­˜æ“ä½œæ­·å²åˆ° localStorage:', e);
                    }
                }

                function renderOperationHistory() {
                    // å¾ localStorage è¼‰å…¥æ­·å²è¨˜éŒ„
                    try {
                        var saved = localStorage.getItem('operationHistory');
                        if (saved) {
                            state.operationHistory = JSON.parse(saved);
                        }
                    } catch (e) {
                        console.warn('ç„¡æ³•è¼‰å…¥æ“ä½œæ­·å²:', e);
                    }

                    // æŸ¥æ‰¾æˆ–å‰µå»ºæ“ä½œæ­·å²å®¹å™¨
                    var container = document.getElementById('operationHistoryContainer');
                    if (!container) {
                        // åœ¨è¨­å®šé é¢ä¸­æŸ¥æ‰¾åˆé©çš„ä½ç½®æ’å…¥
                        var settingsPage = document.getElementById('page-settings');
                        if (settingsPage) {
                            var aboutSection = settingsPage.querySelector('.glass.rounded-3xl:last-of-type');
                            if (aboutSection) {
                                var historySection = document.createElement('div');
                                historySection.className = 'glass rounded-3xl p-6';
                                historySection.innerHTML =
                                    '<h3 class="text-lg font-extrabold text-white mb-5 flex items-center gap-2">' +
                                    '<span>ğŸ“‹</span>' +
                                    '<span>æ“ä½œæ­·å²</span>' +
                                    '</h3>' +
                                    '<div id="operationHistoryContainer" class="space-y-2 max-h-96 overflow-y-auto"></div>';
                                aboutSection.parentNode.insertBefore(historySection, aboutSection);
                                container = document.getElementById('operationHistoryContainer');
                            }
                        }
                    }

                    if (!container) return;

                    if (state.operationHistory.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-sm text-center py-8">æš«ç„¡æ“ä½œè¨˜éŒ„</p>';
                        return;
                    }

                    var html = '';
                    var displayCount = Math.min(state.operationHistory.length, 20); // åªé¡¯ç¤ºæœ€è¿‘ 20 æ¢
                    for (var i = 0; i < displayCount; i++) {
                        var record = state.operationHistory[i];
                        var deltaText = record.delta > 0 ? '+' + record.delta : record.delta;
                        var deltaClass = record.delta > 0 ? 'text-green-400' : (record.delta < 0 ? 'text-red-400' : 'text-gray-400');

                        html += '<div class="p-3 rounded-xl bg-white/5 border border-white/5 text-sm">' +
                            '<div class="flex justify-between items-start mb-1">' +
                            '<span class="text-white font-bold truncate flex-1">' + escapeHtml(record.itemName) + '</span>' +
                            '<span class="' + deltaClass + ' font-extrabold ml-2">' + deltaText + '</span>' +
                            '</div>' +
                            '<div class="flex justify-between items-center text-xs text-gray-400">' +
                            '<span>' + escapeHtml(record.type) + ' ' + record.oldQty + ' â†’ ' + record.newQty + '</span>' +
                            '<span>' + escapeHtml(record.time) + '</span>' +
                            '</div>' +
                            '<div class="text-xs text-gray-500 mt-1">æ“ä½œäººå“¡ï¼š' + escapeHtml(record.operator) + '</div>' +
                            '</div>';
                    }

                    container.innerHTML = html;
                }

                // ===== æœç´¢æ­·å² =====
                function saveSearchHistory(searchText) {
                    if (!searchText || !searchText.trim()) return;

                    var text = searchText.trim();
                    var index = state.searchHistory.indexOf(text);
                    if (index >= 0) {
                        state.searchHistory.splice(index, 1);
                    }
                    state.searchHistory.unshift(text);

                    // åªä¿ç•™æœ€è¿‘ 5 æ¬¡æœç´¢
                    if (state.searchHistory.length > 5) {
                        state.searchHistory = state.searchHistory.slice(0, 5);
                    }

                    // æ›´æ–° datalist
                    var datalist = document.getElementById('searchHistory');
                    if (datalist) {
                        datalist.innerHTML = state.searchHistory.map(function (s) {
                            return '<option value="' + escapeHtml(s) + '">';
                        }).join('');
                    }
                }

                // ===== äº‹ä»¶ç¶å®š =====
                function bindEvents() {
                    // ç¶²çµ¡ç‹€æ…‹ç›£è½
                    window.addEventListener('online', function () {
                        state.isOnline = true;
                        setStatus('online', 'ç·šä¸Š');
                        toast('ç¶²çµ¡å·²é€£æ¥', 'success');
                    });

                    window.addEventListener('offline', function () {
                        state.isOnline = false;
                        setStatus('error', 'é›¢ç·š');
                        toast('ç¶²çµ¡å·²æ–·é–‹ï¼Œæ“ä½œå°‡åœ¨é€£ç·šå¾ŒåŒæ­¥', 'warning');
                    });

                    // æœå°‹
                    el.searchInput.addEventListener('input', function (e) {
                        state.searchText = e.target.value;
                        if (state.searchText.trim()) {
                            saveSearchHistory(state.searchText);
                        }
                        applyFiltersDebounced();
                    });

                    // æœç´¢æ¡† Enter éµ
                    el.searchInput.addEventListener('keydown', function (e) {
                        if (e.key === 'Enter' && state.searchText.trim()) {
                            saveSearchHistory(state.searchText);
                        }
                    });

                    // åˆ†é¡
                    el.categoryChips.addEventListener('click', function (e) {
                        var btn = e.target.closest('.cat-chip');
                        if (!btn) return;

                        var chips = el.categoryChips.querySelectorAll('.cat-chip');
                        chips.forEach(function (chip) {
                            chip.classList.remove('active');
                            chip.setAttribute('aria-selected', 'false');
                            chip.setAttribute('tabindex', '-1');
                        });
                        btn.classList.add('active');
                        btn.setAttribute('aria-selected', 'true');
                        btn.setAttribute('tabindex', '0');

                        state.category = btn.getAttribute('data-cat');
                        applyFiltersDebounced();
                    });

                    // éµç›¤å°èˆªåˆ†é¡æ¨™ç±¤
                    el.categoryChips.addEventListener('keydown', function (e) {
                        var chips = Array.from(el.categoryChips.querySelectorAll('.cat-chip'));
                        var currentIndex = chips.indexOf(e.target);

                        if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                            e.preventDefault();
                            var nextIndex = e.key === 'ArrowRight'
                                ? (currentIndex + 1) % chips.length
                                : (currentIndex - 1 + chips.length) % chips.length;
                            chips[nextIndex].focus();
                            chips[nextIndex].click();
                        } else if (e.key === 'Home') {
                            e.preventDefault();
                            chips[0].focus();
                            chips[0].click();
                        } else if (e.key === 'End') {
                            e.preventDefault();
                            chips[chips.length - 1].focus();
                            chips[chips.length - 1].click();
                        }
                    });

                    // æŒ‰éˆ•
                    el.exportBtn.addEventListener('click', exportCSV);
                    el.refreshBtn.addEventListener('click', function () {
                        toast('é‡æ–°è¼‰å…¥ä¸­...', 'info');
                        loadData(false);
                    });
                    el.retryBtn.addEventListener('click', function () { loadData(false); });

                    // éµç›¤å¿«æ·éµ
                    document.addEventListener('keydown', function (e) {
                        // ESC é—œé–‰ Bottom Sheet æˆ–è½‰ç§»è¼¸å…¥ç•Œé¢
                        if (e.key === 'Escape') {
                            if (el.transferInputSheet.classList.contains('open')) {
                                closeTransferInput();
                            } else if (el.bottomSheet.classList.contains('open')) {
                                closeBottomSheet();
                            }
                        }
                        // Enter åœ¨è½‰ç§»è¼¸å…¥ç•Œé¢ç¢ºèª
                        if (e.key === 'Enter' && el.transferInputSheet.classList.contains('open')) {
                            var input = document.getElementById('transferQtyInput');
                            if (input && document.activeElement === input) {
                                e.preventDefault();
                                confirmTransfer();
                            }
                        }
                    });
                }

                // ===== å…¨åŸŸå‡½æ•¸ =====
                window.switchPage = switchPage;
                window.openBottomSheet = openBottomSheet;
                window.closeBottomSheet = closeBottomSheet;
                window.adjustQty = adjustQty;
                window.transferToSite = transferToSite;
                window.setTransferQty = setTransferQty;
                window.closeTransferInput = closeTransferInput;
                window.confirmTransfer = confirmTransfer;
                window.setOperator = setOperator;
                window.setOperatorGlobal = setOperatorGlobal;
                window.editNumber = editNumber;
                window.installPWA = installPWA;
                window.handleItemClick = handleItemClick;
                window.toggleItemSelection = toggleItemSelection;
                window.clearSelection = clearSelection;
                window.batchAdjust = batchAdjust;

                // ===== PWA Service Worker è¨»å†Š =====
                if ('serviceWorker' in navigator) {
                    // å…ˆæ¸…é™¤æ‰€æœ‰èˆŠçš„ Service Worker
                    navigator.serviceWorker.getRegistrations().then(function (registrations) {
                        for (var i = 0; i < registrations.length; i++) {
                            registrations[i].unregister();
                        }
                        // æ¸…é™¤æ‰€æœ‰ç·©å­˜
                        if ('caches' in window) {
                            caches.keys().then(function (cacheNames) {
                                cacheNames.forEach(function (cacheName) {
                                    if (cacheName.indexOf('inventory-system') >= 0) {
                                        caches.delete(cacheName);
                                    }
                                });
                            });
                        }
                    });

                    window.addEventListener('load', function () {
                        // ä½¿ç”¨æ™‚é–“æˆ³ç¢ºä¿æ¯æ¬¡éƒ½è¼‰å…¥æ–°ç‰ˆæœ¬
                        var timestamp = Date.now();
                        navigator.serviceWorker.register('./service-worker.js?v=' + timestamp)
                            .then(function (registration) {
                                console.log('Service Worker è¨»å†ŠæˆåŠŸ:', registration.scope);

                                // å¼·åˆ¶æ›´æ–°ï¼šç«‹å³æª¢æŸ¥ä¸¦æ›´æ–°
                                setInterval(function () {
                                    registration.update();
                                }, 1000);

                                // æª¢æŸ¥æ›´æ–°
                                registration.addEventListener('updatefound', function () {
                                    var newWorker = registration.installing;
                                    newWorker.addEventListener('statechange', function () {
                                        if (newWorker.state === 'installed') {
                                            if (navigator.serviceWorker.controller) {
                                                // æœ‰æ–°ç‰ˆæœ¬å¯ç”¨ï¼Œè‡ªå‹•æ›´æ–°
                                                newWorker.postMessage({ action: 'skipWaiting' });
                                                setTimeout(function () {
                                                    window.location.reload(true);
                                                }, 100);
                                            }
                                        }
                                    });
                                });
                            })
                            .catch(function (error) {
                                console.log('Service Worker è¨»å†Šå¤±æ•—:', error);
                            });
                    });
                }

                // ===== PWA å®‰è£æç¤ºï¼ˆå¯é¸åŠŸèƒ½ï¼Œä¸å¼·åˆ¶ï¼‰ =====
                var deferredPrompt;

                window.addEventListener('beforeinstallprompt', function (e) {
                    // é˜»æ­¢é»˜èªçš„å½ˆå‡ºå¼å®‰è£æç¤ºï¼ˆé¿å…æ‰“æ“¾ç”¨æˆ¶ï¼‰
                    e.preventDefault();
                    deferredPrompt = e;

                    // æ›´æ–°è¨­å®šé çš„å®‰è£é¸é …é¡¯ç¤º
                    updatePWAInstallSection();
                });

                // æ›´æ–° PWA å®‰è£å€åŸŸé¡¯ç¤º
                function updatePWAInstallSection() {
                    var section = document.getElementById('pwaInstallSection');
                    if (!section) return;

                    // å¦‚æœå·²ç¶“å®‰è£ï¼Œä¸é¡¯ç¤ºå®‰è£æŒ‰éˆ•
                    if (window.matchMedia('(display-mode: standalone)').matches) {
                        section.classList.add('hidden');
                        return;
                    }

                    // æª¢æŸ¥æ˜¯å¦ç‚ºç§»å‹•è¨­å‚™
                    var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                    var isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
                    var isAndroid = /Android/i.test(navigator.userAgent);

                    // ç§»å‹•è¨­å‚™éƒ½é¡¯ç¤ºå®‰è£é¸é …
                    if (isMobile) {
                        section.classList.remove('hidden');
                    } else if (deferredPrompt) {
                        // æ¡Œé¢ç«¯å¦‚æœæœ‰å®‰è£æç¤ºï¼Œä¹Ÿé¡¯ç¤º
                        section.classList.remove('hidden');
                    } else {
                        section.classList.add('hidden');
                    }
                }

                // æ›´æ–°æ‡‰ç”¨æ¨¡å¼é¡¯ç¤º
                function updateAppMode() {
                    var modeEl = document.getElementById('appMode');
                    if (!modeEl) return;

                    if (window.matchMedia('(display-mode: standalone)').matches) {
                        modeEl.textContent = 'å·²å®‰è£ç‰ˆ';
                        modeEl.classList.add('text-green-400');
                    } else {
                        modeEl.textContent = 'ç¶²é ç‰ˆ';
                        modeEl.classList.remove('text-green-400');
                    }
                }

                // å®‰è£åŠŸèƒ½ï¼ˆå¯é¸ï¼Œåœ¨è¨­å®šé æä¾›ï¼‰
                function installPWA() {
                    // æª¢æŸ¥æ˜¯å¦å·²ç¶“å®‰è£
                    if (window.matchMedia('(display-mode: standalone)').matches) {
                        toast('âœ… æ‡‰ç”¨å·²å®‰è£', 'success');
                        return;
                    }

                    var isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
                    var isAndroid = /Android/i.test(navigator.userAgent);
                    var isChrome = /Chrome/i.test(navigator.userAgent);

                    // iOS ç‰¹æ®Šè™•ç†
                    if (isIOS) {
                        var instructions = 'ğŸ“± iOS å®‰è£æ­¥é©Ÿï¼š\n\n' +
                            '1. é»æ“Šç€è¦½å™¨åº•éƒ¨çš„ã€Œåˆ†äº«ã€æŒ‰éˆ•ï¼ˆæ–¹æ¡†+ç®­é ­åœ–æ¨™ï¼‰\n' +
                            '2. å‘ä¸‹æ»¾å‹•ï¼Œæ‰¾åˆ°ã€ŒåŠ å…¥ä¸»ç•«é¢ã€\n' +
                            '3. é»æ“Šã€ŒåŠ å…¥ä¸»ç•«é¢ã€\n' +
                            '4. é»æ“Šå³ä¸Šè§’ã€ŒåŠ å…¥ã€\n\n' +
                            'å®Œæˆå¾Œï¼Œæ‡‰ç”¨åœ–æ¨™æœƒå‡ºç¾åœ¨ä¸»å±å¹•ä¸Šï¼';
                        toast(instructions, 'info');
                        return;
                    }

                    // Android Chrome ä½¿ç”¨æ¨™æº– PWA å®‰è£
                    if (isAndroid && isChrome && deferredPrompt) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then(function (choiceResult) {
                            if (choiceResult.outcome === 'accepted') {
                                toast('âœ… å®‰è£æˆåŠŸï¼ç¾åœ¨å¯ä»¥å¾ä¸»å±å¹•å•Ÿå‹•', 'success');
                                updatePWAInstallSection();
                                updateAppMode();
                            } else {
                                toast('å·²å–æ¶ˆå®‰è£ï¼Œæ‚¨ä»å¯æ­£å¸¸ä½¿ç”¨ç¶²é ç‰ˆ', 'info');
                            }
                            deferredPrompt = null;
                        });
                        return;
                    }

                    // Android å…¶ä»–ç€è¦½å™¨
                    if (isAndroid) {
                        toast('ğŸ“± Android å®‰è£ï¼š\n\nè«‹ä½¿ç”¨ Chrome ç€è¦½å™¨ï¼Œæˆ–é»æ“Šç€è¦½å™¨èœå–®ä¸­çš„ã€Œæ·»åŠ åˆ°ä¸»å±å¹•ã€é¸é …', 'info');
                        return;
                    }

                    // æ¡Œé¢ç«¯
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then(function (choiceResult) {
                            if (choiceResult.outcome === 'accepted') {
                                toast('âœ… å®‰è£æˆåŠŸï¼', 'success');
                                updatePWAInstallSection();
                                updateAppMode();
                            } else {
                                toast('å·²å–æ¶ˆå®‰è£', 'info');
                            }
                            deferredPrompt = null;
                        });
                    } else {
                        toast('æ‚¨çš„ç€è¦½å™¨å¯èƒ½ä¸æ”¯æŒ PWA å®‰è£ï¼Œæˆ–éœ€è¦æ‰‹å‹•æ·»åŠ ', 'info');
                    }
                }

                // ç›£è½å®‰è£å®Œæˆäº‹ä»¶
                window.addEventListener('appinstalled', function () {
                    toast('âœ… æ‡‰ç”¨å·²æˆåŠŸå®‰è£åˆ°ä¸»å±å¹•ï¼', 'success');
                    deferredPrompt = null;
                    updatePWAInstallSection();
                    updateAppMode();
                });

                // ===== ç¶²çµ¡ç‹€æ…‹ç›£è½ =====
                function updateOnlineStatus() {
                    state.isOnline = navigator.onLine;
                    var statusEl = el.statusBadge;
                    if (statusEl) {
                        if (state.isOnline) {
                            if (!statusEl.textContent.includes('é›¢ç·š')) {
                                setStatus('online', 'ç·šä¸Š');
                            }
                        } else {
                            setStatus('error', 'é›¢ç·šæ¨¡å¼');
                            toast('âš ï¸ ç›®å‰é›¢ç·šï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ç„¡æ³•ä½¿ç”¨', 'warning');
                        }
                    }
                }

                window.addEventListener('online', function () {
                    updateOnlineStatus();
                    toast('âœ… ç¶²çµ¡å·²æ¢å¾©', 'success');
                    // é‡è©¦å¤±æ•—çš„æ“ä½œ
                    retryFailedUpdates();
                });

                window.addEventListener('offline', function () {
                    updateOnlineStatus();
                });

                // é‡è©¦å¤±æ•—çš„æ“ä½œ
                function retryFailedUpdates() {
                    var keys = Object.keys(state.pendingUpdates);
                    if (keys.length === 0) return;

                    toast('æ­£åœ¨é‡è©¦åŒæ­¥ ' + keys.length + ' å€‹æ“ä½œ...', 'info');

                    keys.forEach(function (key) {
                        var update = state.pendingUpdates[key];
                        var action = update.type === 'w' ? 'warehouse_audit' : 'audit';

                        postAPI(action, {
                            id: update.id,
                            qty: update.newQty,
                            person: update.operator
                        })
                            .then(function () {
                                delete state.pendingUpdates[key];
                                if (Object.keys(state.pendingUpdates).length === 0) {
                                    toast('âœ… æ‰€æœ‰æ“ä½œå·²åŒæ­¥', 'success');
                                }
                            })
                            .catch(function (e) {
                                console.error('é‡è©¦å¤±æ•—:', e);
                            });
                    });
                }

                // ===== åˆå§‹åŒ– =====
                function init() {
                    initDOM();
                    bindEvents();
                    handleURLParams(); // è™•ç† URL åƒæ•¸ï¼ˆPWA shortcutsï¼‰
                    updateOnlineStatus(); // åˆå§‹åŒ–ç¶²çµ¡ç‹€æ…‹

                    // Initialize AutoAnimate for smooth list transitions
                    if (window.autoAnimate) {
                        var inventoryList = document.getElementById('inventoryList');
                        if (inventoryList) {
                            window.autoAnimate(inventoryList, { duration: 250 });
                        }
                    }

                    loadData(false);
                }

                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', init);
                } else {
                    init();
                }

            })();
    </script>

</body>

</html> // æ›´æ–°æ‡‰ç”¨æ¨¡å¼é¡¯ç¤º
function updateAppMode() {
var modeEl = document.getElementById('appMode');
if (!modeEl) return;

if (window.matchMedia('(display-mode: standalone)').matches) {
modeEl.textContent = 'å·²å®‰è£ç‰ˆ';
modeEl.classList.add('text-green-400');
} else {
modeEl.textContent = 'ç¶²é ç‰ˆ';
modeEl.classList.remove('text-green-400');
}
}

// å®‰è£åŠŸèƒ½ï¼ˆå¯é¸ï¼Œåœ¨è¨­å®šé æä¾›ï¼‰
function installPWA() {
// æª¢æŸ¥æ˜¯å¦å·²ç¶“å®‰è£
if (window.matchMedia('(display-mode: standalone)').matches) {
toast('âœ… æ‡‰ç”¨å·²å®‰è£', 'success');
return;
}

var isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
var isAndroid = /Android/i.test(navigator.userAgent);
var isChrome = /Chrome/i.test(navigator.userAgent);

// iOS ç‰¹æ®Šè™•ç†
if (isIOS) {
var instructions = 'ğŸ“± iOS å®‰è£æ­¥é©Ÿï¼š\n\n' +
'1. é»æ“Šç€è¦½å™¨åº•éƒ¨çš„ã€Œåˆ†äº«ã€æŒ‰éˆ•ï¼ˆæ–¹æ¡†+ç®­é ­åœ–æ¨™ï¼‰\n' +
'2. å‘ä¸‹æ»¾å‹•ï¼Œæ‰¾åˆ°ã€ŒåŠ å…¥ä¸»ç•«é¢ã€\n' +
'3. é»æ“Šã€ŒåŠ å…¥ä¸»ç•«é¢ã€\n' +
'4. é»æ“Šå³ä¸Šè§’ã€ŒåŠ å…¥ã€\n\n' +
'å®Œæˆå¾Œï¼Œæ‡‰ç”¨åœ–æ¨™æœƒå‡ºç¾åœ¨ä¸»å±å¹•ä¸Šï¼';
toast(instructions, 'info');
return;
}

// Android Chrome ä½¿ç”¨æ¨™æº– PWA å®‰è£
if (isAndroid && isChrome && deferredPrompt) {
deferredPrompt.prompt();
deferredPrompt.userChoice.then(function (choiceResult) {
if (choiceResult.outcome === 'accepted') {
toast('âœ… å®‰è£æˆåŠŸï¼ç¾åœ¨å¯ä»¥å¾ä¸»å±å¹•å•Ÿå‹•', 'success');
updatePWAInstallSection();
updateAppMode();
} else {
toast('å·²å–æ¶ˆå®‰è£ï¼Œæ‚¨ä»å¯æ­£å¸¸ä½¿ç”¨ç¶²é ç‰ˆ', 'info');
}
deferredPrompt = null;
});
return;
}

// Android å…¶ä»–ç€è¦½å™¨
if (isAndroid) {
toast('ğŸ“± Android å®‰è£ï¼š\n\nè«‹ä½¿ç”¨ Chrome ç€è¦½å™¨ï¼Œæˆ–é»æ“Šç€è¦½å™¨èœå–®ä¸­çš„ã€Œæ·»åŠ åˆ°ä¸»å±å¹•ã€é¸é …', 'info');
return;
}

// æ¡Œé¢ç«¯
if (deferredPrompt) {
deferredPrompt.prompt();
deferredPrompt.userChoice.then(function (choiceResult) {
if (choiceResult.outcome === 'accepted') {
toast('âœ… å®‰è£æˆåŠŸï¼', 'success');
updatePWAInstallSection();
updateAppMode();
} else {
toast('å·²å–æ¶ˆå®‰è£', 'info');
}
deferredPrompt = null;
});
} else {
toast('æ‚¨çš„ç€è¦½å™¨å¯èƒ½ä¸æ”¯æŒ PWA å®‰è£ï¼Œæˆ–éœ€è¦æ‰‹å‹•æ·»åŠ ', 'info');
}
}

// ç›£è½å®‰è£å®Œæˆäº‹ä»¶
window.addEventListener('appinstalled', function () {
toast('âœ… æ‡‰ç”¨å·²æˆåŠŸå®‰è£åˆ°ä¸»å±å¹•ï¼', 'success');
deferredPrompt = null;
updatePWAInstallSection();
updateAppMode();
});

// ===== ç¶²çµ¡ç‹€æ…‹ç›£è½ =====
function updateOnlineStatus() {
state.isOnline = navigator.onLine;
var statusEl = el.statusBadge;
if (statusEl) {
if (state.isOnline) {
if (!statusEl.textContent.includes('é›¢ç·š')) {
setStatus('online', 'ç·šä¸Š');
}
} else {
setStatus('error', 'é›¢ç·šæ¨¡å¼');
toast('âš ï¸ ç›®å‰é›¢ç·šï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ç„¡æ³•ä½¿ç”¨', 'warning');
}
}
}

window.addEventListener('online', function () {
updateOnlineStatus();
toast('âœ… ç¶²çµ¡å·²æ¢å¾©', 'success');
// é‡è©¦å¤±æ•—çš„æ“ä½œ
retryFailedUpdates();
});

window.addEventListener('offline', function () {
updateOnlineStatus();
});

// é‡è©¦å¤±æ•—çš„æ“ä½œ
function retryFailedUpdates() {
var keys = Object.keys(state.pendingUpdates);
if (keys.length === 0) return;

toast('æ­£åœ¨é‡è©¦åŒæ­¥ ' + keys.length + ' å€‹æ“ä½œ...', 'info');

keys.forEach(function (key) {
var update = state.pendingUpdates[key];
var action = update.type === 'w' ? 'warehouse_audit' : 'audit';

postAPI(action, {
id: update.id,
qty: update.newQty,
person: update.operator
})
.then(function () {
delete state.pendingUpdates[key];
if (Object.keys(state.pendingUpdates).length === 0) {
toast('âœ… æ‰€æœ‰æ“ä½œå·²åŒæ­¥', 'success');
}
})
.catch(function (e) {
console.error('é‡è©¦å¤±æ•—:', e);
});
});
}

// ===== åˆå§‹åŒ– =====
function init() {
initDOM();
bindEvents();
handleURLParams(); // è™•ç† URL åƒæ•¸ï¼ˆPWA shortcutsï¼‰
updateOnlineStatus(); // åˆå§‹åŒ–ç¶²çµ¡ç‹€æ…‹

// Initialize AutoAnimate for smooth list transitions
if (window.autoAnimate) {
var inventoryList = document.getElementById('inventoryList');
if (inventoryList) {
window.autoAnimate(inventoryList, { duration: 250 });
}
}

loadData(false);
}

if (document.readyState === 'loading') {
document.addEventListener('DOMContentLoaded', init);
} else {
init();
}

})();
</script>

</body>

</html>
