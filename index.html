<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å·¥ç¨‹ç‰©æ–™æˆ°æƒ…å®¤ v16.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { 
            darkMode: 'class', 
            theme: { extend: { colors: { darkBg: '#0a0e1a', darkCard: '#131827' } } } 
        }
    </script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background: linear-gradient(135deg, #0a0e1a 0%, #1a1f35 100%); 
            color: #f1f5f9; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            min-height: 100vh;
        }
        .glass { 
            background: rgba(30, 41, 59, 0.7); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255,255,255,0.08);
        }
        .stock-bar { height: 4px; border-radius: 2px; background: #1e293b; margin-top: 6px; overflow: hidden; }
        .stock-bar-fill { height: 100%; border-radius: 2px; transition: width 0.5s ease; }
        .stock-green { background: linear-gradient(90deg, #22c55e, #4ade80); }
        .stock-yellow { background: linear-gradient(90deg, #eab308, #facc15); }
        .stock-red { background: linear-gradient(90deg, #ef4444, #f87171); }
        .category-bar { height: 6px; border-radius: 3px; display: flex; overflow: hidden; background: #1e293b; }
        .cat-wire { background: #8b5cf6; }
        .cat-terminal { background: #06b6d4; }
        .cat-hardware { background: #f59e0b; }
        .loader { width: 40px; height: 40px; border: 3px solid #1e293b; border-top-color: #8b5cf6; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .cat-btn { transition: all 0.2s ease; }
        .cat-btn.active { background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: white; }
        .search-input:focus { outline: none; border-color: #8b5cf6; box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2); }
        .qty-btn { min-width: 36px; min-height: 36px; display: flex; align-items: center; justify-content: center; font-weight: 700; border-radius: 8px; transition: all 0.15s ease; }
        .qty-btn:active { transform: scale(0.9); }
        .toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 8px; width: 90%; max-width: 360px; }
        .toast { background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); padding: 12px 16px; border-radius: 12px; animation: toastIn 0.3s ease; display: flex; align-items: center; gap: 10px; }
        @keyframes toastIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .debug-box { background: #000; border: 1px solid #333; border-radius: 8px; padding: 10px; font-family: monospace; font-size: 11px; max-height: 120px; overflow-y: auto; margin-top: 10px; }
        .debug-box div { padding: 2px 0; border-bottom: 1px solid #222; }
        .d-ok { color: #4ade80; }
        .d-err { color: #f87171; }
        .d-info { color: #60a5fa; }
    </style>
</head>
<body class="p-4 pb-20">

    <div id="toastBox" class="toast-container"></div>

    <div class="max-w-lg mx-auto space-y-4">
        
        <header class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-500 to-purple-600">ç‰©æ–™æˆ°æƒ…å®¤</h1>
                <p class="text-xs text-slate-500 mt-1">v16.2 Enterprise</p>
            </div>
            <span id="statusBadge" class="text-xs px-3 py-1 rounded-full bg-slate-800 text-slate-400">é€£ç·šä¸­...</span>
        </header>

        <section class="grid grid-cols-3 gap-3">
            <div class="glass p-3 rounded-xl text-center">
                <p class="text-slate-400 text-[10px]">ç¸½å“é …</p>
                <p id="totalItems" class="text-2xl font-bold text-white mt-1">-</p>
            </div>
            <div class="glass p-3 rounded-xl text-center">
                <p class="text-slate-400 text-[10px]">ä½åº«å­˜</p>
                <p id="lowStock" class="text-2xl font-bold text-yellow-400 mt-1">-</p>
            </div>
            <div class="glass p-3 rounded-xl text-center">
                <p class="text-slate-400 text-[10px]">é ä¼°åƒ¹å€¼</p>
                <p id="totalValue" class="text-2xl font-bold text-green-400 mt-1">-</p>
            </div>
        </section>

        <section class="flex gap-2">
            <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹å“åã€è¦æ ¼..." class="search-input flex-1 bg-slate-800/50 border border-slate-700 rounded-xl px-4 py-3 text-sm placeholder-slate-500">
            <button id="exportBtn" class="glass px-4 rounded-xl flex items-center gap-1 text-sm">ğŸ“¥ åŒ¯å‡º</button>
        </section>

        <section>
            <div id="categoryBtns" class="flex gap-2 overflow-x-auto pb-2">
                <button class="cat-btn active px-4 py-2 rounded-lg text-sm bg-slate-800" data-cat="all">å…¨éƒ¨</button>
                <button class="cat-btn px-4 py-2 rounded-lg text-sm bg-slate-800" data-cat="wire">ğŸ”Œ é›»ç·š</button>
                <button class="cat-btn px-4 py-2 rounded-lg text-sm bg-slate-800" data-cat="terminal">ğŸ”— ç«¯å­</button>
                <button class="cat-btn px-4 py-2 rounded-lg text-sm bg-slate-800" data-cat="hardware">ğŸ”§ äº”é‡‘</button>
            </div>
            <div id="categoryBar" class="category-bar mt-2"></div>
            <div id="categoryLegend" class="flex justify-between text-[10px] text-slate-500 mt-1"></div>
        </section>

        <section id="loadingState" class="flex flex-col items-center py-12">
            <div class="loader"></div>
            <p class="text-slate-400 mt-4 text-sm">è¼‰å…¥è³‡æ–™ä¸­...</p>
            <p id="loadingTimer" class="text-slate-600 text-xs mt-1"></p>
            <div id="debugBox" class="debug-box w-full hidden"></div>
        </section>

        <section id="errorState" class="hidden">
            <div class="glass border-red-500/30 rounded-xl p-6 text-center">
                <div class="text-4xl mb-3">âš ï¸</div>
                <h3 class="text-lg font-bold text-red-400 mb-2">è¼‰å…¥å¤±æ•—</h3>
                <p id="errorMsg" class="text-sm text-slate-400 mb-4"></p>
                <button id="retryBtn" class="bg-red-600 text-white px-6 py-3 rounded-xl font-bold w-full">ğŸ”„ é‡æ–°é€£ç·š</button>
                <details class="mt-4 text-left">
                    <summary class="text-xs text-slate-500 cursor-pointer">æŠ€è¡“ç´°ç¯€</summary>
                    <pre id="errorDetail" class="mt-2 bg-black/30 p-3 rounded text-xs text-red-300 overflow-auto max-h-40"></pre>
                </details>
            </div>
        </section>

        <section id="inventoryList" class="space-y-2 hidden"></section>

        <section id="emptyState" class="hidden text-center py-12">
            <div class="text-4xl mb-3">ğŸ“­</div>
            <p class="text-slate-400">æ‰¾ä¸åˆ°ç¬¦åˆçš„å“é …</p>
        </section>

    </div>

    <script>
    (function() {
        'use strict';

        // ===== è¨­å®š =====
        var API_PRIMARY = 'https://script.google.com/macros/s/AKfycbyfO8--uPWfWD4Rn4-X0XdhrLNKcz9D8S_5CsHgF8zX6-470jiJ7J2FEXYfygXmuP2S1Q/exec';
        var API_BACKUP = 'https://script.google.com/macros/s/AKfycbyfO8--uPWfWD4Rn4-X0XdhrLNKcz9D8S_5CsHgF8zX6-470jiJ7J2FEXYfygXmuP2S1Q/exec';
        var TIMEOUT = 20000;
        var DEBUG = true;

        // ===== ç‹€æ…‹ =====
        var stock = [];
        var filtered = [];
        var category = 'all';
        var searchText = '';
        var logs = [];

        // ===== DOM =====
        var el = {};

        function $(id) { return document.getElementById(id); }

        function initDOM() {
            el.statusBadge = $('statusBadge');
            el.totalItems = $('totalItems');
            el.lowStock = $('lowStock');
            el.totalValue = $('totalValue');
            el.searchInput = $('searchInput');
            el.exportBtn = $('exportBtn');
            el.categoryBtns = $('categoryBtns');
            el.categoryBar = $('categoryBar');
            el.categoryLegend = $('categoryLegend');
            el.loadingState = $('loadingState');
            el.loadingTimer = $('loadingTimer');
            el.debugBox = $('debugBox');
            el.errorState = $('errorState');
            el.errorMsg = $('errorMsg');
            el.errorDetail = $('errorDetail');
            el.retryBtn = $('retryBtn');
            el.inventoryList = $('inventoryList');
            el.emptyState = $('emptyState');
            el.toastBox = $('toastBox');
        }

        // ===== å·¥å…·å‡½æ•¸ =====
        function log(msg, type) {
            type = type || 'info';
            var t = new Date().toLocaleTimeString();
            logs.push({ t: t, msg: msg, type: type });
            console.log('[' + t + '] ' + msg);
            if (DEBUG && el.debugBox) {
                el.debugBox.classList.remove('hidden');
                el.debugBox.innerHTML = logs.map(function(l) {
                    var cls = l.type === 'ok' ? 'd-ok' : (l.type === 'err' ? 'd-err' : 'd-info');
                    return '<div class="' + cls + '">[' + l.t + '] ' + l.msg + '</div>';
                }).join('');
                el.debugBox.scrollTop = el.debugBox.scrollHeight;
            }
        }

        function safeNum(v, d) {
            var n = Number(v);
            return isNaN(n) ? (d || 0) : n;
        }

        function safeStr(v, d) {
            return (v === undefined || v === null || v === '') ? (d || '') : String(v);
        }

        function getCategory(item) {
            var s = (safeStr(item.name) + safeStr(item.spec)).toLowerCase();
            if (s.indexOf('ç·š') >= 0 || s.indexOf('cable') >= 0) return 'wire';
            if (s.indexOf('ç«¯å­') >= 0 || s.indexOf('terminal') >= 0) return 'terminal';
            return 'hardware';
        }

        // ===== UI =====
        function setStatus(type, text) {
            var colors = {
                loading: 'bg-slate-800 text-slate-400',
                online: 'bg-green-900/50 text-green-400',
                error: 'bg-red-900/50 text-red-400'
            };
            el.statusBadge.className = 'text-xs px-3 py-1 rounded-full ' + (colors[type] || colors.loading);
            el.statusBadge.textContent = text;
        }

        function showLoading() {
            el.loadingState.classList.remove('hidden');
            el.errorState.classList.add('hidden');
            el.inventoryList.classList.add('hidden');
            el.emptyState.classList.add('hidden');
            setStatus('loading', 'é€£ç·šä¸­...');
        }

        function showError(msg, detail) {
            el.loadingState.classList.add('hidden');
            el.errorState.classList.remove('hidden');
            el.inventoryList.classList.add('hidden');
            el.errorMsg.textContent = msg;
            el.errorDetail.textContent = detail || '';
            setStatus('error', 'é€£ç·šå¤±æ•—');
        }

        function showContent() {
            el.loadingState.classList.add('hidden');
            el.errorState.classList.add('hidden');
            el.inventoryList.classList.remove('hidden');
            setStatus('online', 'ç·šä¸Š');
        }

        function toast(msg, type) {
            type = type || 'info';
            var icons = { success: 'âœ…', error: 'âŒ', info: 'â„¹ï¸', warning: 'âš ï¸' };
            var div = document.createElement('div');
            div.className = 'toast';
            div.innerHTML = '<span>' + (icons[type] || icons.info) + '</span><span>' + msg + '</span>';
            el.toastBox.appendChild(div);
            setTimeout(function() { div.remove(); }, 3000);
        }

        function updateDashboard() {
            el.totalItems.textContent = stock.length;
            
            var lowCount = 0;
            var totalVal = 0;
            
            for (var i = 0; i < stock.length; i++) {
                var item = stock[i];
                var total = safeNum(item.warehouseQty) + safeNum(item.siteQty);
                var safe = safeNum(item.safeQty, 1);
                if (total < safe) lowCount++;
                totalVal += total * 10;
            }
            
            el.lowStock.textContent = lowCount;
            el.totalValue.textContent = '$' + Math.round(totalVal / 1000) + 'K';
            
            updateCategoryBar();
        }

        function updateCategoryBar() {
            var counts = { wire: 0, terminal: 0, hardware: 0 };
            var total = 0;
            
            for (var i = 0; i < stock.length; i++) {
                var qty = safeNum(stock[i].warehouseQty) + safeNum(stock[i].siteQty);
                counts[getCategory(stock[i])] += qty;
                total += qty;
            }
            
            if (total === 0) total = 1;
            
            var wp = (counts.wire / total * 100).toFixed(1);
            var tp = (counts.terminal / total * 100).toFixed(1);
            var hp = (counts.hardware / total * 100).toFixed(1);
            
            el.categoryBar.innerHTML = '<div class="cat-wire" style="width:' + wp + '%"></div><div class="cat-terminal" style="width:' + tp + '%"></div><div class="cat-hardware" style="width:' + hp + '%"></div>';
            el.categoryLegend.innerHTML = '<span>ğŸ”Œ ' + wp + '%</span><span>ğŸ”— ' + tp + '%</span><span>ğŸ”§ ' + hp + '%</span>';
        }

        // ===== æ¸²æŸ“åˆ—è¡¨ =====
        function renderList() {
            if (filtered.length === 0) {
                el.inventoryList.classList.add('hidden');
                el.emptyState.classList.remove('hidden');
                return;
            }
            
            el.emptyState.classList.add('hidden');
            el.inventoryList.classList.remove('hidden');
            
            var html = '';
            for (var i = 0; i < filtered.length; i++) {
                html += renderItem(filtered[i], i);
            }
            el.inventoryList.innerHTML = html;
        }

        function renderItem(item, idx) {
            var id = safeStr(item.id, idx);
            var name = safeStr(item.name, 'æœªå‘½å');
            var spec = safeStr(item.spec, '-');
            var unit = safeStr(item.unit, 'å€‹');
            var wQty = safeNum(item.warehouseQty);
            var sQty = safeNum(item.siteQty);
            var safeQty = safeNum(item.safeQty, 1);
            var total = wQty + sQty;
            
            var pct = Math.min((total / Math.max(safeQty * 2, 1)) * 100, 100);
            var colorClass = 'stock-green';
            if (total === 0) colorClass = 'stock-red';
            else if (total < safeQty) colorClass = 'stock-yellow';
            
            var cat = getCategory(item);
            var icon = cat === 'wire' ? 'ğŸ”Œ' : (cat === 'terminal' ? 'ğŸ”—' : 'ğŸ”§');
            
            return '<div class="glass rounded-xl p-4" data-id="' + id + '">' +
                '<div class="flex justify-between items-start">' +
                    '<div class="flex-1 min-w-0">' +
                        '<div class="flex items-center gap-2">' +
                            '<span class="text-lg">' + icon + '</span>' +
                            '<h3 class="font-bold text-white truncate">' + name + '</h3>' +
                        '</div>' +
                        '<p class="text-xs text-slate-400 mt-1">' + spec + ' Â· ' + unit + '</p>' +
                        '<div class="stock-bar"><div class="stock-bar-fill ' + colorClass + '" style="width:' + pct + '%"></div></div>' +
                    '</div>' +
                    '<div class="text-right ml-4">' +
                        '<div class="flex items-center gap-2">' +
                            '<button class="qty-btn bg-red-600/20 text-red-400" onclick="App.adj(\'' + id + '\',\'w\',-1)">âˆ’</button>' +
                            '<div class="text-center min-w-[50px]">' +
                                '<p id="w-' + id + '" class="text-xl font-bold text-purple-400">' + wQty + '</p>' +
                                '<p class="text-[10px] text-slate-500">å…¬å¸</p>' +
                            '</div>' +
                            '<button class="qty-btn bg-green-600/20 text-green-400" onclick="App.adj(\'' + id + '\',\'w\',1)">+</button>' +
                        '</div>' +
                        '<div class="flex items-center gap-2 mt-2">' +
                            '<button class="qty-btn bg-red-600/20 text-red-400" onclick="App.adj(\'' + id + '\',\'s\',-1)">âˆ’</button>' +
                            '<div class="text-center min-w-[50px]">' +
                                '<p id="s-' + id + '" class="text-xl font-bold text-cyan-400">' + sQty + '</p>' +
                                '<p class="text-[10px] text-slate-500">ç¾å ´</p>' +
                            '</div>' +
                            '<button class="qty-btn bg-green-600/20 text-green-400" onclick="App.adj(\'' + id + '\',\'s\',1)">+</button>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }

        // ===== ç¯©é¸ =====
        function applyFilters() {
            filtered = [];
            for (var i = 0; i < stock.length; i++) {
                var item = stock[i];
                
                if (category !== 'all' && getCategory(item) !== category) continue;
                
                if (searchText) {
                    var s = (safeStr(item.name) + ' ' + safeStr(item.spec) + ' ' + safeStr(item.alias)).toLowerCase();
                    if (s.indexOf(searchText.toLowerCase()) < 0) continue;
                }
                
                filtered.push(item);
            }
            renderList();
        }

        // ===== API =====
        function loadData(useBackup) {
            showLoading();
            logs = [];
            
            var url = useBackup ? API_BACKUP : API_PRIMARY;
            log('é€£ç·š: ' + (useBackup ? 'å‚™æ´' : 'ä¸»è¦') + ' API');
            
            var timer = null;
            var sec = 0;
            timer = setInterval(function() {
                sec++;
                if (el.loadingTimer) el.loadingTimer.textContent = 'å·²ç­‰å¾… ' + sec + ' ç§’...';
            }, 1000);
            
            var ctrl = new AbortController();
            var timeoutId = setTimeout(function() {
                log('è¶…æ™‚ ' + (TIMEOUT/1000) + ' ç§’', 'err');
                ctrl.abort();
            }, TIMEOUT);
            
            fetch(url, { signal: ctrl.signal })
                .then(function(res) {
                    clearTimeout(timeoutId);
                    clearInterval(timer);
                    log('HTTP ' + res.status, res.ok ? 'ok' : 'err');
                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    return res.text();
                })
                .then(function(text) {
                    log('æ”¶åˆ° ' + text.length + ' å­—å…ƒ', 'ok');
                    
                    if (text.indexOf('<!DOCTYPE') >= 0 || text.indexOf('<html') >= 0) {
                        throw new Error('æ”¶åˆ° HTML é JSONï¼Œæª¢æŸ¥éƒ¨ç½²è¨­å®š');
                    }
                    
                    var data;
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                        throw new Error('JSON è§£æå¤±æ•—');
                    }
                    
                    if (data.status === 'error') {
                        throw new Error(data.msg || 'å¾Œç«¯éŒ¯èª¤');
                    }
                    
                    if (!data.stock || !Array.isArray(data.stock)) {
                        throw new Error('ç¼ºå°‘ stock è³‡æ–™');
                    }
                    
                    log('å–å¾— ' + data.stock.length + ' ç­†', 'ok');
                    
                    stock = [];
                    for (var i = 0; i < data.stock.length; i++) {
                        var it = data.stock[i];
                        stock.push({
                            id: safeStr(it.id, 'i' + i),
                            name: safeStr(it.name, 'æœªå‘½å'),
                            spec: safeStr(it.spec, '-'),
                            unit: safeStr(it.unit, 'å€‹'),
                            warehouseQty: safeNum(it.warehouseQty),
                            siteQty: safeNum(it.siteQty),
                            safeQty: safeNum(it.safeQty, 1),
                            alias: safeStr(it.alias)
                        });
                    }
                    
                    applyFilters();
                    updateDashboard();
                    showContent();
                    toast('å·²è¼‰å…¥ ' + stock.length + ' ç­†', 'success');
                })
                .catch(function(err) {
                    clearTimeout(timeoutId);
                    clearInterval(timer);
                    log('éŒ¯èª¤: ' + err.message, 'err');
                    
                    if (!useBackup) {
                        log('å˜—è©¦å‚™æ´...', 'info');
                        toast('åˆ‡æ›å‚™æ´é€£ç·š...', 'warning');
                        setTimeout(function() { loadData(true); }, 500);
                        return;
                    }
                    
                    showError('ç„¡æ³•é€£ç·š', err.message + '\n\n' + logs.map(function(l) { return '[' + l.t + '] ' + l.msg; }).join('\n'));
                });
        }

        function postAPI(action, params) {
            var body = JSON.stringify(Object.assign({ action: action }, params));
            
            return fetch(API_PRIMARY, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: body
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.status === 'error') throw new Error(data.msg);
                return data;
            });
        }

        // ===== æ“ä½œ =====
        var pending = {};
        var debounceTimers = {};

        function adjust(id, type, delta) {
            var item = null;
            for (var i = 0; i < stock.length; i++) {
                if (stock[i].id == id) { item = stock[i]; break; }
            }
            if (!item) return;
            
            var key = id + '-' + type;
            var isW = type === 'w';
            
            if (isW) {
                item.warehouseQty = Math.max(0, item.warehouseQty + delta);
                var wEl = document.getElementById('w-' + id);
                if (wEl) wEl.textContent = item.warehouseQty;
            } else {
                item.siteQty = Math.max(0, item.siteQty + delta);
                var sEl = document.getElementById('s-' + id);
                if (sEl) sEl.textContent = item.siteQty;
            }
            
            if (!pending[key]) pending[key] = 0;
            pending[key] += delta;
            
            if (debounceTimers[key]) clearTimeout(debounceTimers[key]);
            debounceTimers[key] = setTimeout(function() {
                var action = isW ? 'warehouse_audit' : 'audit';
                var qty = isW ? item.warehouseQty : item.siteQty;
                
                postAPI(action, { id: id, qty: qty, person: 'ç³»çµ±' })
                    .then(function() { toast('å·²æ›´æ–°', 'success'); })
                    .catch(function(e) { toast('æ›´æ–°å¤±æ•—: ' + e.message, 'error'); });
                
                delete pending[key];
            }, 600);
            
            toast(item.name + ' ' + (delta > 0 ? '+' : '') + delta, 'info');
        }

        // ===== åŒ¯å‡º =====
        function exportCSV() {
            if (filtered.length === 0) {
                toast('æ²’æœ‰è³‡æ–™', 'warning');
                return;
            }
            
            var rows = [['ID', 'å“å', 'è¦æ ¼', 'å–®ä½', 'å…¬å¸å€‰', 'ç¾å ´', 'å®‰å…¨å­˜é‡']];
            for (var i = 0; i < filtered.length; i++) {
                var it = filtered[i];
                rows.push([it.id, it.name, it.spec, it.unit, it.warehouseQty, it.siteQty, it.safeQty]);
            }
            
            var csv = rows.map(function(r) {
                return r.map(function(c) { return '"' + c + '"'; }).join(',');
            }).join('\n');
            
            var blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'åº«å­˜_' + new Date().toISOString().slice(0, 10) + '.csv';
            link.click();
            
            toast('å·²åŒ¯å‡º ' + filtered.length + ' ç­†', 'success');
        }

        // ===== äº‹ä»¶ =====
        function bindEvents() {
            el.searchInput.addEventListener('input', function(e) {
                searchText = e.target.value;
                applyFilters();
            });
            
            el.categoryBtns.addEventListener('click', function(e) {
                var btn = e.target.closest('.cat-btn');
                if (!btn) return;
                
                var btns = el.categoryBtns.querySelectorAll('.cat-btn');
                for (var i = 0; i < btns.length; i++) btns[i].classList.remove('active');
                btn.classList.add('active');
                
                category = btn.getAttribute('data-cat');
                applyFilters();
            });
            
            el.exportBtn.addEventListener('click', exportCSV);
            el.retryBtn.addEventListener('click', function() { loadData(false); });
        }

        // ===== å…¨åŸŸ =====
        window.App = {
            adj: adjust
        };

        // ===== å•Ÿå‹• =====
        function init() {
            initDOM();
            bindEvents();
            loadData(false);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

    })();
    </script>

</body>
</html>

